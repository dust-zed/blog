+++
date = '2025-10-10T15:43:59+08:00'
draft = false
title = '简单版ripgrep实现总结'
categories = ['rust']

+++

#### 概述

依据对`ripgrep`的学习，实现简单的个人版本的`tbt_ripgrep`，简单的有以下功能

- [x] 基本搜索
- [x] 添加选项（忽略大小写，行号）
- [x] 彩色输出
- [x] 支持递归搜索目录
- [x] 支持正则表达式
- [x] 显示上下文
- [ ] 性能优化（加多线程，优化大文件处理，做性能对比）

---------

#### 功能实现

命令行参数解析使用的`clap`库，彩色输出也是用的`colored`库，正则匹配也是用的`regex`库,基于上述三个库提供的功能，功能实现的主要难点主要在**上下文显示**与**递归搜索目录**。其中递归搜索目录也是基于`walkdir`库实现的，但是主要是想学习`ripgrep`的目录发现思路。

------

#### 程序对比

1. `ripgrep`的职责分离做的很好，以`Searcher`为例，如果以我自己的想法的话，是会把`Path`放进`Searcher`中的，但是这样会这样，`search`方法就需要处理文件系统问题，包括但不限于以下内容，但那些都不是搜索的核心逻辑：
   * 需要处理文件系统错误
   * 需要处理符号链接
   * 需要处理文件类型判断
2. 基于以上的差异，本质上是我没有做好**职责分离**，我是基于“是什么”去实现功能的，但是`ripgrep`是基于“做什么”去实现代码的，做好**职责分离**,感觉也算是**面向抽象编程**的殊途同归了吧。
3. **显示上下文**虽然功能是实现了，但是设计的不是很优雅，单个文件的搜索结果都会存储下来，然后统一打印出来，单个匹配文件过多的时候，效率低下的缺点就会放大了，目前对`ripgrep`的实现还不是很清楚，但是很好奇是如何实现的。`ripgrep`是如何做到流式处理 + 上下文功能处理的呢？
4. `ripgrep`的`walk`实现也是很值得学习的，我原本的实现也就是对`walkdir`返回的迭代器进行遍历就行，但是`ripgrep`对文件遍历进行了功能处理，`WalkBuilder`,`WalkEventIter`和`Walk`都是，我觉得这些都是很值得学习的

---

优先考虑**做什么**而不是**是什么**去实现功能，**面向行为编程**优于**面向对象编程**，做好职责分离。

<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Android-Develop on zed的博客</title><link>https://www.dust-zed.site/categories/android-develop/</link><description>Recent content in Android-Develop on zed的博客</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sat, 25 Oct 2025 19:52:44 +0800</lastBuildDate><atom:link href="https://www.dust-zed.site/categories/android-develop/index.xml" rel="self" type="application/rss+xml"/><item><title>Compose入门</title><link>https://www.dust-zed.site/android-develop/compose%E5%85%A5%E9%97%A8/</link><pubDate>Sat, 25 Oct 2025 19:52:44 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/compose%E5%85%A5%E9%97%A8/</guid><description>&lt;h4 id="大纲">大纲
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>声明式UI&lt;/strong>：只需要描述在特定状态下UI应该是什么样子，Compose框架会负责更新。&lt;/li>
&lt;li>&lt;strong>组合与复用&lt;/strong>：将UI拆分成小而专一的Composable函数，然后像搭积木一样组合它们。&lt;/li>
&lt;li>&lt;strong>单向数据流&lt;/strong>：状态从&lt;code>ViewModel&lt;/code>向下流动到Composable，事件从Composable向上传递给&lt;code>ViewModel&lt;/code>。&lt;/li>
&lt;li>&lt;strong>副作用处理&lt;/strong>：使用&lt;code>LaunchedEffect&lt;/code>等API来安全地处理需要在Composable生命周期内执行的&lt;strong>非UI&lt;/strong>操作。&lt;/li>
&lt;/ol>
&lt;h4 id="核心概念">核心概念
&lt;/h4>&lt;h5 id="组合与重组">组合与重组
&lt;/h5>&lt;ul>
&lt;li>&lt;strong>组合(Composition)&lt;/strong>：这是Compose第一次构建UI的过程。当你调用一个Composable函数时，Compose框架会执行它，把它描述的UI元素（如&lt;code>Text&lt;/code>,&lt;code>Button&lt;/code>,&lt;code>Box&lt;/code>等）添加到UI树中。这个过程只会发生一次。&lt;/li>
&lt;li>&lt;strong>重组(Recomposition)&lt;/strong>：这是Compose更新UI的过程。当一个Composable函数所依赖的数据发生变化时，Compose不会重新构建整个屏幕，而是智能地、有选择性地再次调用这个Composable函数（以及其他依赖了相同数据的函数），用新的数据来更新UI树中对应的部分。这个过程可能发生多次，甚至非常频繁。&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>核心思想&lt;/strong>：你只需要用代码声明在某个数据状态下，你的UI应该长什么样。当数据变化时，Compose框架会自动帮你完成从旧UI到新UI的转换，不需要手动去查找并更新某个&lt;code>TextView&lt;/code>或&lt;code>ImageView&lt;/code>。&lt;/p>
&lt;h5 id="状态state">状态（State）
&lt;/h5>&lt;p>在Compose中，&lt;strong>State&lt;/strong>就是任何会随时间变化并且会影响&lt;strong>UI&lt;/strong>的值。&lt;/p>
&lt;ul>
&lt;li>&lt;code>State&amp;lt;T&amp;gt;&lt;/code>和&lt;code>MutableState&amp;lt;T&amp;gt;&lt;/code>&lt;/li>
&lt;/ul>
&lt;h5 id="remember">remember
&lt;/h5>&lt;p>在多次重组之间保持Composable内部状态或对象的关键机制。没有它，每次重组都会导致局部变量被重置。&lt;/p>
&lt;ul>
&lt;li>&lt;code>remember&lt;/code>的作用是让一个对象（任何对象）在多次重组之间活下来。&lt;/li>
&lt;li>&lt;code>State&lt;/code>的作用是当它的值改变时，通知Compose进行重组。&lt;/li>
&lt;/ul>
&lt;p>remember和State是一对黄金搭档，共同解决了“UI内部状态”的问题：&lt;/p>
&lt;ol>
&lt;li>我需要一个变量来存储UI的状态(例如，一个计数器，一个复选框是否被选中)。&lt;/li>
&lt;li>这个变量必须能在多次重组中保持他的值不被重置 -&amp;gt; 所以用&lt;code>remember&lt;/code>。&lt;/li>
&lt;li>当这个变量的值改变时，UI必须自动更新（即重组）-&amp;gt; 所以用&lt;code>State&lt;/code>。&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>&lt;code>remember&lt;/code>是为了“记忆”：让变量/对象在重组中幸存。&lt;/li>
&lt;li>&lt;code>State&lt;/code>是为了“通知”：让值的变化能触发重组。&lt;/li>
&lt;/ul>
&lt;h4 id="重组触发机制">重组触发机制
&lt;/h4>&lt;h5 id="1-基于state的订阅式重组state-read-based-recomposition">1. 基于State的订阅式重组（State-Read-based-Recomposition）
&lt;/h5>&lt;ul>
&lt;li>&lt;strong>注册/订阅&lt;/strong>：当一个Composable函数在执行过程中读取(Read)了一个&lt;code>State&lt;/code>对象的值，Compose就会在这个函数和这个&lt;code>State&lt;/code>对象之间建立一个隐藏的订阅关系。&lt;/li>
&lt;li>&lt;strong>变化通知&lt;/strong>：当这个&lt;code>State&lt;/code>对象的值被写入(write)一个新值时，它会像一个发布者一样，通知所有订阅了它的Composable: “我的值变了!”&lt;/li>
&lt;li>&lt;strong>精确重组&lt;/strong>：收到通知的Composable会标记为“需要重组”，Compose会在下一帧高效地更新它们。&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>优点&lt;/strong>：非常精确和高效。只有直接读取了这个State的Composable才会被重组。&lt;/p>
&lt;h5 id="2-基于函数调用与参数变化的重组function-call-with-parameter-change-recomposition">2. 基于“函数调用与参数变化”的重组（Function-Call-with-Parameter-Change Recomposition）
&lt;/h5>&lt;p>当一个父Composable发生重组时，它会重新执行其函数体内的代码。如果函数体内包含了对子Composable的调用（比如&lt;code>Greeting(name)&lt;/code>），那么Compose就会执行一次“前置检查”：&lt;/p>
&lt;ol>
&lt;li>参数比较：Compose会比较这次调用&lt;code>Greeting&lt;/code>时传入的参数(&lt;code>name&lt;/code>)和上一次调用时传入的参数。&lt;/li>
&lt;li>决策：
&lt;ul>
&lt;li>如果参数没有变化，Compose就会跳过(&lt;strong>Skip&lt;/strong>)&lt;code>Greeting&lt;/code>函数的执行，直接复用上次的结果。&lt;/li>
&lt;li>如果参数发生了变化，Compose就会执行&lt;code>Greeting&lt;/code>函数，用新的参数来生成新的UI。这个执行过程，就是子Composable的重组。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ... 在有状态的 ForYouScreen 中
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 机制 1 的开始：订阅 StateFlow，转换为 State
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> feedState &lt;span style="color:#66d9ef">by&lt;/span> viewModel.feedState.collectAsStateWithLifecycle()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 机制 2 的开始：因为 feedState 变了，所以再次调用无状态的 ForYouScreen
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>ForYouScreen(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> feedState = feedState, &lt;span style="color:#75715e">// &amp;lt;--- 参数发生变化
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">..&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>&lt;code>ViewModel&lt;/code> 中的 &lt;code>StateFlow&lt;/code> 发出了一个新值。&lt;/li>
&lt;li>&lt;code>collectAsStateWithLifecycle()&lt;/code> 将其转换为一个 &lt;code>State&lt;/code> 对象，并更新了这个 &lt;code>State&lt;/code> 的值。(机制 1 触发)&lt;/li>
&lt;li>因为有状态的 &lt;code>ForYouScreen&lt;/code> 读取了这个 &lt;code>State&lt;/code>，所以它被安排重组。&lt;/li>
&lt;li>有状态的 &lt;code>ForYouScreen&lt;/code> 重新执行，当它调用无状态的 &lt;code>ForYouScreen&lt;/code> 时，传入的 &lt;code>feedState&lt;/code> 参数是一个全新的值。(机制 2 触发)&lt;/li>
&lt;li>无状态的 &lt;code>ForYouScreen&lt;/code> 检测到 &lt;code>feedState&lt;/code> 参数变化，因此它也必须重组，并根据新的 &lt;code>feedState&lt;/code> 更新其内部的 UI。&lt;/li>
&lt;/ol>
&lt;h5 id="补充智能重组smart-recomposition">补充：智能重组(Smart Recomposition)
&lt;/h5>&lt;p>Compose能够跳过(&lt;strong>Skip&lt;/strong>)那些输入参数没有变化的Composable函数的执行。&lt;/p>
&lt;p>这套机制，我们通常称之为智能重组(&lt;strong>Smart Recomposition&lt;/strong>)。它依赖两个基本原则：&lt;/p>
&lt;ol>
&lt;li>位置记忆：Compose不靠函数名，而是靠Composable在UI树中的“位置”来识别它。在重组时，它知道上次在同一个位置的是哪个函数。&lt;/li>
&lt;li>输入参数稳定性：在重组时，Compose会比较一个Composable上一次调用时的输入参数和这一次调用的输入参数。如果所有参数都没有变化，Compose就会完全跳过这个函数的执行，直接复用它上次生成的UI。&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>什么是“稳定的”(Stable)参数&lt;/strong>&lt;/p>
&lt;p>Compose的这个Skip机制依赖于能够可靠地判断参数是否“相等”。对于以下类型的参数，Compose认为它们是稳定的：&lt;/p>
&lt;ul>
&lt;li>基本类型：&lt;code>Int&lt;/code>,&lt;code>Float&lt;/code>,&lt;code>Boolean&lt;/code>,&lt;code>String&lt;/code>等。Compose可以轻易地通过&lt;code>==&lt;/code>来判断它们是否相等。&lt;/li>
&lt;li>函数类型：例如&lt;code>()-&amp;gt; Unit&lt;/code>。只要他们不是在每次重组时都创建一个新的lambda实例，它们就是稳定的&lt;/li>
&lt;li>被&lt;code>@Stable&lt;/code>或&lt;code>@Immutable&lt;/code>注解的类：&lt;code>data class&lt;/code>默认是稳定的，因为它的&lt;code>equals&lt;/code>是基于所有属性的。你可以使用这些注解告诉Compose你的类是稳定的。即使它不是&lt;code>data class&lt;/code>。&lt;/li>
&lt;li>Compose的内置类型：如&lt;code>Modifier&lt;/code>。&lt;/li>
&lt;/ul>
&lt;p>&lt;code>Stable&lt;/code>参数意味着Compose可以安全的通过比较（通常是&lt;code>equals&lt;/code>）来确定它是否发生了变化，从而决定是否Skip使用它的Composable重组。&lt;/p></description></item><item><title>Gradle构建组织方式Convention Plugins</title><link>https://www.dust-zed.site/android-develop/gradle%E6%9E%84%E5%BB%BA%E7%BB%84%E7%BB%87%E6%96%B9%E5%BC%8Fconvention-plugins/</link><pubDate>Fri, 24 Oct 2025 03:52:15 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/gradle%E6%9E%84%E5%BB%BA%E7%BB%84%E7%BB%87%E6%96%B9%E5%BC%8Fconvention-plugins/</guid><description>&lt;h4 id="核心思想">核心思想
&lt;/h4>&lt;p>Convention Plugins是一种通过预配置的Gradle插件来&lt;strong>标准化和复用构建逻辑&lt;/strong>的方法，核心理念是：&lt;/p>
&lt;ul>
&lt;li>约定优于配置 （Convention over Configuration）&lt;/li>
&lt;li>&lt;strong>DRY&lt;/strong>原则（Don&amp;rsquo;t Repeat Yourself）&lt;/li>
&lt;li>构建逻辑集中管理&lt;/li>
&lt;li>类型安全的配置&lt;/li>
&lt;/ul>
&lt;h4 id="典型项目结构">典型项目结构
&lt;/h4>&lt;pre tabindex="0">&lt;code>project/
├── build-logic/ # 构建逻辑模块
│ ├── settings.gradle.kts
│ └── convention/ # 约定插件模块
│ ├── build.gradle.kts
│ └── src/main/kotlin/
│ ├── AndroidApplicationConventionPlugin.kt
│ ├── AndroidLibraryConventionPlugin.kt
│ ├── AndroidFeatureConventionPlugin.kt
│ └── KotlinLibraryConventionPlugin.kt
├── settings.gradle.kts
├── app/
├── feature/
│ ├── feature-foryou/
│ └── feature-bookmarks/
└── core/
├── core-ui/
└── core-data/
&lt;/code>&lt;/pre>&lt;h4 id="解决的问题">解决的问题
&lt;/h4>&lt;p>如果不使用Convention Plugins会怎么样，项目中有10个&lt;code>feature&lt;/code>模块（比如&lt;code>:feature:foryou&lt;/code>,&lt;code>:feature:bookmarks&lt;/code>,&lt;code>feature:settings&lt;/code>等）。在传统的做法中，每个模块的&lt;code>build.gradle.kts&lt;/code>文件都会包含大量相似的配置：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 在 :feature:foryou/build.gradle.kts 文件中
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>plugins {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id(&lt;span style="color:#e6db74">&amp;#34;com.android.library&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id(&lt;span style="color:#e6db74">&amp;#34;kotlin-android&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id(&lt;span style="color:#e6db74">&amp;#34;dagger.hilt.android.plugin&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...可能还有其他插件
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>android {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...大量通用的安卓配置
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dependencies {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementation(project(&lt;span style="color:#e6db74">&amp;#34;:core:designsystem&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementation(project(&lt;span style="color:#e6db74">&amp;#34;:core:ui&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementation(&lt;span style="color:#e6db74">&amp;#34;androidx.lifecycle:lifecycle-viewmodel-compose:...&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...可能还有10个以上所有feature模块都需要的通用依赖
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在，如果你需要为所有&lt;code>feature&lt;/code>模块添加一个新的通用依赖库，或者修改一个通用的编译选项，你就必须手动去修改10个不同的&lt;code>build.gradle.kts&lt;/code>文件。这不仅繁琐，而且极易出错，非常难以维护。&lt;/p>
&lt;h4 id="实现方式">实现方式
&lt;/h4>&lt;h5 id="1-设置build-logic模块">1. 设置build-logic模块
&lt;/h5>&lt;p>&lt;strong>build-logic/settings.gradle.kts&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>pluginManagement {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repositories {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> gradlePluginPortal()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> google()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dependencyResolutionManagement {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repositories {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> google {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> content {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> includeGroupByRegex(&lt;span style="color:#e6db74">&amp;#34;com&lt;/span>&lt;span style="color:#ae81ff">\\&lt;/span>&lt;span style="color:#e6db74">.android.*&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> includeGroupByRegex(&lt;span style="color:#e6db74">&amp;#34;com&lt;/span>&lt;span style="color:#ae81ff">\\&lt;/span>&lt;span style="color:#e6db74">.google.*&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> includeGroupByRegex(&lt;span style="color:#e6db74">&amp;#34;androidx.*&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mavenCentral()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> versionCatalogs {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> create(&lt;span style="color:#e6db74">&amp;#34;libs&amp;#34;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> from(files(&lt;span style="color:#e6db74">&amp;#34;../gradle/libs.versions.toml&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rootProject.name = &lt;span style="color:#e6db74">&amp;#34;build-logic&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>include(&lt;span style="color:#e6db74">&amp;#34;:convention&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>build-logic/convention/build.gradle.kts&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>plugins {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">`&lt;/span>kotlin-dsl&lt;span style="color:#960050;background-color:#1e0010">`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dependencies {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> compileOnly(libs.android.gradlePlugin)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> compileOnly(libs.kotlin.gradlePlugin)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> compileOnly(libs.ksp.gradlePlugin)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>gradlePlugin {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> plugins {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> register(&lt;span style="color:#e6db74">&amp;#34;androidApplicationCompose&amp;#34;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id = libs.plugins.nowinandroid.android.application.compose.&lt;span style="color:#66d9ef">get&lt;/span>().pluginId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementationClass = &lt;span style="color:#e6db74">&amp;#34;AndroidApplicationComposeConventionPlugin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> register(&lt;span style="color:#e6db74">&amp;#34;androidApplication&amp;#34;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id = libs.plugins.nowinandroid.android.application.asProvider().&lt;span style="color:#66d9ef">get&lt;/span>().pluginId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementationClass = &lt;span style="color:#e6db74">&amp;#34;AndroidApplicationConventionPlugin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> register(&lt;span style="color:#e6db74">&amp;#34;androidLibraryCompose&amp;#34;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id = libs.plugins.nowinandroid.android.library.compose.&lt;span style="color:#66d9ef">get&lt;/span>().pluginId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementationClass = &lt;span style="color:#e6db74">&amp;#34;AndroidLibraryComposeConventionPlugin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> register(&lt;span style="color:#e6db74">&amp;#34;androidLibrary&amp;#34;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id = libs.plugins.nowinandroid.android.library.asProvider().&lt;span style="color:#66d9ef">get&lt;/span>().pluginId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementationClass = &lt;span style="color:#e6db74">&amp;#34;AndroidLibraryConventionPlugin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> register(&lt;span style="color:#e6db74">&amp;#34;androidFeature&amp;#34;&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id = libs.plugins.nowinandroid.android.feature.&lt;span style="color:#66d9ef">get&lt;/span>().pluginId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementationClass = &lt;span style="color:#e6db74">&amp;#34;AndroidFeatureConventionPlugin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2-创建约定插件">2. 创建约定插件
&lt;/h5>&lt;p>&lt;strong>AndroidApplicationConventionPlugin.kt&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">AndroidApplicationConventionPlugin&lt;/span> : Plugin&amp;lt;Project&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">apply&lt;/span>(target: Project) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> with(target) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;com.android.application&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;org.jetbrains.kotlin.android&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;nowinandroid.android.lint&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;com.dropbox.dependency-guard&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> extensions.configure&amp;lt;ApplicationExtension&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureKotlinAndroid(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> defaultConfig.targetSdk = &lt;span style="color:#ae81ff">35&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">@Suppress&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;UnstableApiUsage&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> testOptions.animationsDisabled = &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureGradleManagedDevices(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> extensions.configure&amp;lt;ApplicationAndroidComponentsExtension&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configurePrintApksTask(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureBadgingTasks(extensions.getByType&amp;lt;ApplicationExtension&amp;gt;(), &lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>AndroidApplicationComposeConventionPlugin.kt&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">AndroidApplicationComposeConventionPlugin&lt;/span> : Plugin&amp;lt;Project&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">apply&lt;/span>(target: Project) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> with(target) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;com.android.application&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;org.jetbrains.kotlin.plugin.compose&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> extension = extensions.getByType&amp;lt;ApplicationExtension&amp;gt;()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureAndroidCompose(extension)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>AndroidLibraryComposeConventionPlugin.kt&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">AndroidLibraryComposeConventionPlugin&lt;/span> : Plugin&amp;lt;Project&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">apply&lt;/span>(target: Project) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> with(target) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;com.android.library&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;org.jetbrains.kotlin.plugin.compose&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> extension = extensions.getByType&amp;lt;LibraryExtension&amp;gt;()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureAndroidCompose(extension)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>AndroidLibraryConventionPlugin.kt&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">AndroidLibraryConventionPlugin&lt;/span> : Plugin&amp;lt;Project&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">apply&lt;/span>(target: Project) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> with(target) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;com.android.library&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;org.jetbrains.kotlin.android&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;nowinandroid.android.lint&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> extensions.configure&amp;lt;LibraryExtension&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureKotlinAndroid(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> testOptions.targetSdk = &lt;span style="color:#ae81ff">35&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> lint.targetSdk = &lt;span style="color:#ae81ff">35&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> defaultConfig.testInstrumentationRunner = &lt;span style="color:#e6db74">&amp;#34;androidx.test.runner.AndroidJUnitRunner&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> testOptions.animationsDisabled = &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureFlavors(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureGradleManagedDevices(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// The resource prefix is derived from the module name,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// so resources inside &amp;#34;:core:module1&amp;#34; must be prefixed with &amp;#34;core_module1_&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> resourcePrefix =
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path.split(&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;\W&amp;#34;&amp;#34;&amp;#34;&lt;/span>.toRegex()).drop(&lt;span style="color:#ae81ff">1&lt;/span>).distinct().joinToString(separator = &lt;span style="color:#e6db74">&amp;#34;_&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .lowercase() + &lt;span style="color:#e6db74">&amp;#34;_&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> extensions.configure&amp;lt;LibraryAndroidComponentsExtension&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configurePrintApksTask(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> disableUnnecessaryAndroidTests(target)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dependencies {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;androidTestImplementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;kotlin.test&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;testImplementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;kotlin.test&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;androidx.tracing.ktx&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>AndroidFeatureConvention.kt&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">AndroidFeatureConventionPlugin&lt;/span> : Plugin&amp;lt;Project&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">apply&lt;/span>(target: Project) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> with(target) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;nowinandroid.android.library&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;nowinandroid.hilt&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;org.jetbrains.kotlin.plugin.serialization&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> extensions.configure&amp;lt;LibraryExtension&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> testOptions.animationsDisabled = &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureGradleManagedDevices(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dependencies {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(project(&lt;span style="color:#e6db74">&amp;#34;:core:ui&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(project(&lt;span style="color:#e6db74">&amp;#34;:core:designsystem&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;androidx.hilt.navigation.compose&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;androidx.lifecycle.runtimeCompose&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;androidx.lifecycle.viewModelCompose&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;androidx.navigation.compose&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;androidx.tracing.ktx&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;kotlinx.serialization.json&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;testImplementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;androidx.navigation.testing&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;androidTestImplementation&amp;#34;&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;androidx.lifecycle.runtimeTesting&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="3-核心方法apply">3. 核心方法：&lt;code>apply&lt;/code>
&lt;/h5>&lt;p>当你将这个插件引用到一个模块时（例如，在&lt;code>:feature:foryou&lt;/code>中应用它），Gradle就会执行这个插件类中的&lt;code>apply&lt;/code>方法。逐行分析这个方法做了什么：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 在 AndroidFeatureConventionPlugin.kt 中
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">AndroidFeatureConventionPlugin&lt;/span> : Plugin&amp;lt;Project&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">apply&lt;/span>(target: Project) { &lt;span style="color:#75715e">// &amp;#39;target&amp;#39; 就是应用这个插件的模块, 比如 :feature:foryou
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> with(target) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// --- 动作一：应用其他更基础的约定插件 ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 这行代码在说：“一个 `feature` 模块，首先它是一个 `library` 模块，
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 并且它也需要 Hilt 依赖注入和序列化功能。”
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 这体现了插件的组合能力。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;nowinandroid.android.library&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;nowinandroid.hilt&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> apply(plugin = &lt;span style="color:#e6db74">&amp;#34;org.jetbrains.kotlin.plugin.serialization&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// --- 动作二：配置通用的 Android 属性 ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 这里统一为所有 feature 模块配置 &amp;#39;android&amp;#39; 代码块。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 比如，统一关闭测试中的动画，统一配置测试设备。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> extensions.configure&amp;lt;LibraryExtension&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> testOptions.animationsDisabled = &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureGradleManagedDevices(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// --- 动作三：添加所有 feature 模块都需要的通用依赖 ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 这是最强大的部分。它声明了“每一个” feature 模块都会自动获得这些依赖。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 无需在各自的 build.gradle.kts 中重复添加。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> dependencies {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(project(&lt;span style="color:#e6db74">&amp;#34;:core:ui&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(project(&lt;span style="color:#e6db74">&amp;#34;:core:designsystem&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;androidx.hilt.navigation.compose&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;implementation&amp;#34;&lt;/span>(libs.findLibrary(&lt;span style="color:#e6db74">&amp;#34;androidx.lifecycle.viewModelCompose&amp;#34;&lt;/span>).&lt;span style="color:#66d9ef">get&lt;/span>())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ... 以及其他所有通用依赖
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="4-共享配置函数">4. 共享配置函数
&lt;/h5>&lt;p>&lt;strong>KotlinAndroid.kt&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> com.android.build.api.dsl.CommonExtension
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> org.gradle.api.JavaVersion
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> org.gradle.api.Project
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> org.gradle.kotlin.dsl.dependencies
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> org.gradle.kotlin.dsl.withType
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> org.jetbrains.kotlin.gradle.tasks.KotlinCompile
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">internal&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">Project&lt;/span>.configureKotlinAndroid(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> commonExtension: CommonExtension&amp;lt;*, *, *, *, *, *&amp;gt;,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> commonExtension.apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> compileSdk = &lt;span style="color:#ae81ff">34&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> defaultConfig {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> minSdk = &lt;span style="color:#ae81ff">24&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> compileOptions {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sourceCompatibility = &lt;span style="color:#a6e22e">JavaVersion&lt;/span>.VERSION_17
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> targetCompatibility = &lt;span style="color:#a6e22e">JavaVersion&lt;/span>.VERSION_17
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> configureKotlin()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">Project&lt;/span>.configureKotlin() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tasks.withType&amp;lt;KotlinCompile&amp;gt;().configureEach {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> kotlinOptions {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> jvmTarget = &lt;span style="color:#a6e22e">JavaVersion&lt;/span>.VERSION_17.toString()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> freeCompilerArgs = freeCompilerArgs + listOf(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-opt-in=kotlin.RequiresOptIn&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-opt-in=kotlinx.coroutines.ExperimentalCoroutinesApi&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="5-在根项目中引入">5. 在根项目中引入
&lt;/h5>&lt;p>&lt;strong>settings.gradle.kts&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>pluginManagement {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> includeBuild(&lt;span style="color:#e6db74">&amp;#34;build-logic&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repositories {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> google()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mavenCentral()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> gradlePluginPortal()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="6-在模块中引入">6. 在模块中引入
&lt;/h5>&lt;p>&lt;strong>app/build.gradle.kts&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>plugins {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id(&lt;span style="color:#e6db74">&amp;#34;myapp.android.application&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id(&lt;span style="color:#e6db74">&amp;#34;myapp.android.application.compose&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>android {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> namespace = &lt;span style="color:#e6db74">&amp;#34;com.example.myapp&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 只需配置特定于此模块的内容
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> defaultConfig {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> applicationId = &lt;span style="color:#e6db74">&amp;#34;com.example.myapp&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dependencies {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementation(project(&lt;span style="color:#e6db74">&amp;#34;:feature:home&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementation(project(&lt;span style="color:#e6db74">&amp;#34;:feature:profile&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>feature/feature-home/build.gradle.kts&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>plugins {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id(&lt;span style="color:#e6db74">&amp;#34;myapp.android.feature&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>android {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> namespace = &lt;span style="color:#e6db74">&amp;#34;com.example.myapp.feature.home&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dependencies {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Feature 特定的依赖
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="convention-plugin的优势">Convention Plugin的优势
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>DRY (Don&amp;rsquo;t Repeat Yourself)&lt;/strong> 原则：消除了在几十个文件中复制粘贴的构建逻辑。&lt;/li>
&lt;li>单一事实来源 (&lt;strong>Single Source of Truth&lt;/strong>)：如果需要更新一个所有&lt;code> feature&lt;/code> 模块都在用的库版本（比如 Lifecycle），你只需要在 &lt;code>AndroidFeatureConventionPlugin.kt&lt;/code> 这一个文件里修改即可。&lt;/li>
&lt;li>简洁与清晰：每个模块的构建脚本变得非常短，只包含对该模块独一无二的配置，可读性大大提高。&lt;/li>
&lt;li>类型安全与 IDE 支持：因为这些插件是用 Kotlin 编写的，你可以享受到 IDE 的自动补全、编译时类型检查和方便的导航跳转，这比传统的 Groovy 脚本要强大得多。&lt;/li>
&lt;/ol>
&lt;p>这些都是&lt;code>now-in-android&lt;/code>所应用的，更详细的可以通过此项目学习&lt;/p></description></item><item><title>Android四大组件</title><link>https://www.dust-zed.site/android-develop/android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/</link><pubDate>Tue, 21 Oct 2025 00:05:46 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/</guid><description>&lt;h4 id="activity">Activity
&lt;/h4>&lt;h5 id="生命周期">生命周期
&lt;/h5>&lt;pre tabindex="0">&lt;code>┌──────────────┐
│ Activity │
│ Created │
└──────────────┘
↓
onCreate() ← 创建，初始化变量、加载布局
↓
onStart() ← 可见但不可交互
↓
onResume() ← 可见且可交互（前台）
↓
[运行中]
↓
onPause() ← 部分可见（被遮挡，如对话框）
↓
onStop() ← 完全不可见（切到后台）
↓
onDestroy() ← 销毁，释放资源
↓
[结束]
&lt;/code>&lt;/pre>&lt;hr>
&lt;h5 id="状态保存与恢复">状态保存与恢复
&lt;/h5>&lt;h6 id="为什么需要保存状态">为什么需要保存状态？
&lt;/h6>&lt;pre tabindex="0">&lt;code>用户正在填写表单
↓
突然来电话 → Activity 被销毁
↓
电话结束返回 → Activity 重新创建
↓
表单内容丢失了！❌
&lt;/code>&lt;/pre>&lt;h5 id="保存状态">保存状态
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FormActivity&lt;/span> : AppCompatActivity() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> userName: String = &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> age: Int = &lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 保存状态（系统杀死 Activity 前调用）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onSaveInstanceState&lt;/span>(outState: Bundle) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onSaveInstanceState(outState)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> outState.putString(&lt;span style="color:#e6db74">&amp;#34;userName&amp;#34;&lt;/span>, userName)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> outState.putInt(&lt;span style="color:#e6db74">&amp;#34;age&amp;#34;&lt;/span>, age)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;State&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;状态已保存&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 恢复状态
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreate&lt;/span>(savedInstanceState: Bundle?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onCreate(savedInstanceState)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setContentView(&lt;span style="color:#a6e22e">R&lt;/span>.layout.activity_form)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 方式 1: 在 onCreate 中恢复
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> (savedInstanceState &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> userName = savedInstanceState.getString(&lt;span style="color:#e6db74">&amp;#34;userName&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> age = savedInstanceState.getInt(&lt;span style="color:#e6db74">&amp;#34;age&amp;#34;&lt;/span>, &lt;span style="color:#ae81ff">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;State&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;状态已恢复: &lt;/span>&lt;span style="color:#e6db74">$userName&lt;/span>&lt;span style="color:#e6db74">, &lt;/span>&lt;span style="color:#e6db74">$age&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 方式 2: 在 onRestoreInstanceState 中恢复
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onRestoreInstanceState&lt;/span>(savedInstanceState: Bundle) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onRestoreInstanceState(savedInstanceState)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> userName = savedInstanceState.getString(&lt;span style="color:#e6db74">&amp;#34;userName&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> age = savedInstanceState.getInt(&lt;span style="color:#e6db74">&amp;#34;age&amp;#34;&lt;/span>, &lt;span style="color:#ae81ff">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h5 id="启动模式">启动模式
&lt;/h5>&lt;h6 id="4种启动模式">4种启动模式
&lt;/h6>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&amp;lt;!&lt;span style="color:#f92672">--&lt;/span> &lt;span style="color:#a6e22e">AndroidManifest&lt;/span>.xml &lt;span style="color:#f92672">--&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;activity
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> android:name=&lt;span style="color:#e6db74">&amp;#34;.MainActivity&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> android:launchMode=&lt;span style="color:#e6db74">&amp;#34;standard&amp;#34;&lt;/span> /&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h6 id="1-standard">1. standard
&lt;/h6>&lt;pre tabindex="0">&lt;code>每次启动都创建新实例
MainActivity → MainActivity → MainActivity
↑ ↑ ↑
实例 1 实例 2 实例 3
返回栈: [实例3, 实例2, 实例1]
&lt;/code>&lt;/pre>&lt;h6 id="2-singletop">2. singleTop
&lt;/h6>&lt;pre tabindex="0">&lt;code>如果在栈顶，复用；否则创建新实例
场景 1: MainActivity 在栈顶
MainActivity (栈顶) → 启动 MainActivity
↓
调用 onNewIntent() 复用，不创建新实例
场景 2: MainActivity 不在栈顶
MainActivity → DetailActivity → 启动 MainActivity
↓
创建新实例: [MainActivity(新), DetailActivity, MainActivity(旧)]
&lt;/code>&lt;/pre>&lt;p>用途：通知栏点击、搜索结果页&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SearchActivity&lt;/span> : AppCompatActivity() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreate&lt;/span>(savedInstanceState: Bundle?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onCreate(savedInstanceState)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> handleIntent(intent)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// singleTop 模式下，再次启动时调用
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onNewIntent&lt;/span>(intent: Intent) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onNewIntent(intent)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setIntent(intent) &lt;span style="color:#75715e">// 更新 intent
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> handleIntent(intent)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">handleIntent&lt;/span>(intent: Intent) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> query = intent.getStringExtra(&lt;span style="color:#e6db74">&amp;#34;query&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 搜索...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h6 id="3-singletask">3. singleTask
&lt;/h6>&lt;pre tabindex="0">&lt;code>整个任务栈中只有一个实例
场景 1: 不存在
TaskA: [DetailActivity, MainActivity]
启动 ProfileActivity (singleTask)
↓
TaskA: [ProfileActivity, DetailActivity, MainActivity]
场景 2: 已存在
TaskA: [DetailActivity, ProfileActivity, MainActivity]
启动 ProfileActivity
↓
清除其上所有 Activity，ProfileActivity 移到栈顶
TaskA: [ProfileActivity, MainActivity]
DetailActivity 被销毁！
&lt;/code>&lt;/pre>&lt;p>用途：主页、登录页&lt;/p>
&lt;h6 id="4-singleinstance">4. singleInstance
&lt;/h6>&lt;pre tabindex="0">&lt;code>独占一个任务栈，整个系统中只有一个实例
TaskA: [DetailActivity, MainActivity]
启动 VideoActivity (singleInstance)
↓
TaskA: [DetailActivity, MainActivity]
TaskB: [VideoActivity] ← 独立的任务栈
从 VideoActivity 启动其他 Activity
↓
TaskA: [OtherActivity, DetailActivity, MainActivity]
TaskB: [VideoActivity] ← 仍然独占
&lt;/code>&lt;/pre>&lt;p>用途：视频通话、闹钟&lt;/p>
&lt;hr>
&lt;h5 id="intent-flags">Intent Flags
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// FLAG_ACTIVITY_NEW_TASK: 新任务栈
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#66d9ef">this&lt;/span>, MainActivity&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span>.java)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>intent.flags = &lt;span style="color:#a6e22e">Intent&lt;/span>.FLAG_ACTIVITY_NEW_TASK
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>startActivity(intent)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// FLAG_ACTIVITY_CLEAR_TOP: 清除其上所有 Activity
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 常用于&amp;#34;返回主页&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#66d9ef">this&lt;/span>, MainActivity&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span>.java)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>intent.flags = &lt;span style="color:#a6e22e">Intent&lt;/span>.FLAG_ACTIVITY_CLEAR_TOP
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>startActivity(intent)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// FLAG_ACTIVITY_SINGLE_TOP: 等同于 singleTop 模式
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>intent.flags = &lt;span style="color:#a6e22e">Intent&lt;/span>.FLAG_ACTIVITY_SINGLE_TOP
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 组合使用（清除栈并启动）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>intent.flags = &lt;span style="color:#a6e22e">Intent&lt;/span>.FLAG_ACTIVITY_NEW_TASK or &lt;span style="color:#a6e22e">Intent&lt;/span>.FLAG_ACTIVITY_CLEAR_TASK
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="service">Service
&lt;/h4>&lt;h5 id="什么是service">什么是Service？
&lt;/h5>&lt;p>Service = 在后台执行长时间运行操作的组件，没有用户界面&lt;/p>
&lt;pre tabindex="0">&lt;code>前台 Activity: 用户正在浏览商品
后台 Service: 同时下载文件、播放音乐、同步数据
&lt;/code>&lt;/pre>&lt;hr>
&lt;h5 id="service的三种类型">Service的三种类型
&lt;/h5>&lt;h6 id="1-前台服务foreground-service">1. 前台服务（Foreground Service）
&lt;/h6>&lt;p>必须显示通知，用户可见&lt;/p>
&lt;pre tabindex="0">&lt;code>┌─────────────────┐
│ 🔔 通知栏 │
│ 正在播放音乐... │ ← 前台服务的通知
├─────────────────┤
│ 应用界面 │
└─────────────────┘
&lt;/code>&lt;/pre>&lt;p>用途：音乐播放、导航、文件下载&lt;/p>
&lt;h6 id="2-后台服务background-service">2. 后台服务（Background Service）
&lt;/h6>&lt;p>用户不可见，但会被系统限制；Android 8.0+严格限制后台服务&lt;/p>
&lt;p>用途：数据同步，日志上传（但推荐用WorkManager）&lt;/p>
&lt;h6 id="3-绑定服务bound-service">3. 绑定服务（Bound Service）
&lt;/h6>&lt;p>与组件绑定，提供客户端-服务器接口&lt;/p>
&lt;pre tabindex="0">&lt;code>Activity ←───绑定───→ Service
↓ ↓
调用方法 提供方法
&lt;/code>&lt;/pre>&lt;p>用途：进程间通信（IPC）、音乐播放器控制&lt;/p>
&lt;hr>
&lt;h4 id="service生命周期">Service生命周期
&lt;/h4>&lt;h5 id="启动服务started-service">启动服务（Started Service）
&lt;/h5>&lt;pre tabindex="0">&lt;code>startService()
↓
onCreate() ← 首次创建时调用（只调用一次）
↓
onStartCommand() ← 每次 startService() 都调用
↓
[运行中]
↓
onDestroy() ← 服务销毁
&lt;/code>&lt;/pre>&lt;h5 id="绑定服务bound-service">绑定服务（Bound Service）
&lt;/h5>&lt;pre tabindex="0">&lt;code>bindService()
↓
onCreate() ← 首次创建时调用
↓
onBind() ← 返回 IBinder 对象
↓
[绑定中]
↓
unbindService()
↓
onUnbind() ← 所有客户端解绑后调用
↓
onDestroy()
&lt;/code>&lt;/pre>&lt;h5 id="混合模式既启动又绑定">混合模式（既启动又绑定）
&lt;/h5>&lt;pre tabindex="0">&lt;code>startService() + bindService()
↓
onCreate()
↓
onStartCommand() + onBind()
↓
[运行并绑定]
↓
unbindService() ← 解绑后仍然运行
↓
stopService() or stopSelf()
↓
onDestroy()
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="启动服务started-service-1">启动服务（Started Service）
&lt;/h4>&lt;h5 id="基本实现">基本实现
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// MyService.kt
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MyService&lt;/span> : Service() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> TAG = &lt;span style="color:#e6db74">&amp;#34;MyService&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 创建时调用（只调用一次）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreate&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onCreate()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(TAG, &lt;span style="color:#e6db74">&amp;#34;Service 创建&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. 每次 startService() 都调用
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onStartCommand&lt;/span>(intent: Intent?, flags: Int, startId: Int): Int {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(TAG, &lt;span style="color:#e6db74">&amp;#34;Service 启动&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 获取传递的数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> data = intent&lt;span style="color:#f92672">?.&lt;/span>getStringExtra(&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 执行后台任务
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> doWork()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 返回值决定系统杀死服务后的行为
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> START_STICKY
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 3. 销毁时调用
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onDestroy&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onDestroy()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(TAG, &lt;span style="color:#e6db74">&amp;#34;Service 销毁&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 必须实现，但启动服务不需要绑定
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onBind&lt;/span>(intent: Intent?): IBinder? = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">doWork&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ⚠️ 不要在主线程做耗时操作
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Thread {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 执行后台任务
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">Thread&lt;/span>.sleep(&lt;span style="color:#ae81ff">5000&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(TAG, &lt;span style="color:#e6db74">&amp;#34;任务完成&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stopSelf() &lt;span style="color:#75715e">// 任务完成后停止服务
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }.start()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="启动和停止服务">启动和停止服务
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// MainActivity.kt
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MainActivity&lt;/span> : AppCompatActivity() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 启动服务
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">startMyService&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#66d9ef">this&lt;/span>, MyService&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span>.java)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intent.putExtra(&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;Hello Service&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Android 8.0+ 如果是前台服务，使用 startForegroundService
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">Build&lt;/span>.&lt;span style="color:#a6e22e">VERSION&lt;/span>.SDK_INT &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#a6e22e">Build&lt;/span>.&lt;span style="color:#a6e22e">VERSION_CODES&lt;/span>.O) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> startForegroundService(intent)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> startService(intent)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 停止服务
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">stopMyService&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#66d9ef">this&lt;/span>, MyService&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span>.java)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stopService(intent)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="onstartcommand返回值">onStartCommand返回值
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onStartCommand&lt;/span>(intent: Intent?, flags: Int, startId: Int): Int {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">when&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// START_STICKY: 系统杀死后重启服务，但 intent 为 null
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 适用：音乐播放器
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> START_STICKY
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// START_NOT_STICKY: 系统杀死后不重启
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 适用：一次性任务
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> START_NOT_STICKY
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// START_REDELIVER_INTENT: 系统杀死后重启，重新传递 intent
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 适用：需要保证任务完成（如下载）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> START_REDELIVER_INTENT
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="前台服务">前台服务
&lt;/h4>&lt;p>&lt;strong>Android 8.0+严格限制后台服务：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>应用进入后台几分钟后，系统会停止后台服务&lt;/li>
&lt;li>前台服务不会被限制，但必须显示通知&lt;/li>
&lt;/ul>
&lt;h5 id="实现前台服务">实现前台服务
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MusicService&lt;/span> : Service() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> CHANNEL_ID = &lt;span style="color:#e6db74">&amp;#34;music_channel&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> NOTIFICATION_ID = &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreate&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onCreate()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> createNotificationChannel()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onStartCommand&lt;/span>(intent: Intent?, flags: Int, startId: Int): Int {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 创建通知
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> notification = createNotification()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ⚠️ 必须在 5 秒内调用 startForeground，否则 ANR
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> startForeground(NOTIFICATION_ID, notification)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 播放音乐...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> playMusic()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> START_STICKY
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">createNotificationChannel&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">Build&lt;/span>.&lt;span style="color:#a6e22e">VERSION&lt;/span>.SDK_INT &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#a6e22e">Build&lt;/span>.&lt;span style="color:#a6e22e">VERSION_CODES&lt;/span>.O) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> channel = NotificationChannel(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CHANNEL_ID,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;音乐播放&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">NotificationManager&lt;/span>.IMPORTANCE_LOW
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ).apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> description = &lt;span style="color:#e6db74">&amp;#34;音乐播放服务&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> manager = getSystemService(NotificationManager&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span>.java)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> manager.createNotificationChannel(channel)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">createNotification&lt;/span>(): Notification {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 点击通知打开 Activity
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#66d9ef">this&lt;/span>, MainActivity&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span>.java)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> pendingIntent = &lt;span style="color:#a6e22e">PendingIntent&lt;/span>.getActivity(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">this&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intent,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">PendingIntent&lt;/span>.FLAG_IMMUTABLE
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">NotificationCompat&lt;/span>.Builder(&lt;span style="color:#66d9ef">this&lt;/span>, CHANNEL_ID)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .setContentTitle(&lt;span style="color:#e6db74">&amp;#34;正在播放&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .setContentText(&lt;span style="color:#e6db74">&amp;#34;歌曲名称 - 艺术家&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .setSmallIcon(&lt;span style="color:#a6e22e">R&lt;/span>.drawable.ic_music)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .setContentIntent(pendingIntent)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .setOngoing(&lt;span style="color:#66d9ef">true&lt;/span>) &lt;span style="color:#75715e">// 不可滑动删除
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> .addAction(&lt;span style="color:#a6e22e">R&lt;/span>.drawable.ic_pause, &lt;span style="color:#e6db74">&amp;#34;暂停&amp;#34;&lt;/span>, createPauseIntent())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .addAction(&lt;span style="color:#a6e22e">R&lt;/span>.drawable.ic_next, &lt;span style="color:#e6db74">&amp;#34;下一首&amp;#34;&lt;/span>, createNextIntent())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .build()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">createPauseIntent&lt;/span>(): PendingIntent {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#66d9ef">this&lt;/span>, MusicService&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span>.java).apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> action = &lt;span style="color:#e6db74">&amp;#34;ACTION_PAUSE&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">PendingIntent&lt;/span>.getService(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">this&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intent,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">PendingIntent&lt;/span>.FLAG_IMMUTABLE
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">createNextIntent&lt;/span>(): PendingIntent {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#66d9ef">this&lt;/span>, MusicService&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span>.java).apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> action = &lt;span style="color:#e6db74">&amp;#34;ACTION_NEXT&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">PendingIntent&lt;/span>.getService(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">this&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intent,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">PendingIntent&lt;/span>.FLAG_IMMUTABLE
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">playMusic&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 播放逻辑...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onBind&lt;/span>(intent: Intent?): IBinder? = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="前台服务类型android-14">前台服务类型（Android 14+）
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&amp;lt;!-- AndroidManifest.xml --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;manifest&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">&amp;lt;!-- 声明前台服务类型 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;uses-permission&lt;/span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;android.permission.FOREGROUND_SERVICE&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;uses-permission&lt;/span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;application&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;service&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.MusicService&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:foregroundServiceType=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;mediaPlayback&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;/application&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;/manifest&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>前台服务类型&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;code>camera&lt;/code> - 相机&lt;/li>
&lt;li>&lt;code>connectedDevice&lt;/code> - 连接设备&lt;/li>
&lt;li>&lt;code>dataSync&lt;/code> - 数据同步&lt;/li>
&lt;li>&lt;code>location&lt;/code> - 位置&lt;/li>
&lt;li>&lt;code>mediaPlayback&lt;/code> - 媒体播放&lt;/li>
&lt;li>&lt;code>mediaProjection&lt;/code> - 屏幕录制&lt;/li>
&lt;li>&lt;code>microphone&lt;/code> - 麦克风&lt;/li>
&lt;li>&lt;code>phoneCall&lt;/code> - 电话&lt;/li>
&lt;li>&lt;code>remoteMessaging&lt;/code> - 远程消息&lt;/li>
&lt;li>&lt;code>shortService&lt;/code> - 短时服务&lt;/li>
&lt;li>&lt;code>specialUse&lt;/code> - 特殊用途&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h4 id="绑定服务">绑定服务
&lt;/h4>&lt;h5 id="使用场景">使用场景
&lt;/h5>&lt;pre tabindex="0">&lt;code>Activity 需要：
- 调用 Service 的方法
- 获取 Service 的数据
- 监听 Service 的状态
Example: 音乐播放器控制
Activity: 播放/暂停/切歌
Service: 执行实际操作
&lt;/code>&lt;/pre>&lt;h5 id="实现绑定服务">实现绑定服务
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// MusicPlayerService.kt
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MusicPlayerService&lt;/span> : Service() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 定义 Binder（本地服务）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">inner&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MusicBinder&lt;/span> : Binder() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">getService&lt;/span>(): MusicPlayerService = &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#a6e22e">@MusicPlayerService&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> binder = MusicBinder()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. 返回 Binder
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onBind&lt;/span>(intent: Intent?): IBinder = binder
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 3. 提供公共方法供客户端调用
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">play&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;Music&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;播放音乐&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">pause&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;Music&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;暂停音乐&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">getCurrentPosition&lt;/span>(): Int {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#75715e">// 返回当前播放位置
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="绑定服务-1">绑定服务
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// MainActivity.kt
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MainActivity&lt;/span> : AppCompatActivity() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> musicService: MusicPlayerService? = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> isBound = &lt;span style="color:#66d9ef">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 定义 ServiceConnection
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> connection = &lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">: &lt;/span>&lt;span style="color:#a6e22e">ServiceConnection&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onServiceConnected&lt;/span>(name: ComponentName?, service: IBinder?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 服务连接成功
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> binder = service &lt;span style="color:#66d9ef">as&lt;/span> &lt;span style="color:#a6e22e">MusicPlayerService&lt;/span>.MusicBinder
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> musicService = binder.getService()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> isBound = &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;Bind&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;服务已连接&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onServiceDisconnected&lt;/span>(name: ComponentName?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 服务意外断开（如崩溃）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> musicService = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> isBound = &lt;span style="color:#66d9ef">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;Bind&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;服务已断开&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreate&lt;/span>(savedInstanceState: Bundle?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onCreate(savedInstanceState)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setContentView(&lt;span style="color:#a6e22e">R&lt;/span>.layout.activity_main)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. 绑定服务
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#66d9ef">this&lt;/span>, MusicPlayerService&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span>.java)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> bindService(intent, connection, &lt;span style="color:#a6e22e">Context&lt;/span>.BIND_AUTO_CREATE)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 3. 调用服务方法
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onPlayClick&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (isBound) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> musicService&lt;span style="color:#f92672">?.&lt;/span>play()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onPauseClick&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (isBound) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> musicService&lt;span style="color:#f92672">?.&lt;/span>pause()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onDestroy&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onDestroy()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 4. 解绑服务
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> (isBound) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> unbindService(connection)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> isBound = &lt;span style="color:#66d9ef">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="aidl跨进程通信">AIDL(跨进程通信)
&lt;/h5>&lt;p>用于不同应用之间的通信&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-aidl" data-lang="aidl">// IMusicService.aidl
package com.example.myapp;
interface IMusicService {
void play();
void pause();
int getCurrentPosition();
}
&lt;/code>&lt;/pre>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// MusicPlayerService.kt
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MusicPlayerService&lt;/span> : Service() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 实现 AIDL 接口
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> binder = &lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">: &lt;/span>&lt;span style="color:#a6e22e">IMusicService&lt;/span>.Stub() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">play&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 播放逻辑
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">pause&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 暂停逻辑
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">getCurrentPosition&lt;/span>(): Int {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onBind&lt;/span>(intent: Intent?): IBinder = binder
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 客户端 Activity
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MainActivity&lt;/span> : AppCompatActivity() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> musicService: IMusicService? = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> connection = &lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">: &lt;/span>&lt;span style="color:#a6e22e">ServiceConnection&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onServiceConnected&lt;/span>(name: ComponentName?, service: IBinder?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> musicService = &lt;span style="color:#a6e22e">IMusicService&lt;/span>.&lt;span style="color:#a6e22e">Stub&lt;/span>.asInterface(service)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onServiceDisconnected&lt;/span>(name: ComponentName?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> musicService = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onPlayClick&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> musicService&lt;span style="color:#f92672">?.&lt;/span>play()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="service的限制android-80">Service的限制（Android 8.0+）
&lt;/h4>&lt;h5 id="后台执行限制">后台执行限制
&lt;/h5>&lt;pre tabindex="0">&lt;code>应用进入后台几分钟后：
- stopService() 后台服务被停止
- WorkManager 继续执行（推荐）
&lt;/code>&lt;/pre>&lt;h5 id="解决方案">解决方案
&lt;/h5>&lt;h6 id="1-使用前台服务">1. 使用前台服务
&lt;/h6>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 音乐播放、导航、下载
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>startForegroundService(intent)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>service.startForeground(NOTIFICATION_ID, notification)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h6 id="2-使用workmanger">2. 使用workManger
&lt;/h6>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 数据同步、日志上传
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> workRequest = OneTimeWorkRequestBuilder&amp;lt;MyWorker&amp;gt;().build()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">WorkManager&lt;/span>.getInstance(context).enqueue(workRequest)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="broadcastreceiver">BroadcastReceiver
&lt;/h4>&lt;p>&lt;strong>BroadcastReceiver&lt;/strong> = 接收系统或应用发出的广播消息&lt;/p>
&lt;pre tabindex="0">&lt;code>发送者 (Sender) 接收者 (Receiver)
↓ ↓
发送广播 → [Android System] → BroadcastReceiver
(Intent) (onReceive)
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="广播的类型">广播的类型
&lt;/h4>&lt;h5 id="1-系统广播system-broadcast">1. 系统广播（System Broadcast）
&lt;/h5>&lt;p>系统发出的广播&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 常见系统广播
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_BOOT_COMPLETED &lt;span style="color:#75715e">// 开机完成
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_BATTERY_LOW &lt;span style="color:#75715e">// 电量低
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_POWER_CONNECTED &lt;span style="color:#75715e">// 充电器连接
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_SCREEN_ON &lt;span style="color:#75715e">// 屏幕开启
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_SCREEN_OFF &lt;span style="color:#75715e">// 屏幕关闭
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_TIMEZONE_CHANGED &lt;span style="color:#75715e">// 时区改变
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_LOCALE_CHANGED &lt;span style="color:#75715e">// 语言改变
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="应用内广播local-broadcast">应用内广播（Local Broadcast）
&lt;/h5>&lt;p>只在应用内传递，更安全&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 使用 LocalBroadcastManager（已废弃）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 推荐使用 LiveData 或事件总线
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="3-自定义广播custom-broadcast">3. 自定义广播（Custom Broadcast）
&lt;/h5>&lt;p>应用自己定义的广播&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> ACTION_CUSTOM = &lt;span style="color:#e6db74">&amp;#34;com.example.ACTION_CUSTOM&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="注册广播接收器">注册广播接收器
&lt;/h4>&lt;h5 id="方式1-静态注册manifest">方式1: 静态注册（Manifest）
&lt;/h5>&lt;p>应用未运行时也能接收广播&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&amp;lt;!-- AndroidManifest.xml --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;manifest&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">&amp;lt;!-- 需要的权限 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;uses-permission&lt;/span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;android.permission.RECEIVE_BOOT_COMPLETED&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;application&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">&amp;lt;!-- 注册接收器 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;receiver&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.BootReceiver&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:enabled=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:exported=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;false&amp;#34;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">&amp;lt;!-- 声明要接收的广播 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;intent-filter&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;action&lt;/span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;android.intent.action.BOOT_COMPLETED&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;/intent-filter&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;/receiver&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;/application&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;/manifest&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// BootReceiver.kt
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">BootReceiver&lt;/span> : BroadcastReceiver() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onReceive&lt;/span>(context: Context, intent: Intent) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">when&lt;/span> (intent.action) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_BOOT_COMPLETED &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;Boot&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;设备启动完成&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 启动服务或执行初始化
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>**Android 8.0+**限制：&lt;/p>
&lt;ul>
&lt;li>大部分系统广播不能静态注册&lt;/li>
&lt;li>只有少数例外（如&lt;code>BOOT_COMPLETED&lt;/code>、&lt;code>LOCALE_CHANGED&lt;/code>）&lt;/li>
&lt;/ul>
&lt;h5 id="方式2动态注册">方式2:动态注册
&lt;/h5>&lt;p>应用运行时注册，更灵活&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MainActivity&lt;/span> : AppCompatActivity() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 创建接收器
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> batteryReceiver = &lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">: &lt;/span>&lt;span style="color:#a6e22e">BroadcastReceiver&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onReceive&lt;/span>(context: Context, intent: Intent) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">when&lt;/span> (intent.action) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_BATTERY_LOW &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Toast&lt;/span>.makeText(context, &lt;span style="color:#e6db74">&amp;#34;电量低&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">Toast&lt;/span>.LENGTH_SHORT).show()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_BATTERY_OKAY &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Toast&lt;/span>.makeText(context, &lt;span style="color:#e6db74">&amp;#34;电量恢复&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">Toast&lt;/span>.LENGTH_SHORT).show()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreate&lt;/span>(savedInstanceState: Bundle?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onCreate(savedInstanceState)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setContentView(&lt;span style="color:#a6e22e">R&lt;/span>.layout.activity_main)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. 注册接收器
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> filter = IntentFilter().apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> addAction(&lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_BATTERY_LOW)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> addAction(&lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_BATTERY_OKAY)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> registerReceiver(batteryReceiver, filter)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onDestroy&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onDestroy()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 3. 必须取消注册，避免内存泄漏
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> unregisterReceiver(batteryReceiver)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>**Android13+**动态注册&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Android 13+ 需要在运行时请求权限
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">Build&lt;/span>.&lt;span style="color:#a6e22e">VERSION&lt;/span>.SDK_INT &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#a6e22e">Build&lt;/span>.&lt;span style="color:#a6e22e">VERSION_CODES&lt;/span>.TIRAMISU) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> registerReceiver(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">receiver&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> filter,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Context&lt;/span>.RECEIVER_NOT_EXPORTED &lt;span style="color:#75715e">// 或 RECEIVER_EXPORTED
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>} &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> registerReceiver(&lt;span style="color:#66d9ef">receiver&lt;/span>, filter)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="发送广播">发送广播
&lt;/h4>&lt;h5 id="1-标准广播normal-broadcast">1. 标准广播（Normal Broadcast）
&lt;/h5>&lt;p>所有接收器几乎同时收到&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 发送广播
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#e6db74">&amp;#34;com.example.ACTION_CUSTOM&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>intent.putExtra(&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;Hello Broadcast&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sendBroadcast(intent)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 接收广播
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MyReceiver&lt;/span> : BroadcastReceiver() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onReceive&lt;/span>(context: Context, intent: Intent) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> data = intent.getStringExtra(&lt;span style="color:#e6db74">&amp;#34;data&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;Receiver&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;收到: &lt;/span>&lt;span style="color:#e6db74">$data&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2-有序广播ordered-broadcast">2. 有序广播（Ordered Broadcast）
&lt;/h5>&lt;p>按优先级一次传递，可拦截&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 发送有序广播
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#e6db74">&amp;#34;com.example.ACTION_ORDERED&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sendOrderedBroadcast(intent, &lt;span style="color:#66d9ef">null&lt;/span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&amp;lt;!&lt;span style="color:#f92672">--&lt;/span> 设置优先级 &lt;span style="color:#f92672">--&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;&lt;span style="color:#66d9ef">receiver&lt;/span> android:name=&lt;span style="color:#e6db74">&amp;#34;.HighPriorityReceiver&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;intent-filter android:priority=&lt;span style="color:#e6db74">&amp;#34;1000&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;action android:name=&lt;span style="color:#e6db74">&amp;#34;com.example.ACTION_ORDERED&amp;#34;&lt;/span> /&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="contentprovider">ContentProvider
&lt;/h4>&lt;p>&lt;strong>ContentProvider&lt;/strong> = 跨应用共享数据的标准接口&lt;/p>
&lt;pre tabindex="0">&lt;code>应用 A (数据提供者) 应用 B (数据使用者)
↓ ↓
ContentProvider ←─────URI────→ ContentResolver
↓
数据库/文件/网络
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="contentprovider的作用">ContentProvider的作用
&lt;/h4>&lt;h5 id="1-跨应用数据共享">1. 跨应用数据共享
&lt;/h5>&lt;pre tabindex="0">&lt;code>联系人应用 → ContentProvider → 其他应用读取联系人
相册应用 → ContentProvider → 其他应用读取图片
&lt;/code>&lt;/pre>&lt;h5 id="2-统一数据访问接口">2. 统一数据访问接口
&lt;/h5>&lt;pre tabindex="0">&lt;code>不管数据存在哪里（数据库/文件/网络）
都通过统一的 URI 访问
content://com.example.provider/users/1
content://com.android.contacts/contacts/1
&lt;/code>&lt;/pre>&lt;h5 id="3-数据安全控制">3. 数据安全控制
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>可以控制&lt;span style="color:#960050;background-color:#1e0010">：&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- 哪些应用可以访问
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- 哪些数据可以访问&lt;span style="color:#960050;background-color:#1e0010">（&lt;/span>读/写权限&lt;span style="color:#960050;background-color:#1e0010">）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- 数据访问的粒度
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="contentprovider架构">ContentProvider架构
&lt;/h4>&lt;p>&lt;strong>URI&lt;/strong>结构&lt;/p>
&lt;pre tabindex="0">&lt;code>content://authority/path/id
↑ ↑ ↑ ↑
协议 标识符 路径 ID
示例：
content://com.example.provider/users
content://com.example.provider/users/123
content://com.android.contacts/contacts
content://media/external/images/media
&lt;/code>&lt;/pre>&lt;p>组件关系&lt;/p>
&lt;pre tabindex="0">&lt;code>应用 A 应用 B
↓ ↓
ContentProvider ContentResolver
↓ ↓
query() query()
insert() insert()
update() update()
delete() delete()
↓
实际数据存储 (SQLite/文件等)
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="创建contentprovider">创建ContentProvider
&lt;/h4>&lt;h5 id="步骤1定义数据模型">步骤1:定义数据模型
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Contract 类（定义 URI 和列名）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#a6e22e">UserContract&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> AUTHORITY = &lt;span style="color:#e6db74">&amp;#34;com.example.provider&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> CONTENT_URI: Uri = &lt;span style="color:#a6e22e">Uri&lt;/span>.parse(&lt;span style="color:#e6db74">&amp;#34;content://&lt;/span>&lt;span style="color:#e6db74">$AUTHORITY&lt;/span>&lt;span style="color:#e6db74">/users&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#a6e22e">Columns&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> ID = &lt;span style="color:#e6db74">&amp;#34;_id&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> NAME = &lt;span style="color:#e6db74">&amp;#34;name&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> EMAIL = &lt;span style="color:#e6db74">&amp;#34;email&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> AGE = &lt;span style="color:#e6db74">&amp;#34;age&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="步骤2创建数据库helper可选">步骤2：创建数据库Helper(可选)
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">DatabaseHelper&lt;/span>(context: Context) : SQLiteOpenHelper(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> context,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;users.db&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">null&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreate&lt;/span>(db: SQLiteDatabase) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.execSQL(&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> CREATE TABLE users (
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> _id INTEGER PRIMARY KEY AUTOINCREMENT,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> name TEXT NOT NULL,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> email TEXT,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> age INTEGER
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> )
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onUpgrade&lt;/span>(db: SQLiteDatabase, oldVersion: Int, newVersion: Int) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.execSQL(&lt;span style="color:#e6db74">&amp;#34;DROP TABLE IF EXISTS users&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> onCreate(db)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="实现contentprovider">实现ContentProvider
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">UserProvider&lt;/span> : ContentProvider() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">lateinit&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> dbHelper: DatabaseHelper
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> uriMatcher = UriMatcher(&lt;span style="color:#a6e22e">UriMatcher&lt;/span>.NO_MATCH).apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> addURI(&lt;span style="color:#a6e22e">UserContract&lt;/span>.AUTHORITY, &lt;span style="color:#e6db74">&amp;#34;users&amp;#34;&lt;/span>, USERS)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> addURI(&lt;span style="color:#a6e22e">UserContract&lt;/span>.AUTHORITY, &lt;span style="color:#e6db74">&amp;#34;users/#&amp;#34;&lt;/span>, USER_ID)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">companion&lt;/span> &lt;span style="color:#66d9ef">object&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> USERS = &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> USER_ID = &lt;span style="color:#ae81ff">2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 初始化（在应用启动时调用）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreate&lt;/span>(): Boolean {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dbHelper = DatabaseHelper(context&lt;span style="color:#f92672">!!&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. 查询数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">query&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uri: Uri,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> projection: Array&amp;lt;String&amp;gt;?,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> selection: String?,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> selectionArgs: Array&amp;lt;String&amp;gt;?,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sortOrder: String?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ): Cursor? {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> db = dbHelper.readableDatabase
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">when&lt;/span> (uriMatcher.match(uri)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> USERS &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 查询所有用户
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> db.query(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;users&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> projection,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> selection,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> selectionArgs,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">null&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">null&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sortOrder
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> USER_ID &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 查询指定 ID 的用户
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> id = uri.lastPathSegment
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.query(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;users&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> projection,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${UserContract.Columns.ID}&lt;/span>&lt;span style="color:#e6db74"> = ?&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> arrayOf(id),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">null&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">null&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sortOrder
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">throw&lt;/span> IllegalArgumentException(&lt;span style="color:#e6db74">&amp;#34;Unknown URI: &lt;/span>&lt;span style="color:#e6db74">$uri&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 3. 插入数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">insert&lt;/span>(uri: Uri, values: ContentValues?): Uri? {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> db = dbHelper.writableDatabase
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">when&lt;/span> (uriMatcher.match(uri)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> USERS &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> id = db.insert(&lt;span style="color:#e6db74">&amp;#34;users&amp;#34;&lt;/span>, &lt;span style="color:#66d9ef">null&lt;/span>, values)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (id &amp;gt; &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> newUri = &lt;span style="color:#a6e22e">ContentUris&lt;/span>.withAppendedId(&lt;span style="color:#a6e22e">UserContract&lt;/span>.CONTENT_URI, id)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 通知数据变化
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> context&lt;span style="color:#f92672">?.&lt;/span>contentResolver&lt;span style="color:#f92672">?.&lt;/span>notifyChange(newUri, &lt;span style="color:#66d9ef">null&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> newUri
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">throw&lt;/span> IllegalArgumentException(&lt;span style="color:#e6db74">&amp;#34;Unknown URI: &lt;/span>&lt;span style="color:#e6db74">$uri&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 4. 更新数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">update&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uri: Uri,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> values: ContentValues?,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> selection: String?,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> selectionArgs: Array&amp;lt;String&amp;gt;?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ): Int {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> db = dbHelper.writableDatabase
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> count = &lt;span style="color:#66d9ef">when&lt;/span> (uriMatcher.match(uri)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> USERS &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.update(&lt;span style="color:#e6db74">&amp;#34;users&amp;#34;&lt;/span>, values, selection, selectionArgs)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> USER_ID &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> id = uri.lastPathSegment
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.update(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;users&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> values,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${UserContract.Columns.ID}&lt;/span>&lt;span style="color:#e6db74"> = ?&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> arrayOf(id)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">throw&lt;/span> IllegalArgumentException(&lt;span style="color:#e6db74">&amp;#34;Unknown URI: &lt;/span>&lt;span style="color:#e6db74">$uri&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (count &amp;gt; &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> context&lt;span style="color:#f92672">?.&lt;/span>contentResolver&lt;span style="color:#f92672">?.&lt;/span>notifyChange(uri, &lt;span style="color:#66d9ef">null&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> count
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 5. 删除数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">delete&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uri: Uri,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> selection: String?,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> selectionArgs: Array&amp;lt;String&amp;gt;?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ): Int {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> db = dbHelper.writableDatabase
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> count = &lt;span style="color:#66d9ef">when&lt;/span> (uriMatcher.match(uri)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> USERS &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.delete(&lt;span style="color:#e6db74">&amp;#34;users&amp;#34;&lt;/span>, selection, selectionArgs)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> USER_ID &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> id = uri.lastPathSegment
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.delete(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;users&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${UserContract.Columns.ID}&lt;/span>&lt;span style="color:#e6db74"> = ?&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> arrayOf(id)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">throw&lt;/span> IllegalArgumentException(&lt;span style="color:#e6db74">&amp;#34;Unknown URI: &lt;/span>&lt;span style="color:#e6db74">$uri&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (count &amp;gt; &lt;span style="color:#ae81ff">0&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> context&lt;span style="color:#f92672">?.&lt;/span>contentResolver&lt;span style="color:#f92672">?.&lt;/span>notifyChange(uri, &lt;span style="color:#66d9ef">null&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> count
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 6. 返回 MIME 类型
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">getType&lt;/span>(uri: Uri): String? {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">when&lt;/span> (uriMatcher.match(uri)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> USERS &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;vnd.android.cursor.dir/vnd.com.example.provider.users&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> USER_ID &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;vnd.android.cursor.item/vnd.com.example.provider.users&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">throw&lt;/span> IllegalArgumentException(&lt;span style="color:#e6db74">&amp;#34;Unknown URI: &lt;/span>&lt;span style="color:#e6db74">$uri&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="步骤4注册provider">步骤4:注册Provider
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&amp;lt;!-- AndroidManifest.xml --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;manifest&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;application&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;provider&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.UserProvider&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:authorities=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.provider&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:exported=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:permission=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.READ_USERS&amp;#34;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">&amp;lt;!-- 授予其他应用读写权限 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;grant-uri-permission&lt;/span> &lt;span style="color:#a6e22e">android:pathPattern=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;/users/.*&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;/provider&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;/application&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">&amp;lt;!-- 定义权限 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;permission&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.READ_USERS&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:protectionLevel=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;normal&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;permission&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.WRITE_USERS&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:protectionLevel=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;normal&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;/manifest&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="使用contentprovider">使用ContentProvider
&lt;/h4>&lt;p>&lt;strong>查询数据&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MainActivity&lt;/span> : AppCompatActivity() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">queryUsers&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 获取 ContentResolver
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> resolver = contentResolver
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. 构建查询
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> uri = &lt;span style="color:#a6e22e">Uri&lt;/span>.parse(&lt;span style="color:#e6db74">&amp;#34;content://com.example.provider/users&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> projection = arrayOf(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">UserContract&lt;/span>.&lt;span style="color:#a6e22e">Columns&lt;/span>.ID,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">UserContract&lt;/span>.&lt;span style="color:#a6e22e">Columns&lt;/span>.NAME,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">UserContract&lt;/span>.&lt;span style="color:#a6e22e">Columns&lt;/span>.EMAIL
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> selection = &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${UserContract.Columns.AGE}&lt;/span>&lt;span style="color:#e6db74"> &amp;gt; ?&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> selectionArgs = arrayOf(&lt;span style="color:#e6db74">&amp;#34;18&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> sortOrder = &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${UserContract.Columns.NAME}&lt;/span>&lt;span style="color:#e6db74"> ASC&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 3. 执行查询
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> cursor = resolver.query(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uri,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> projection,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> selection,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> selectionArgs,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sortOrder
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 4. 处理结果
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> cursor&lt;span style="color:#f92672">?.&lt;/span>use {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (&lt;span style="color:#66d9ef">it&lt;/span>.moveToNext()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> id = &lt;span style="color:#66d9ef">it&lt;/span>.getLong(&lt;span style="color:#66d9ef">it&lt;/span>.getColumnIndexOrThrow(&lt;span style="color:#a6e22e">UserContract&lt;/span>.&lt;span style="color:#a6e22e">Columns&lt;/span>.ID))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> name = &lt;span style="color:#66d9ef">it&lt;/span>.getString(&lt;span style="color:#66d9ef">it&lt;/span>.getColumnIndexOrThrow(&lt;span style="color:#a6e22e">UserContract&lt;/span>.&lt;span style="color:#a6e22e">Columns&lt;/span>.NAME))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> email = &lt;span style="color:#66d9ef">it&lt;/span>.getString(&lt;span style="color:#66d9ef">it&lt;/span>.getColumnIndexOrThrow(&lt;span style="color:#a6e22e">UserContract&lt;/span>.&lt;span style="color:#a6e22e">Columns&lt;/span>.EMAIL))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;User&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;ID: &lt;/span>&lt;span style="color:#e6db74">$id&lt;/span>&lt;span style="color:#e6db74">, Name: &lt;/span>&lt;span style="color:#e6db74">$name&lt;/span>&lt;span style="color:#e6db74">, Email: &lt;/span>&lt;span style="color:#e6db74">$email&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>插入数据&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">insertUser&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> resolver = contentResolver
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> uri = &lt;span style="color:#a6e22e">Uri&lt;/span>.parse(&lt;span style="color:#e6db74">&amp;#34;content://com.example.provider/users&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> values = ContentValues().apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> put(&lt;span style="color:#a6e22e">UserContract&lt;/span>.&lt;span style="color:#a6e22e">Columns&lt;/span>.NAME, &lt;span style="color:#e6db74">&amp;#34;Alice&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> put(&lt;span style="color:#a6e22e">UserContract&lt;/span>.&lt;span style="color:#a6e22e">Columns&lt;/span>.EMAIL, &lt;span style="color:#e6db74">&amp;#34;alice@example.com&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> put(&lt;span style="color:#a6e22e">UserContract&lt;/span>.&lt;span style="color:#a6e22e">Columns&lt;/span>.AGE, &lt;span style="color:#ae81ff">25&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> newUri = resolver.insert(uri, values)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;Insert&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;新用户 URI: &lt;/span>&lt;span style="color:#e6db74">$newUri&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>更新数据&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">updateUser&lt;/span>(userId: Long) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> resolver = contentResolver
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> uri = &lt;span style="color:#a6e22e">ContentUris&lt;/span>.withAppendedId(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Uri&lt;/span>.parse(&lt;span style="color:#e6db74">&amp;#34;content://com.example.provider/users&amp;#34;&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> userId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> values = ContentValues().apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> put(&lt;span style="color:#a6e22e">UserContract&lt;/span>.&lt;span style="color:#a6e22e">Columns&lt;/span>.EMAIL, &lt;span style="color:#e6db74">&amp;#34;newemail@example.com&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> count = resolver.update(uri, values, &lt;span style="color:#66d9ef">null&lt;/span>, &lt;span style="color:#66d9ef">null&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;Update&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;更新了 &lt;/span>&lt;span style="color:#e6db74">$count&lt;/span>&lt;span style="color:#e6db74"> 条记录&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>删除数据&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">deleteUser&lt;/span>(userId: Long) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> resolver = contentResolver
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> uri = &lt;span style="color:#a6e22e">ContentUris&lt;/span>.withAppendedId(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Uri&lt;/span>.parse(&lt;span style="color:#e6db74">&amp;#34;content://com.example.provider/users&amp;#34;&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> userId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> count = resolver.delete(uri, &lt;span style="color:#66d9ef">null&lt;/span>, &lt;span style="color:#66d9ef">null&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;Delete&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;删除了 &lt;/span>&lt;span style="color:#e6db74">$count&lt;/span>&lt;span style="color:#e6db74"> 条记录&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="监听数据变化">监听数据变化
&lt;/h4>&lt;p>&lt;strong>ContentObserver&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MainActivity&lt;/span> : AppCompatActivity() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> userObserver = &lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">: &lt;/span>&lt;span style="color:#a6e22e">ContentObserver&lt;/span>(Handler(&lt;span style="color:#a6e22e">Looper&lt;/span>.getMainLooper())) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onChange&lt;/span>(selfChange: Boolean, uri: Uri?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onChange(selfChange, uri)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Log&lt;/span>.d(&lt;span style="color:#e6db74">&amp;#34;Observer&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;数据变化: &lt;/span>&lt;span style="color:#e6db74">$uri&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 重新查询数据
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> queryUsers()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreate&lt;/span>(savedInstanceState: Bundle?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onCreate(savedInstanceState)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 注册观察者
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> contentResolver.registerContentObserver(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Uri&lt;/span>.parse(&lt;span style="color:#e6db74">&amp;#34;content://com.example.provider/users&amp;#34;&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">true&lt;/span>, &lt;span style="color:#75715e">// 监听所有子 URI
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> userObserver
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onDestroy&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onDestroy()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 取消注册
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> contentResolver.unregisterContentObserver(userObserver)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="权限控制">权限控制
&lt;/h4>&lt;h5 id="定义权限">定义权限
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&amp;lt;!-- AndroidManifest.xml --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;manifest&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">&amp;lt;!-- 定义权限 --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;permission&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.READ_USERS&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:label=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;读取用户数据&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:description=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;允许读取用户数据&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:protectionLevel=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;normal&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;permission&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.WRITE_USERS&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:label=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;写入用户数据&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:protectionLevel=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;normal&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;application&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;provider&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;.UserProvider&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:authorities=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.provider&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:exported=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:readPermission=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.READ_USERS&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:writePermission=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.WRITE_USERS&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;/application&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;/manifest&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="请求权限">请求权限
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&amp;lt;!-- 其他应用的 Manifest --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;manifest&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;uses-permission&lt;/span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.READ_USERS&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;uses-permission&lt;/span> &lt;span style="color:#a6e22e">android:name=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;com.example.WRITE_USERS&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;/manifest&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="临时授权uri权限">临时授权(URI权限)
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 授予其他应用临时访问权限
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> intent = Intent(&lt;span style="color:#a6e22e">Intent&lt;/span>.ACTION_VIEW)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>intent.&lt;span style="color:#66d9ef">data&lt;/span> = &lt;span style="color:#a6e22e">Uri&lt;/span>.parse(&lt;span style="color:#e6db74">&amp;#34;content://com.example.provider/users/1&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>intent.addFlags(&lt;span style="color:#a6e22e">Intent&lt;/span>.FLAG_GRANT_READ_URI_PERMISSION)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>startActivity(intent)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Surface体系指南</title><link>https://www.dust-zed.site/android-develop/surface%E4%BD%93%E7%B3%BB%E6%8C%87%E5%8D%97/</link><pubDate>Sun, 19 Oct 2025 13:50:30 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/surface%E4%BD%93%E7%B3%BB%E6%8C%87%E5%8D%97/</guid><description>&lt;h4 id="什么是surface">什么是surface？
&lt;/h4>&lt;h5 id="通俗理解">通俗理解
&lt;/h5>&lt;p>&lt;strong>Surface&lt;/strong> = 一块用于绘制内容的“画布”&lt;/p>
&lt;p>Android有多层含义的 Surface 概念，容易混淆：&lt;/p>
&lt;ol>
&lt;li>底层图形系统的&lt;strong>Surface&lt;/strong>（本质）&lt;/li>
&lt;li>&lt;strong>Material Design&lt;/strong>的&lt;strong>Surface&lt;/strong> （设计概念）&lt;/li>
&lt;li>&lt;strong>Compose&lt;/strong>的&lt;strong>Surface&lt;/strong>组件（UI组件）&lt;/li>
&lt;li>&lt;strong>SurfaceView&lt;/strong>和&lt;strong>TextureView&lt;/strong>（特殊视图）&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h5 id="层次架构">层次架构
&lt;/h5>&lt;pre tabindex="0">&lt;code>应用层
↓
Material Surface (设计概念：背景、卡片、对话框)
↓
UI 组件 (Compose Surface / View / SurfaceView)
↓
Android View System / Compose Runtime
↓
底层 Surface (实际的渲染目标)
↓
SurfaceFlinger (系统合成器)
↓
屏幕显示
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="1-material-design-中的surface">1. Material Design 中的Surface
&lt;/h4>&lt;h5 id="什么是surface设计概念">什么是Surface（设计概念）？
&lt;/h5>&lt;p>在Material Design中，&lt;strong>Surface&lt;/strong>是承载内容的容器:&lt;/p>
&lt;pre tabindex="0">&lt;code>┌─────────────────────────────┐
│ 应用背景 (Background) │
│ ┌─────────────────────┐ │
│ │ Surface (卡片) │ │ ← 有阴影、圆角
│ │ [内容] │ │
│ └─────────────────────┘ │
│ │
│ ┌─────────────────────┐ │
│ │ Surface (对话框) │ │
│ └─────────────────────┘ │
└─────────────────────────────┘
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="2-compose中的surface组件">2. Compose中的Surface组件
&lt;/h4>&lt;h5 id="surface的作用">Surface的作用
&lt;/h5>&lt;p>Compose的&lt;code>Surface&lt;/code>是一个容器组件，提供：&lt;/p>
&lt;ul>
&lt;li>背景色&lt;/li>
&lt;li>形状（圆角、切角）&lt;/li>
&lt;li>边框&lt;/li>
&lt;li>阴影/高度&lt;/li>
&lt;li>点击效果&lt;/li>
&lt;/ul>
&lt;h5 id="基础用法">基础用法
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> androidx.compose.material3.Surface
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> androidx.compose.material3.MaterialTheme
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">@Composable&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">BasicSurface&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 最简单的 Surface
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Surface {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(&lt;span style="color:#e6db74">&amp;#34;Hello World&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 自定义属性
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Surface(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> modifier = Modifier
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .fillMaxWidth()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .padding(&lt;span style="color:#ae81ff">16.&lt;/span>dp),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> color = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.colorScheme.primaryContainer, &lt;span style="color:#75715e">// 背景色
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> contentColor = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.colorScheme.onPrimaryContainer, &lt;span style="color:#75715e">// 内容色
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> tonalElevation = &lt;span style="color:#ae81ff">2.&lt;/span>dp, &lt;span style="color:#75715e">// 高度（影响颜色深浅）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> shadowElevation = &lt;span style="color:#ae81ff">4.&lt;/span>dp, &lt;span style="color:#75715e">// 阴影高度
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> shape = RoundedCornerShape(&lt;span style="color:#ae81ff">12.&lt;/span>dp), &lt;span style="color:#75715e">// 形状
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> border = BorderStroke(&lt;span style="color:#ae81ff">1.&lt;/span>dp, &lt;span style="color:#a6e22e">Color&lt;/span>.Gray) &lt;span style="color:#75715e">// 边框
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> ) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Column(modifier = &lt;span style="color:#a6e22e">Modifier&lt;/span>.padding(&lt;span style="color:#ae81ff">16.&lt;/span>dp)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(&lt;span style="color:#e6db74">&amp;#34;标题&amp;#34;&lt;/span>, style = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.typography.titleLarge)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(&lt;span style="color:#e6db74">&amp;#34;内容&amp;#34;&lt;/span>, style = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.typography.bodyMedium)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="surface-vs-box-vs-card">Surface vs Box vs Card
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Box：纯布局容器，无样式
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>Box(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> modifier = Modifier
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .background(&lt;span style="color:#a6e22e">Color&lt;/span>.White) &lt;span style="color:#75715e">// 手动设置背景
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> .padding(&lt;span style="color:#ae81ff">16.&lt;/span>dp)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(&lt;span style="color:#e6db74">&amp;#34;Content&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Surface：有背景、形状、高度的容器
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>Surface(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> color = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.colorScheme.surface,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tonalElevation = &lt;span style="color:#ae81ff">2.&lt;/span>dp,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> shape = RoundedCornerShape(&lt;span style="color:#ae81ff">8.&lt;/span>dp)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(&lt;span style="color:#e6db74">&amp;#34;Content&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Card：预配置的 Surface（自带 padding、圆角、阴影）
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>Card(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> modifier = &lt;span style="color:#a6e22e">Modifier&lt;/span>.fillMaxWidth()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(&lt;span style="color:#e6db74">&amp;#34;Content&amp;#34;&lt;/span>, modifier = &lt;span style="color:#a6e22e">Modifier&lt;/span>.padding(&lt;span style="color:#ae81ff">16.&lt;/span>dp))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h6 id="选择建议">选择建议
&lt;/h6>&lt;ul>
&lt;li>需要自定义形状/阴影 → &lt;code>Surface&lt;/code>&lt;/li>
&lt;li>卡片样式 → &lt;code>Card&lt;/code>（本质是预设好的Surface）&lt;/li>
&lt;li>纯布局 → &lt;code>Box&lt;/code>&lt;/li>
&lt;/ul>
&lt;h5 id="实战卡片列表">实战：卡片列表
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">@Composable&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">ProductCard&lt;/span>(product: Product) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Surface(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> modifier = Modifier
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .fillMaxWidth()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .padding(horizontal = &lt;span style="color:#ae81ff">16.&lt;/span>dp, vertical = &lt;span style="color:#ae81ff">8.&lt;/span>dp),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> shape = RoundedCornerShape(&lt;span style="color:#ae81ff">16.&lt;/span>dp),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> color = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.colorScheme.surface,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tonalElevation = &lt;span style="color:#ae81ff">2.&lt;/span>dp,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> shadowElevation = &lt;span style="color:#ae81ff">4.&lt;/span>dp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Row(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> modifier = &lt;span style="color:#a6e22e">Modifier&lt;/span>.padding(&lt;span style="color:#ae81ff">16.&lt;/span>dp),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> horizontalArrangement = &lt;span style="color:#a6e22e">Arrangement&lt;/span>.spacedBy(&lt;span style="color:#ae81ff">16.&lt;/span>dp)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 产品图片
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Surface(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> shape = RoundedCornerShape(&lt;span style="color:#ae81ff">8.&lt;/span>dp),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> modifier = &lt;span style="color:#a6e22e">Modifier&lt;/span>.size(&lt;span style="color:#ae81ff">80.&lt;/span>dp)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> AsyncImage(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> model = product.imageUrl,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> contentDescription = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 产品信息
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Column(modifier = &lt;span style="color:#a6e22e">Modifier&lt;/span>.weight(&lt;span style="color:#ae81ff">1f&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> text = product.name,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> style = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.typography.titleMedium
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> text = product.description,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> style = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.typography.bodySmall,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> color = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.colorScheme.onSurfaceVariant
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> text = &lt;span style="color:#e6db74">&amp;#34;$&lt;/span>&lt;span style="color:#e6db74">${product.price}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> style = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.typography.titleLarge,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> color = &lt;span style="color:#a6e22e">MaterialTheme&lt;/span>.colorScheme.primary
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="3-传统view中的surface">3. 传统View中的Surface
&lt;/h4>&lt;h5 id="materialcardview常用">MaterialCardView(常用)
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&amp;lt;!-- res/layout/item_card.xml --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;com.google.android.material.card.MaterialCardView&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:layout_width=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;match_parent&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:layout_height=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;wrap_content&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">app:cardBackgroundColor=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;?attr/colorSurface&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">app:cardElevation=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;4dp&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">app:cardCornerRadius=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;12dp&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">app:strokeColor=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;?attr/colorOutline&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">app:strokeWidth=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;1dp&amp;#34;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;LinearLayout&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:layout_width=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;match_parent&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:layout_height=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;wrap_content&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:orientation=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;vertical&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:padding=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;16dp&amp;#34;&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;TextView&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:layout_width=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;wrap_content&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:layout_height=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;wrap_content&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:text=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;标题&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:textColor=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;?attr/colorOnSurface&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:textAppearance=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;?attr/textAppearanceTitleMedium&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;TextView&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:layout_width=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;wrap_content&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:layout_height=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;wrap_content&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:layout_marginTop=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;8dp&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:text=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;内容&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:textColor=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;?attr/colorOnSurfaceVariant&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">android:textAppearance=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;?attr/textAppearanceBodyMedium&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;lt;/LinearLayout&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;/com.google.android.material.card.MaterialCardView&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="对话框dialogfragment">对话框（DialogFragment）
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MyDialogFragment&lt;/span> : DialogFragment() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreateDialog&lt;/span>(savedInstanceState: Bundle?): Dialog {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> MaterialAlertDialogBuilder(requireContext())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .setTitle(&lt;span style="color:#e6db74">&amp;#34;标题&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .setMessage(&lt;span style="color:#e6db74">&amp;#34;消息内容&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .setPositiveButton(&lt;span style="color:#e6db74">&amp;#34;确定&amp;#34;&lt;/span>) { _, _ &lt;span style="color:#f92672">-&amp;gt;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .setNegativeButton(&lt;span style="color:#e6db74">&amp;#34;取消&amp;#34;&lt;/span>) { _, _ &lt;span style="color:#f92672">-&amp;gt;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .create()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 对话框自动使用 ?attr/colorSurface 作为背景
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="4-底层surfacesurfaceview--textureview">4. 底层Surface（SurfaceView / TextureView）
&lt;/h4>&lt;h5 id="什么时候用">什么时候用
&lt;/h5>&lt;ul>
&lt;li>&lt;strong>View&lt;/strong>
&lt;ul>
&lt;li>普通UI&lt;/li>
&lt;li>性能一般&lt;/li>
&lt;li>主线程绘制&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>SurfaceView&lt;/strong>
&lt;ul>
&lt;li>视频播放、相机预览&lt;/li>
&lt;li>性能高&lt;/li>
&lt;li>独立Surface，后台线程绘制&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>TextureView&lt;/strong>
&lt;ul>
&lt;li>需要动画/变换的视频&lt;/li>
&lt;li>性能中等&lt;/li>
&lt;li>可以做动画，但性能较低&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h5 id="surfaceview示例">SurfaceView示例
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">VideoPlayerActivity&lt;/span> : AppCompatActivity() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">lateinit&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> surfaceView: SurfaceView
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> mediaPlayer: MediaPlayer? = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onCreate&lt;/span>(savedInstanceState: Bundle?) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>.onCreate(savedInstanceState)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> surfaceView = SurfaceView(&lt;span style="color:#66d9ef">this&lt;/span>).apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> layoutParams = &lt;span style="color:#a6e22e">ViewGroup&lt;/span>.LayoutParams(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">ViewGroup&lt;/span>.&lt;span style="color:#a6e22e">LayoutParams&lt;/span>.MATCH_PARENT,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">ViewGroup&lt;/span>.&lt;span style="color:#a6e22e">LayoutParams&lt;/span>.MATCH_PARENT
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setContentView(surfaceView)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 监听 Surface 创建
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> surfaceView.holder.addCallback(&lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">: &lt;/span>&lt;span style="color:#a6e22e">SurfaceHolder&lt;/span>.Callback {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">surfaceCreated&lt;/span>(holder: SurfaceHolder) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Surface 准备好了，开始播放
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> mediaPlayer = MediaPlayer().apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setDataSource(&lt;span style="color:#e6db74">&amp;#34;https://example.com/video.mp4&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setDisplay(holder)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> prepareAsync()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> setOnPreparedListener { start() }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">surfaceChanged&lt;/span>(holder: SurfaceHolder, format: Int, width: Int, height: Int) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Surface 大小改变
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">surfaceDestroyed&lt;/span>(holder: SurfaceHolder) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Surface 销毁，释放资源
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> mediaPlayer&lt;span style="color:#f92672">?.&lt;/span>release()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mediaPlayer = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> })
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="surfaceview-vs-textureview">SurfaceView vs TextureView
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// SurfaceView：性能最好，但不能做动画
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> surfaceView = SurfaceView(context)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ✅ 适合：视频播放、相机预览、游戏
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ❌ 不适合：需要透明度、旋转、缩放动画
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// TextureView：可以做动画，但性能较低
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> textureView = TextureView(context)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>textureView.alpha = &lt;span style="color:#ae81ff">0.5f&lt;/span> &lt;span style="color:#75715e">// ✅ 可以设置透明度
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>textureView.rotation = &lt;span style="color:#ae81ff">45f&lt;/span> &lt;span style="color:#75715e">// ✅ 可以旋转
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ✅ 适合：需要动画效果的视频
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ❌ 不适合：追求极致性能的场景
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="compose中使用surfaceview">Compose中使用SurfaceView
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">@Composable&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">VideoPlayer&lt;/span>(videoUrl: String) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> AndroidView(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> factory = { context &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SurfaceView(context).apply {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> holder.addCallback(&lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">: &lt;/span>&lt;span style="color:#a6e22e">SurfaceHolder&lt;/span>.Callback {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">surfaceCreated&lt;/span>(holder: SurfaceHolder) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 初始化视频播放器
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">surfaceChanged&lt;/span>(holder: SurfaceHolder, format: Int, width: Int, height: Int) {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">surfaceDestroyed&lt;/span>(holder: SurfaceHolder) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 清理资源
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> })
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> modifier = &lt;span style="color:#a6e22e">Modifier&lt;/span>.fillMaxSize()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="5-底层surface工作原理">5. 底层Surface工作原理
&lt;/h4>&lt;p>&lt;strong>Surface&lt;/strong>的本质&lt;/p>
&lt;pre tabindex="0">&lt;code>应用进程 系统进程
↓ ↓
Canvas.draw() SurfaceFlinger
↓ ↓
Surface ←─────共享内存───────→ Surface
↓ ↓
写入像素数据 读取像素数据
↓
合成到屏幕
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code>Surface = {
SharedBuffer (共享内存)
+ 元数据 (宽度、高度、格式、Z-order)
}
&lt;/code>&lt;/pre>&lt;p>关键点：&lt;/p>
&lt;ol>
&lt;li>每个Window有一个Surface&lt;/li>
&lt;li>SurfaceView会创建独立的Surface（不在主Window上）&lt;/li>
&lt;li>SurfaceFlinger负责合成所有Surface&lt;/li>
&lt;li>Surface通过共享内存传递数据，避免拷贝&lt;/li>
&lt;/ol>
&lt;h5 id="为什么surfaceview性能高">为什么SurfaceView性能高？
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>普通 View&lt;span style="color:#960050;background-color:#1e0010">：&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>主线程绘制 &lt;span style="color:#960050;background-color:#1e0010">→&lt;/span> 等待 VSync &lt;span style="color:#960050;background-color:#1e0010">→&lt;/span> 显示
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#960050;background-color:#1e0010">↑&lt;/span> 阻塞主线程
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SurfaceView&lt;span style="color:#960050;background-color:#1e0010">：&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>后台线程绘制 &lt;span style="color:#960050;background-color:#1e0010">→&lt;/span> 直接提交给 SurfaceFlinger &lt;span style="color:#960050;background-color:#1e0010">→&lt;/span> 显示
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>主线程继续处理 UI
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;strong>SurfaceFlinger&lt;/strong>: 系统合成器，合成所有应用的画面&lt;/li>
&lt;li>&lt;strong>Surface&lt;/strong>：共享内存，应用写入，系统读取&lt;/li>
&lt;li>&lt;strong>Window&lt;/strong>：窗口抽象，管理Surface和输入事件&lt;/li>
&lt;li>&lt;strong>Canvas&lt;/strong>：绘制API，提供画图方法&lt;/li>
&lt;/ul>
&lt;hr></description></item><item><title>Android项目组织结构</title><link>https://www.dust-zed.site/android-develop/android%E9%A1%B9%E7%9B%AE%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84/</link><pubDate>Fri, 17 Oct 2025 09:28:07 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/android%E9%A1%B9%E7%9B%AE%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84/</guid><description>&lt;h4 id="项目结构说明">项目结构说明
&lt;/h4>&lt;h5 id="完整目录结构">完整目录结构
&lt;/h5>&lt;pre tabindex="0">&lt;code>project/
├── gradle/
│ └── libs.versions.toml # Version Catalog
├── app/
│ ├── build.gradle.kts
│ └── src/
│ └── main/
│ ├── AndroidManifest.xml
│ ├── java/com/example/myapp/
│ │ └── MainActivity.kt
│ └── res/
├── build.gradle.kts # 根目录
├── settings.gradle.kts
└── gradle.properties
&lt;/code>&lt;/pre>&lt;h5 id="核心原则">核心原则
&lt;/h5>&lt;p>&lt;strong>必需库(2个)&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>&lt;code>androidx.core:core-ktx&lt;/code> - Kotlin扩展&lt;/li>
&lt;li>&lt;code>androidx.appcompat:appcompat&lt;/code> - 兼容性支持&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>UI方案(二选一)&lt;/strong>：&lt;/p>
&lt;ol>
&lt;li>传统View: Material + ConstraintLayout&lt;/li>
&lt;li>&lt;strong>Jetpack Compose&lt;/strong>: Compose BOM + Material3&lt;/li>
&lt;/ol>
&lt;p>可选扩展：&lt;/p>
&lt;ul>
&lt;li>架构组件：ViewModel/LiveData (MVVM模式需要)&lt;/li>
&lt;li>协程：异步操作 （网络操作、数据库操作需要）&lt;/li>
&lt;/ul>
&lt;h5 id="使用建议">使用建议
&lt;/h5>&lt;ol>
&lt;li>最小项目：只用 core-ktx + appcompat + 一种UI&lt;/li>
&lt;li>需要架构：添加lifecycle bundle&lt;/li>
&lt;li>需要网络/数据库：添加coroutines&lt;/li>
&lt;li>库 vs 插件
&lt;ul>
&lt;li>&lt;code>android.application&lt;/code> / &lt;code>kotlin.android&lt;/code> - 必需插件&lt;/li>
&lt;li>&lt;code>kotlin.compose&lt;/code> - 仅Compose项目需要的插件&lt;/li>
&lt;li>其他都是库依赖&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h5 id="常见误区">常见误区
&lt;/h5>&lt;p>不是必须的库&lt;/p>
&lt;ul>
&lt;li>Activity/Fragment库 （appcompat已包含）&lt;/li>
&lt;li>RecyclerView （除非确定要用列表）&lt;/li>
&lt;li>Navigation组件 （简单项目不需要）&lt;/li>
&lt;li>Room/Retrofit （有需求再加）&lt;/li>
&lt;/ul>
&lt;h4 id="libsversionstoml-例子">libs.versions.toml 例子
&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-toml" data-lang="toml">&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#a6e22e">versions&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 核心版本&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">agp&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;8.7.3&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">kotlin&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;2.1.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">compileSdk&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;35&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">minSdk&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;24&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">targetSdk&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;35&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># AndroidX 核心库（必需）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">core-ktx&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;1.15.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">appcompat&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;1.7.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 可选：UI 库（根据需要选择）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">material&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;1.12.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 注：Compose 和传统 View 二选一&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">compose-bom&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;2024.12.01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 或者使用 ConstraintLayout（传统 View）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">constraintlayout&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;2.2.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 可选：生命周期（如需 ViewModel/LiveData）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">lifecycle&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;2.8.7&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 可选：协程（如需异步操作）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">coroutines&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;1.10.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#a6e22e">libraries&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># === 核心库（必需）===&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidx-core-ktx&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.core:core-ktx&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;core-ktx&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidx-appcompat&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.appcompat:appcompat&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;appcompat&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># === UI 库（二选一或都不要）===&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 方案 A: Material Components（传统 View）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">material&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;com.google.android.material:material&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;material&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidx-constraintlayout&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.constraintlayout:constraintlayout&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;constraintlayout&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 方案 B: Jetpack Compose（现代声明式 UI）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidx-compose-bom&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.compose:compose-bom&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;compose-bom&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidx-compose-ui&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.compose.ui:ui&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidx-compose-material3&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.compose.material3:material3&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidx-compose-ui-tooling-preview&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.compose.ui:ui-tooling-preview&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidx-activity-compose&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.activity:activity-compose&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;1.9.3&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># === 可选：架构组件 ===&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># ViewModel（如需 MVVM 架构）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidx-lifecycle-viewmodel-ktx&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.lifecycle:lifecycle-viewmodel-ktx&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;lifecycle&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># LiveData（如需响应式数据，Compose 项目可不用）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidx-lifecycle-livedata-ktx&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.lifecycle:lifecycle-livedata-ktx&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;lifecycle&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># === 可选：协程（如需异步操作）===&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">kotlinx-coroutines-android&lt;/span> = { &lt;span style="color:#a6e22e">module&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;org.jetbrains.kotlinx:kotlinx-coroutines-android&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;coroutines&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#a6e22e">plugins&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 必需插件&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">android-application&lt;/span> = { &lt;span style="color:#a6e22e">id&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;com.android.application&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;agp&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">kotlin-android&lt;/span> = { &lt;span style="color:#a6e22e">id&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;org.jetbrains.kotlin.android&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;kotlin&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 可选：Compose 编译器插件（仅 Compose 项目需要）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">kotlin-compose&lt;/span> = { &lt;span style="color:#a6e22e">id&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;org.jetbrains.kotlin.plugin.compose&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;kotlin&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 可选：如需多模块或库模块&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">android-library&lt;/span> = { &lt;span style="color:#a6e22e">id&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;com.android.library&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;agp&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#a6e22e">bundles&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 可选：组合常用库&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 传统 View UI 套件&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">traditional-ui&lt;/span> = [&lt;span style="color:#e6db74">&amp;#34;androidx-core-ktx&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;androidx-appcompat&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;material&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;androidx-constraintlayout&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Compose UI 套件&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">compose-ui&lt;/span> = [&lt;span style="color:#e6db74">&amp;#34;androidx-compose-ui&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;androidx-compose-material3&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;androidx-compose-ui-tooling-preview&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;androidx-activity-compose&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># MVVM 架构套件&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">lifecycle&lt;/span> = [&lt;span style="color:#e6db74">&amp;#34;androidx-lifecycle-viewmodel-ktx&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;androidx-lifecycle-livedata-ktx&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="疑问解答">疑问解答
&lt;/h4>&lt;h5 id="为什么项目级要用apply-false">为什么项目级要用&lt;code>apply false&lt;/code>？
&lt;/h5>&lt;p>在项目根目录的&lt;code>build.gradle.kts&lt;/code>中使用&lt;code>apply false&lt;/code>是为了：&lt;/p>
&lt;ol>
&lt;li>声明插件版本，但不应用到根项目&lt;/li>
&lt;li>让子模块可以复用这些插件定义&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ❌ 项目根目录如果不加 apply false
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>plugins {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> alias(libs.plugins.android.application) &lt;span style="color:#75715e">// 会应用到根项目
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 问题：根项目不是 Android 应用，会报错！
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ✅ 正确做法
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>plugins {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> alias(libs.plugins.android.application) apply &lt;span style="color:#66d9ef">false&lt;/span> &lt;span style="color:#75715e">// 只声明，不应用
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>类比理解&lt;/strong>&lt;/p>
&lt;p>把根项目想象成插件仓库：&lt;/p>
&lt;ul>
&lt;li>&lt;code>apply false&lt;/code> = 把插件放在仓库货架上&lt;/li>
&lt;li>子模块&lt;code>alias()&lt;/code> = 从货架取用插件&lt;/li>
&lt;li>货架管理员（根项目）不需要用这些工具（插件）&lt;/li>
&lt;/ul></description></item><item><title>Rust Jni配置</title><link>https://www.dust-zed.site/android-develop/rust-jni%E9%85%8D%E7%BD%AE/</link><pubDate>Wed, 15 Oct 2025 13:45:38 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/rust-jni%E9%85%8D%E7%BD%AE/</guid><description>&lt;h4 id="环境配置">环境配置
&lt;/h4>&lt;h5 id="1-环境检查">1. 环境检查
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 检查 Rust 是否安装&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rustc --version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 应该看到: rustc 1.xx.x&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 检查 Cargo&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cargo --version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 检查 Android Studio 和 SDK&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 确保已安装 Android Studio&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2-安装必要工具">2. 安装必要工具
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 1. 安装 Android targets&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rustup target add aarch64-linux-android &lt;span style="color:#75715e"># ARM64&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rustup target add armv7-linux-androideabi &lt;span style="color:#75715e"># ARM32&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rustup target add i686-linux-android &lt;span style="color:#75715e"># x86&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rustup target add x86_64-linux-android &lt;span style="color:#75715e"># x86_64&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 2. 安装 cargo-ndk (重要!)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cargo install cargo-ndk
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 3. 验证安装&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cargo ndk --version
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="配置ndk路径">配置NDK路径
&lt;/h5>&lt;p>&lt;strong>macOS/Linux&lt;/strong>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 编辑 ~/.bashrc 或 ~/.zshrc&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export ANDROID_HOME&lt;span style="color:#f92672">=&lt;/span>$HOME/Library/Android/sdk &lt;span style="color:#75715e"># macOS&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 或&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export ANDROID_HOME&lt;span style="color:#f92672">=&lt;/span>$HOME/Android/Sdk &lt;span style="color:#75715e"># Linux&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export ANDROID_NDK_HOME&lt;span style="color:#f92672">=&lt;/span>$ANDROID_HOME/ndk/25.2.9519653
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 注意: 版本号可能不同,检查你的 ndk 目录&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 应用配置&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>source ~/.bashrc &lt;span style="color:#75715e"># 或 source ~/.zshrc&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>Windows&lt;/strong>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 设置环境变量&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>setx ANDROID_HOME &lt;span style="color:#e6db74">&amp;#34;C:\Users\YourName\AppData\Local\Android\Sdk&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>setx ANDROID_NDK_HOME &lt;span style="color:#e6db74">&amp;#34;%ANDROID_HOME%\ndk\25.2.9519653&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="验证ndk">验证NDK:
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>echo $ANDROID_NDK_HOME
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 应该显示路径,如: /Users/xxx/Library/Android/sdk/ndk/25.2.9519653&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ls $ANDROID_NDK_HOME
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 应该看到: build, platforms, sources 等目录&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Android_rust混合开发入门</title><link>https://www.dust-zed.site/android-develop/android_rust%E6%B7%B7%E5%90%88%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/</link><pubDate>Wed, 15 Oct 2025 11:55:59 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/android_rust%E6%B7%B7%E5%90%88%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/</guid><description>&lt;h4 id="什么是ndk">什么是NDK?
&lt;/h4>&lt;p>&lt;strong>NDK = Native Development Kit(原生开发工具包)&lt;/strong>&lt;/p>
&lt;p>&lt;strong>一句话解释&lt;/strong>&lt;/p>
&lt;p>NDK 是 Android 提供的工具集,让你能用 &lt;strong>C/C++/Rust&lt;/strong> 等原生语言开发 Android 应用的一部分&lt;/p>
&lt;hr>
&lt;h4 id="android应用的两种开发方式">Android应用的两种开发方式
&lt;/h4>&lt;pre tabindex="0">&lt;code>┌─────────────────────────────────────────┐
│ Android 应用 │
├─────────────────────────────────────────┤
│ │
│ 方式 1: Java/Kotlin (Android SDK) │
│ ┌──────────────────────────────────┐ │
│ │ Kotlin/Java 代码 │ │
│ │ ↓ │ │
│ │ 编译为 DEX 字节码 │ │
│ │ ↓ │ │
│ │ 在 Dalvik/ART 虚拟机运行 │ │
│ └──────────────────────────────────┘ │
│ │
│ 方式 2: C/C++/Rust (Android NDK) │
│ ┌──────────────────────────────────┐ │
│ │ C/C++/Rust 代码 │ │
│ │ ↓ │ │
│ │ 编译为 .so 文件 (机器码) │ │
│ │ ↓ │ │
│ │ 直接在 CPU 上运行 (无虚拟机) │ │
│ └──────────────────────────────────┘ │
│ │
│ 两者通过 JNI 桥接 │
└─────────────────────────────────────────┘
&lt;/code>&lt;/pre>&lt;h4 id="为什么需要ndk">为什么需要NDK？
&lt;/h4>&lt;h5 id="对比理解">对比理解
&lt;/h5>&lt;p>纯 &lt;strong>Java/Kotlin(SDK):&lt;/strong>&lt;/p>
&lt;pre tabindex="0">&lt;code>优点:
✅ 开发简单
✅ 跨设备兼容好
✅ 调试方便
缺点:
❌ 性能有限 (虚拟机开销)
❌ 某些功能无法实现
❌ 无法复用 C/C++ 库
&lt;/code>&lt;/pre>&lt;p>&lt;strong>NDK(C/C++/Rust)&lt;/strong>&lt;/p>
&lt;pre tabindex="0">&lt;code>优点:
✅ 性能极高 (接近机器码)
✅ 可以复用现有 C/C++ 库
✅ 直接访问硬件
✅ 跨平台代码复用
缺点:
❌ 开发复杂
❌ 调试困难
❌ 需要为不同 CPU 编译
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="ndk工作原理">NDK工作原理
&lt;/h4>&lt;h5 id="完整流程">完整流程
&lt;/h5>&lt;pre tabindex="0">&lt;code>第 1 步: 写 Rust 代码
┌────────────────────────┐
│ // Rust 代码 │
│ pub fn add(a: i32, b: i32) -&amp;gt; i32 {
│ a + b │
│ } │
└────────────────────────┘
↓
第 2 步: NDK 编译
┌────────────────────────┐
│ NDK 工具链编译 │
│ - 交叉编译 │
│ - 针对 ARM/x86 CPU │
└────────────────────────┘
↓
第 3 步: 生成 .so 文件
┌────────────────────────┐
│ librust_lib.so │
│ (机器码,可直接运行) │
└────────────────────────┘
↓
第 4 步: Android 加载
┌────────────────────────┐
│ System.loadLibrary(&amp;#34;rust_lib&amp;#34;)
│ │
│ external fun add(a: Int, b: Int): Int
└────────────────────────┘
↓
第 5 步: JNI 调用
┌────────────────────────┐
│ Kotlin → JNI → Rust │
│ val result = add(5, 3) │
│ // result = 8 │
└────────────────────────┘
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="ndk包含什么">NDK包含什么？
&lt;/h4>&lt;h5 id="ndk工具集">NDK工具集
&lt;/h5>&lt;pre tabindex="0">&lt;code>$ANDROID_NDK_HOME/
├── build/ # 构建脚本
├── toolchains/ # 编译器工具链
│ ├── aarch64-linux-android/ # ARM64 编译器
│ ├── arm-linux-androideabi/ # ARM32 编译器
│ ├── x86/ # x86 编译器
│ └── x86_64/ # x86_64 编译器
├── platforms/ # Android API 级别的头文件
├── sources/ # 示例代码
└── sysroot/ # 系统库
&lt;/code>&lt;/pre>&lt;h5 id="编译器">编译器
&lt;/h5>&lt;pre tabindex="0">&lt;code>NDK 提供了针对不同 CPU 架构的编译器:
ARM64 (arm64-v8a): 现代手机 (主流)
ARM32 (armeabi-v7a): 老手机
x86: 模拟器
x86_64: 模拟器
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="so文件是什么">.so文件是什么？
&lt;/h4>&lt;h5 id="理解so文件">理解.so文件
&lt;/h5>&lt;pre tabindex="0">&lt;code>.so = Shared Object (共享对象)
类似于:
- Windows 的 .dll 文件
- macOS 的 .dylib 文件
作用:
- 包含编译后的机器码
- 可以被多个程序共享使用
&lt;/code>&lt;/pre>&lt;h5 id="so文件示例">.so文件示例
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 查看 .so 文件&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ls android/app/src/main/jniLibs/arm64-v8a/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># librust_lib.so ← 这就是编译后的 Rust 代码&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 查看文件信息&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>file librust_lib.so
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># librust_lib.so: ELF 64-bit LSB shared object, ARM aarch64, ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 查看导出的函数&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>nm -D librust_lib.so | grep Java
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Java_com_example_rustdemo_RustBridge_add&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Java_com_example_rustdemo_RustBridge_reverseString&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="ndk开发流程">NDK开发流程
&lt;/h4>&lt;h5 id="完整开发流程">完整开发流程
&lt;/h5>&lt;pre tabindex="0">&lt;code>1. 安装 NDK
↓
Android Studio → SDK Manager → SDK Tools → NDK
2. 配置环境
↓
export ANDROID_NDK_HOME=/path/to/ndk
3. 编写原生代码 (C/C++/Rust)
↓
例如: add.c, image.cpp, search.rs
4. 使用 NDK 编译
↓
ndk-build (C/C++)
cargo-ndk (Rust)
5. 生成 .so 文件
↓
libmylib.so
6. 放入 jniLibs 目录
↓
app/src/main/jniLibs/arm64-v8a/libmylib.so
7. Kotlin 加载和调用
↓
System.loadLibrary(&amp;#34;mylib&amp;#34;)
external fun add(a: Int, b: Int): Int
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="ndk核心概念">NDK核心概念
&lt;/h4>&lt;h5 id="jnijava-native-interface">JNI(Java Native Interface)
&lt;/h5>&lt;p>&lt;strong>JNI&lt;/strong>是桥梁:&lt;/p>
&lt;pre tabindex="0">&lt;code>┌──────────────┐ ┌──────────────┐
│ Kotlin │ JNI │ Rust │
│ (虚拟机) │ ◄─────► │ (原生码) │
└──────────────┘ └──────────────┘
数据传递:
Kotlin Int ↔ Rust i32
Kotlin String ↔ Rust String
Kotlin IntArray ↔ Rust &amp;amp;[i32]
&lt;/code>&lt;/pre>&lt;h5 id="交叉编译">交叉编译
&lt;/h5>&lt;p>什么是交叉编译?&lt;/p>
&lt;pre tabindex="0">&lt;code>你在 x86_64 电脑上开发
↓
但手机是 ARM64 架构
↓
需要&amp;#34;交叉编译&amp;#34;: 在 x86_64 上编译出 ARM64 代码
↓
NDK 提供了交叉编译工具链
&lt;/code>&lt;/pre>&lt;h5 id="abiapplication-binary-interface">ABI(Application Binary Interface)
&lt;/h5>&lt;p>不同&lt;strong>CPU&lt;/strong>需要不同的**.so**文件:&lt;/p>
&lt;pre tabindex="0">&lt;code>arm64-v8a/libmylib.so → ARM64 手机
armeabi-v7a/libmylib.so → ARM32 手机
x86/libmylib.so → x86 模拟器
x86_64/libmylib.so → x86_64 模拟器
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="什么时候用ndk">什么时候用NDK?
&lt;/h4>&lt;h5 id="应该用ndk的场景">应该用NDK的场景
&lt;/h5>&lt;pre tabindex="0">&lt;code>1. 性能关键代码
- 图像/视频处理
- 音频处理
- 大量数学计算
- 加密/解密
2. 复用现有代码
- 已有 C/C++ 库
- 跨平台代码 (iOS/Android 共享)
3. 保护核心算法
- 防止反编译
- 商业逻辑保护
4. 访问底层功能
- 硬件控制
- 系统调用
&lt;/code>&lt;/pre>&lt;h5 id="不应该用ndk的场景">不应该用NDK的场景
&lt;/h5>&lt;pre tabindex="0">&lt;code>1. 简单业务逻辑
- 按钮点击
- 数据展示
- 网络请求
2. 快速开发
- 原型验证
- MVP 阶段
3. 团队不熟悉 C/C++/Rust
- 维护成本高
- Bug 难以调试
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="ndk开发工具">NDK开发工具
&lt;/h4>&lt;h5 id="必备工具">必备工具
&lt;/h5>&lt;pre tabindex="0">&lt;code>1. Android NDK
- 下载: Android Studio SDK Manager
2. CMake (C/C++) 或 cargo-ndk (Rust)
- cargo install cargo-ndk
3. LLDB (调试器)
- Android Studio 内置
&lt;/code>&lt;/pre>&lt;h5 id="辅助工具">辅助工具
&lt;/h5>&lt;pre tabindex="0">&lt;code># 查看 .so 文件信息
readelf -h libmylib.so
# 查看导出的函数
nm -D libmylib.so
# 反汇编 (调试用)
objdump -d libmylib.so
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="总结">总结
&lt;/h4>&lt;h5 id="ndk是什么">NDK是什么？
&lt;/h5>&lt;pre tabindex="0">&lt;code>NDK = 让你用 C/C++/Rust 开发 Android 的工具包
作用:
1. 提供交叉编译工具链
2. 编译出 .so 机器码文件
3. 通过 JNI 与 Kotlin 交互
4. 获得原生性能
适用场景:
- 高性能计算
- 复用 C/C++ 库
- 跨平台开发
&lt;/code>&lt;/pre>&lt;h5 id="关键概念">关键概念
&lt;/h5>&lt;pre tabindex="0">&lt;code>NDK: 工具包
JNI: 桥梁 (Kotlin ↔ 原生代码)
.so: 编译后的机器码
ABI: 不同 CPU 架构
流程:
Rust 代码 → NDK 编译 → .so 文件 → JNI 调用 → Kotlin 使用
&lt;/code>&lt;/pre></description></item><item><title>Android事件分发机制详解</title><link>https://www.dust-zed.site/android-develop/android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/</link><pubDate>Tue, 02 Sep 2025 21:41:39 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/</guid><description>&lt;h4 id="1-事件分发的基本流程">1. 事件分发的基本流程
&lt;/h4>&lt;h5 id="11-事件传递顺序">1.1 事件传递顺序
&lt;/h5>&lt;p>事件从Activity开始，按照一下顺序传递：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-rust" data-lang="rust">&lt;span style="display:flex;">&lt;span>Activity -&amp;gt; &lt;span style="color:#a6e22e">Window&lt;/span> -&amp;gt; &lt;span style="color:#a6e22e">DecorView&lt;/span> -&amp;gt; &lt;span style="color:#a6e22e">ViewGroup&lt;/span> -&amp;gt; &lt;span style="color:#a6e22e">View&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="12-核心方法">1.2 核心方法
&lt;/h5>&lt;ol>
&lt;li>&lt;strong>dispatchTouchEvent&lt;/strong>
&lt;ul>
&lt;li>负责事件的分发&lt;/li>
&lt;li>返回true表示事件被消费，false表示未消费&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>onInterceptTouchEvent&lt;/strong>
&lt;ul>
&lt;li>只有ViewGroup才有的方法&lt;/li>
&lt;li>用于拦截事件，返回true表示拦截事件&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>onTouchEvent&lt;/strong>
&lt;ul>
&lt;li>处理点击事件&lt;/li>
&lt;li>返回true表示事件被消费&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h4 id="2-源码分析">2. 源码分析
&lt;/h4>&lt;h5 id="21-activity的dispatchtouchevent">2.1 Activity的dispatchTouchEvent
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">dispatchTouchEvent&lt;/span>(MotionEvent ev) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (ev.&lt;span style="color:#a6e22e">getAction&lt;/span>() &lt;span style="color:#f92672">==&lt;/span> MotionEvent.&lt;span style="color:#a6e22e">ACTION_DOWN&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> onUserInteraction(); &lt;span style="color:#75715e">// 空方法，可以重写&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (getWindow().&lt;span style="color:#a6e22e">superDispatchTouchEvent&lt;/span>(ev)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>; &lt;span style="color:#75715e">// 事件被消费&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> onTouchEvent(ev); &lt;span style="color:#75715e">// 如果所有View都没有处理，则调用Activity的onTouchEvent&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="22-viewgroup的dispatchtouchevent">2.2 ViewGroup的dispatchTouchEvent
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">dispatchTouchEvent&lt;/span>(MotionEvent ev) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 检查是否拦截&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> intercepted;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (actionMasked &lt;span style="color:#f92672">==&lt;/span> MotionEvent.&lt;span style="color:#a6e22e">ACTION_DOWN&lt;/span> &lt;span style="color:#f92672">||&lt;/span> mFirstTouchTarget &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> disallowIntercept &lt;span style="color:#f92672">=&lt;/span> (mGroupFlags &lt;span style="color:#f92672">&amp;amp;&lt;/span> FLAG_DISALLOW_INTERCEPT) &lt;span style="color:#f92672">!=&lt;/span> 0;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>disallowIntercept) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intercepted &lt;span style="color:#f92672">=&lt;/span> onInterceptTouchEvent(ev);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ev.&lt;span style="color:#a6e22e">setAction&lt;/span>(action); &lt;span style="color:#75715e">// 恢复action，防止被修改&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intercepted &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 没有目标处理该事件，也不拦截&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intercepted &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. 如果不拦截，则寻找可以处理事件的子View&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>canceled &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#f92672">!&lt;/span>intercepted) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 遍历子View，寻找可以处理事件的View&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> childrenCount &lt;span style="color:#f92672">-&lt;/span> 1; i &lt;span style="color:#f92672">&amp;gt;=&lt;/span> 0; i&lt;span style="color:#f92672">--&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">final&lt;/span> View child &lt;span style="color:#f92672">=&lt;/span> children&lt;span style="color:#f92672">[&lt;/span>i&lt;span style="color:#f92672">]&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (child.&lt;span style="color:#a6e22e">dispatchTouchEvent&lt;/span>(ev)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 找到可以处理事件的子View&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mFirstTouchTarget &lt;span style="color:#f92672">=&lt;/span> addTouchTarget(child, idBitsToAssign);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 3. 分发事件&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (mFirstTouchTarget &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 没有子View处理事件，调用父类的dispatchTouchEvent&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> handled &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">super&lt;/span>.&lt;span style="color:#a6e22e">dispatchTouchEvent&lt;/span>(ev);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 将事件分发给目标View&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TouchTarget target &lt;span style="color:#f92672">=&lt;/span> mFirstTouchTarget;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (target &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">final&lt;/span> View child &lt;span style="color:#f92672">=&lt;/span> target.&lt;span style="color:#a6e22e">child&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (child.&lt;span style="color:#a6e22e">dispatchTouchEvent&lt;/span>(ev)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> handled &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> target &lt;span style="color:#f92672">=&lt;/span> target.&lt;span style="color:#a6e22e">next&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> handled;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h6 id="实际执行流程">实际执行流程
&lt;/h6>&lt;ol>
&lt;li>&lt;strong>DOWN事件&lt;/strong>:
&lt;ul>
&lt;li>&lt;code>mFirstTouchTarget == null&lt;/code>，进入寻找目标View的循环&lt;/li>
&lt;li>调用&lt;code>child.dispatchTouchEvent(ev)&lt;/code>（第一次）&lt;/li>
&lt;li>如果某个子View返回true，设置&lt;code>mFirstTouchTarget&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>MOVE/UP事件&lt;/strong>:
&lt;ul>
&lt;li>&lt;code>mFirstTouchTarget != null&lt;/code>，直接进入分发流程&lt;/li>
&lt;li>调用&lt;code>target.child.dispatchTouchEvent(ev)&lt;/code>（第二次）&lt;/li>
&lt;li>不会再次进入寻找目标View的循环&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>TouchTarget&lt;/strong>
&lt;ul>
&lt;li>TouchTarget是链表结构主要目的是为了支持多点触控&lt;/li>
&lt;li>从 &lt;code>mFirstTouchTarget&lt;/code> 开始遍历链表&lt;/li>
&lt;li>检查每个 &lt;code>TouchTarget&lt;/code> 的 &lt;code>pointerIdBits&lt;/code> 是否与当前事件的 &lt;code>desiredPointerIdBits&lt;/code> 匹配&lt;/li>
&lt;li>如果找到匹配的 &lt;code>TouchTarget&lt;/code>，则将事件分发给对应的子View&lt;/li>
&lt;li>如果没有找到匹配的 &lt;code>TouchTarget&lt;/code>，则返回false&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h6 id="为什么这样设计">为什么这样设计
&lt;/h6>&lt;ol>
&lt;li>&lt;strong>性能优化&lt;/strong>：避免每次事件都遍历所有子View&lt;/li>
&lt;li>&lt;strong>事件一致性&lt;/strong>：确保同一事件序列由同一View处理&lt;/li>
&lt;li>&lt;strong>正确性&lt;/strong>：防止事件序列被拆分到不同View处理&lt;/li>
&lt;/ol>
&lt;h5 id="23-view的dispatchtouchevent">2.3 View的dispatchTouchEvent
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">dispatchTouchEvent&lt;/span>(MotionEvent event) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 首先检查OnTouchListener&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ListenerInfo li &lt;span style="color:#f92672">=&lt;/span> mListenerInfo;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (li &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> li.&lt;span style="color:#a6e22e">mOnTouchListener&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> (mViewFlags &lt;span style="color:#f92672">&amp;amp;&lt;/span> ENABLED_MASK) &lt;span style="color:#f92672">==&lt;/span> ENABLED
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> li.&lt;span style="color:#a6e22e">mOnTouchListener&lt;/span>.&lt;span style="color:#a6e22e">onTouch&lt;/span>(&lt;span style="color:#66d9ef">this&lt;/span>, event)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. 然后调用onTouchEvent&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (onTouchEvent(event)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-事件分发的关键点">3. 事件分发的关键点
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>事件序列&lt;/strong>：从ACTION_DOWN开始，到ACTION_UP或ACTION_CANCEL结束的一些列事件&lt;/li>
&lt;li>&lt;strong>事件拦截&lt;/strong>：ViewGroup可以通过onIterceptTouchEvent拦截事件&lt;/li>
&lt;li>&lt;strong>事件消费&lt;/strong>：View可以通过onTouchEvent或OnTouchListener消费事件&lt;/li>
&lt;li>&lt;strong>事件传递&lt;/strong>：默认情况下，事件会从上到下传递，直到被消费&lt;/li>
&lt;/ol>
&lt;h4 id="4-常见面试题">4. 常见面试题
&lt;/h4>&lt;h5 id="41-事件分发的流程是怎样的">4.1 事件分发的流程是怎样的
&lt;/h5>&lt;ul>
&lt;li>从Activity的dispatchTouchEvent开始&lt;/li>
&lt;li>经过Window、DecorView、ViewGroup&lt;/li>
&lt;li>最终到达具体的View&lt;/li>
&lt;li>如果没有任何View消费事件，事件会回传到Activity的onTouchEvent&lt;/li>
&lt;/ul>
&lt;h5 id="42-ontouch和ontouchevent的区别">4.2 onTouch和onTouchEvent的区别
&lt;/h5>&lt;ul>
&lt;li>onTouch是View.OnTouchListener接口中的方法&lt;/li>
&lt;li>onTouchEvent是View的方法&lt;/li>
&lt;li>onTouch的优先级高于onTouchEvent&lt;/li>
&lt;li>如果onTouch返回true，则onTouch不会被调用&lt;/li>
&lt;/ul>
&lt;h5 id="43-如何解决滑动冲突">4.3 如何解决滑动冲突
&lt;/h5>&lt;ol>
&lt;li>外部拦截法：重写父容器的onInterceptTouchEvent方法&lt;/li>
&lt;li>内部拦截法： 重写子元素的dispatchTouchEvent方法，结合requestDisallowInterceptTouchEvent方法&lt;/li>
&lt;/ol>
&lt;h4 id="5-实际应用示例">5. 实际应用示例
&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 自定义ViewGroup，处理左右滑动冲突&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">CustomViewPager&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> ViewGroup {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">float&lt;/span> mLastX;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">float&lt;/span> mLastY;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> &lt;span style="color:#a6e22e">onInterceptTouchEvent&lt;/span>(MotionEvent ev) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">boolean&lt;/span> intercepted &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">float&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> ev.&lt;span style="color:#a6e22e">getX&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">float&lt;/span> y &lt;span style="color:#f92672">=&lt;/span> ev.&lt;span style="color:#a6e22e">getY&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> (ev.&lt;span style="color:#a6e22e">getAction&lt;/span>()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> MotionEvent.&lt;span style="color:#a6e22e">ACTION_DOWN&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mLastX &lt;span style="color:#f92672">=&lt;/span> x;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mLastY &lt;span style="color:#f92672">=&lt;/span> y;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intercepted &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> MotionEvent.&lt;span style="color:#a6e22e">ACTION_MOVE&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">float&lt;/span> deltaX &lt;span style="color:#f92672">=&lt;/span> Math.&lt;span style="color:#a6e22e">abs&lt;/span>(x &lt;span style="color:#f92672">-&lt;/span> mLastX);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">float&lt;/span> deltaY &lt;span style="color:#f92672">=&lt;/span> Math.&lt;span style="color:#a6e22e">abs&lt;/span>(y &lt;span style="color:#f92672">-&lt;/span> mLastY);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 横向滑动距离大于纵向滑动距离时拦截事件&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (deltaX &lt;span style="color:#f92672">&amp;gt;&lt;/span> deltaY) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intercepted &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intercepted &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> MotionEvent.&lt;span style="color:#a6e22e">ACTION_UP&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> intercepted &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mLastX &lt;span style="color:#f92672">=&lt;/span> x;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mLastY &lt;span style="color:#f92672">=&lt;/span> y;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> intercepted;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>协程知识点</title><link>https://www.dust-zed.site/android-develop/%E5%8D%8F%E7%A8%8B%E7%9F%A5%E8%AF%86%E7%82%B9/</link><pubDate>Mon, 30 Jun 2025 19:02:22 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/%E5%8D%8F%E7%A8%8B%E7%9F%A5%E8%AF%86%E7%82%B9/</guid><description>&lt;h4 id="将回调转换为协程">将回调转换为协程
&lt;/h4>&lt;p>&lt;strong>背景&lt;/strong>：很多库（尤其是Java/Android遗留库）使用基于回调（Callback）的API处理异步操作（如网络请求，数据库操作）。这在代码中会导致回调地狱。我们需要一种方法将这种回调风格的API转换成&lt;code>挂起函数(suspend fun)&lt;/code>，使其可以在协程中像&lt;strong>顺序代码&lt;/strong>一样使用。&lt;/p>
&lt;p>&lt;strong>核心函数：&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>&lt;strong>&lt;code>suspendCoroutine&lt;/code>(简单转换，无内置取消支持)&lt;/strong>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">suspend&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &amp;lt;&lt;span style="color:#a6e22e">T&lt;/span>&amp;gt; &lt;span style="color:#a6e22e">convertCallbackToSuspendingFunc&lt;/span>(): T = suspendCoroutine {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> continuation &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//1. 启动异步操作
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> callback = &lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">: &lt;/span>&lt;span style="color:#a6e22e">Callback&lt;/span>&amp;lt;T&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onSuccess&lt;/span>(result: T) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//2. 成功时恢复协程，传递结果
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> continuation.resume(result)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onFailure&lt;/span>(error: Throwable) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//3. 失败时恢复协程，传递异常
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> continuation.resumeWithException(error)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> someAsyncOperation(callback)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>continuation: 表示当前被挂起的协程。它提供了恢复协程的方法：resume(value)和resumeWithException(exception)。&lt;/li>
&lt;li>缺点：如果调用这个suspend fun 的协程被取消。someAsyncOperation不会自动终止。这可能导致资源浪费或意外结果。只适用于异步操作本身非常快或你不关心取消的情况。&lt;/li>
&lt;/ul>
&lt;ol start="2">
&lt;li>&lt;strong>&lt;code>suspendCancellableCoroutine&lt;/code>(支持取消)&lt;/strong>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">suspend&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &amp;lt;&lt;span style="color:#a6e22e">T&lt;/span>&amp;gt; &lt;span style="color:#a6e22e">convertCallbackToSuspendingFuncSafely&lt;/span>(): T = suspendCancellableCoroutine { cancellableContinuation &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 启动异步操作
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> callback = &lt;span style="color:#66d9ef">object&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">: &lt;/span>&lt;span style="color:#a6e22e">Callback&lt;/span>&amp;lt;T&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onSuccess&lt;/span>(result: T) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cancellableContinuation.resume(result)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">onFailure&lt;/span>(error: Throwable) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cancellableContinuation.resumeWithException(error)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> someAsyncOperation(callback)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. ⭐ 关键步骤：注册取消监听器 ⭐
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> cancellableContinuation.invokeOnCancellation {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 当协程被取消时，尝试取消底层的异步操作
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// 通常调用库提供的取消方法，例如：cancelOperation(callback)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> cancelOperation(callback)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>当调用这个&lt;code>suspend fun&lt;/code>的协程被取消时：
&lt;ol>
&lt;li>协程的取消状态会传播到这个 &lt;code>CancellableContinuation&lt;/code>。&lt;/li>
&lt;li>触发 &lt;code>invokeOnCancellation {}&lt;/code> 块。&lt;/li>
&lt;li>在块内，你调用库的取消方法去清理资源并停止操作。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>这是&lt;strong>将回调 API 集成到协程世界的最佳实践&lt;/strong>。&lt;/li>
&lt;/ul>
&lt;h4 id="协程作用域">协程作用域
&lt;/h4>&lt;h5 id="1什么是协程作用域coroutinescope">1、什么是协程作用域（CoroutineScope）
&lt;/h5>&lt;ul>
&lt;li>&lt;code>CoroutineScope&lt;/code>不是协程本身，而是一个&lt;strong>定义新协程运行环境&lt;/strong>的接口&lt;/li>
&lt;li>它为在其内部启动的所有子协程提供了一个统一的&lt;code>CoroutineContext&lt;/code>基础&lt;/li>
&lt;li>它将所有在其内部启动的协程&lt;strong>组织在一个结构中&lt;/strong>，以便进行&lt;strong>生命周期管理&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>核心构成：&lt;/strong>&lt;/p>
&lt;p>CoroutineScope接口只有一个属性：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">interface&lt;/span> &lt;span style="color:#a6e22e">CoroutineScope&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> coroutineContext: CotoutineContext
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个&lt;code>coroutineContext&lt;/code>是启动在该作用域内的&lt;strong>所有子协程的默认上下文&lt;/strong>。&lt;/p>
&lt;p>&lt;strong>协程作用域的核心优点&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>&lt;strong>生命周期的自动管理(取消)&lt;/strong>
&lt;ul>
&lt;li>避免内存泄漏&lt;/li>
&lt;li>简化资源清理&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>安全性与清晰性&lt;/strong>
&lt;ul>
&lt;li>取消传播：作用域的取消会自动且可靠地传播到所有子协程，无需开发者手动级联取消&lt;/li>
&lt;li>异常处理控制：作用域定义了异常传播的策略（通过其关联的&lt;code>Job&lt;/code>是普通&lt;code>Job&lt;/code>还是&lt;code>SupervisorJob&lt;/code>）。&lt;code>SupervisorJob&lt;/code>允许子协程独立失败而不影响其他兄弟协程和父作用域（常用于UI组件中单独的后台任务）。&lt;/li>
&lt;li>代码组织清晰：将任务划分到不同的作用域中，体现了任务的逻辑和生命周期归属。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>上下文继承与共享&lt;/strong>
&lt;ul>
&lt;li>在作用域内启动的协程默认继承作用域的coroutineContext&lt;/li>
&lt;li>可以指定不同的CoroutineContext元素来覆盖上下文&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>协同等待(job.join(), coroutineScope {})&lt;/strong>
&lt;ul>
&lt;li>你可以通过作用域的关联 &lt;code>Job&lt;/code> (调用 &lt;code>scope.coroutineContext[Job]!!.join()&lt;/code> 或更简单地使用 &lt;code>coroutineScope {}&lt;/code> 构建器) 来&lt;strong>等待作用域内所有子协程全部完成&lt;/strong>。这保证了任务内部的并发操作在外部看来是原子性的（即父协程等待所有子协程完成后自己才完成）。&lt;/li>
&lt;li>&lt;code>coroutineScope {}&lt;/code> 构建器本身也会创建一个新的子作用域，并等待其内部所有子协程完成&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="async的行为">async的行为
&lt;/h4>&lt;h5 id="1-async的立即启动特性">1. async的立即启动特性
&lt;/h5>&lt;ul>
&lt;li>async不是等待await才执行：当使用async { &amp;hellip; } 创建协程时，其中的代码会立即开始执行，而不是等待调用&lt;code>await()&lt;/code>。即使不调用await()，协程体也会在后台启动。&lt;/li>
&lt;li>并发执行：多个async协程默认并行执行（取决于调度器和上下文）。例如：&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">val&lt;/span> deferred1 = async { task1() } &lt;span style="color:#75715e">// 立即开始执行
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> deferred2 = async { task2() } &lt;span style="color:#75715e">// 立即开始执行（可能与 task1 同时运行）
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2-await的作用">2. await()的作用
&lt;/h5>&lt;ul>
&lt;li>同步等待结果：await()是一个挂起点：
&lt;ul>
&lt;li>如果协程已完成：直接返回结果&lt;/li>
&lt;li>如果协程未完成：挂起当前协程，等待结果但不阻止其他协程执行&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>顺序控制：await()可强制等待顺序：&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">val&lt;/span> result1 = deferred1.await() &lt;span style="color:#75715e">// 等待 task1 完成
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">val&lt;/span> result2 = deferred2.await() &lt;span style="color:#75715e">// 再等待 task2 完成
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="qa">Q&amp;amp;A
&lt;/h4>&lt;ol>
&lt;li>
&lt;p>父协程的挂起会影响子协程的运行吗？&lt;/p>
&lt;ul>
&lt;li>&lt;strong>通常不会影响子协程的运行&lt;/strong>，父协程与子协程是独立的任务单元，只要子协程未完成且未被取消，他们会继续由调度器分配线程执行。取消是取消，挂起时让出当前线程&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>父作用域会等待所有子协程完成后才继续执行？&lt;/p>
&lt;ul>
&lt;li>是的，所有父协程（父作用域）会自动等待所有子协程完成。&lt;code>join()&lt;/code>和&lt;code>wait()&lt;/code>&lt;strong>控制执行顺序&lt;/strong>和&lt;strong>确保在特定节点有结果&lt;/strong>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>为什么I/O操作支持挂起，而CPU密集操作需要&lt;code>withContext&lt;/code>手动挂起。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>I/O操作需要&lt;strong>等待外部资源&lt;/strong>（文件/网络/数据库响应）就绪，进而CPU就会空闲，空闲下来了，协程就决定&lt;strong>主动释放线程 - 挂起&lt;/strong>，让其他任务去使用线程。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>CPU密集操作&lt;strong>持续消耗CPU计算资源&lt;/strong>，CPU不会空闲&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol></description></item><item><title>协程原理</title><link>https://www.dust-zed.site/android-develop/%E5%8D%8F%E7%A8%8B%E5%8E%9F%E7%90%86/</link><pubDate>Mon, 30 Jun 2025 15:13:25 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/%E5%8D%8F%E7%A8%8B%E5%8E%9F%E7%90%86/</guid><description>&lt;p>Kotlin协程的本质是&lt;strong>通过状态机管理挂起点，由编译器进行CPS变换实现的轻量级并发抽象&lt;/strong>。其核心原理和状态推进机制如下：&lt;/p>
&lt;h4 id="核心原理">核心原理
&lt;/h4>&lt;h5 id="1-挂起函数">1. 挂起函数
&lt;/h5>&lt;ul>
&lt;li>用suspend修饰的函数&lt;/li>
&lt;li>编译器会将其编译为&lt;strong>状态机代码&lt;/strong>(而非阻塞线程)，支持在任意位置挂起/恢复&lt;/li>
&lt;/ul>
&lt;h5 id="2-续体">2. 续体
&lt;/h5>&lt;ul>
&lt;li>类似回调的接口&lt;code>Continuation&amp;lt;T&amp;gt;&lt;/code>，其关键方法是&lt;code>resumeWith(result)&lt;/code>&lt;/li>
&lt;li>协程的每一步执行都依附于一个续体对象，存储当前执行状态和上下文&lt;/li>
&lt;/ul>
&lt;h5 id="3-状态机转换">3. 状态机转换
&lt;/h5>&lt;ul>
&lt;li>编译器将挂起函数拆解成一个状态机（通过&lt;code>label&lt;/code>标记状态）&lt;/li>
&lt;li>每个挂起点对应一个状态迁移&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h4 id="状态推进流程">状态推进流程
&lt;/h4>&lt;p>以下代码展示状态机的运作：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">suspend&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">fetchData&lt;/span>(): String {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> data1 = fetchPart1() &lt;span style="color:#75715e">//挂起点1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">val&lt;/span> data2 = fetchPart2() &lt;span style="color:#75715e">//挂起点2
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> data1 + data2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>编译器转换后（伪代码）&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FetchDataStateMachine&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> completion: Continuation&amp;lt;String&amp;gt;,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> label: Int = &lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) : Continuation&amp;lt;Unit&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> data1: String? = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> data2: String? = &lt;span style="color:#66d9ef">null&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#a6e22e">resumeWith&lt;/span>(result: Result&amp;lt;Any?&amp;gt;) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">when&lt;/span>(label) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> label = &lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fetchPart1(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> data1 = result.getOrThrow() &lt;span style="color:#66d9ef">as&lt;/span> String
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> label = &lt;span style="color:#ae81ff">2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fetchPart2(&lt;span style="color:#66d9ef">this&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ae81ff">2&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> data2 = result.getOrThrow() &lt;span style="color:#66d9ef">as&lt;/span> String
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> completion.resumeWith(data1 + data2) &lt;span style="color:#75715e">//返回最终结果
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h4 id="关键机制">关键机制
&lt;/h4>&lt;h5 id="1-挂起不阻塞线程">1. 挂起不阻塞线程：
&lt;/h5>&lt;ul>
&lt;li>协程挂起时，底层线程立即释放（例如返回到线程池），避免资源浪费&lt;/li>
&lt;li>异步操作完成后，任务被派发到合适的线程继续执行（通过&lt;code>Dispatcher&lt;/code>）&lt;/li>
&lt;/ul>
&lt;h5 id="2续体传递风格">2.续体传递风格
&lt;/h5>&lt;ul>
&lt;li>挂起函数被编译为接受额外&lt;code>Continuation&lt;/code>参数的函数&lt;/li>
&lt;li>例如&lt;code>suspend fun foo()&lt;/code> → &lt;code>fun foo(continuation: Continuation)&lt;/code>&lt;/li>
&lt;/ul>
&lt;h5 id="3-协程上下文coroutinecontext">3. 协程上下文（CoroutineContext）
&lt;/h5>&lt;ul>
&lt;li>通过&lt;code>CoroutineContext&lt;/code>传递调度器、异常处理器等。&lt;/li>
&lt;li>状态机中通过&lt;code>Continuation.context&lt;/code>获取当前上下文&lt;/li>
&lt;/ul>
&lt;h5 id="4-结构化并发">4. 结构化并发
&lt;/h5>&lt;ul>
&lt;li>协程树通过父-子关系管理生命周期&lt;/li>
&lt;li>父协程取消时，自动取消所有子协程&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h4 id="状态推进">状态推进
&lt;/h4>&lt;p>在&lt;code>FetchDataStateMachine&lt;/code>的&lt;code>resumeWith&lt;/code>中并没有循环，label的状态是如何推进的呢？实际上状态推进是通过&lt;strong>递归链式调用与间接跳转&lt;/strong>实现的。&lt;/p>
&lt;h5 id="1-单次触发模型">1. 单次触发模型
&lt;/h5>&lt;ul>
&lt;li>每次resumeWith被调用时只处理当前状态&lt;/li>
&lt;li>通过更新label值标记下一步状态&lt;/li>
&lt;li>不立即处理后续状态，而是等待下一次恢复&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-kotlin" data-lang="kotlin">&lt;span style="display:flex;">&lt;span>label = &lt;span style="color:#ae81ff">2&lt;/span> &lt;span style="color:#75715e">//只标记下一步状态，不立即执行
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>fetchPart2(&lt;span style="color:#66d9ef">this&lt;/span>) &lt;span style="color:#75715e">//触发异步操作（挂起），this就是FetchDataStateMachine，其是Continuation，可通过this调用resumeWith
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2-链式递归唤醒">2. 链式递归唤醒
&lt;/h5>&lt;ul>
&lt;li>每个异步操作完成时，都会重新调用resumeWith&lt;/li>
&lt;li>每调用一次，就会处理当前状态并设置下一次状态&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>resumeWith(结果) → 处理当前状态
↑ ↓
异步完成 设置下一状态
↑
恢复执行
&lt;/code>&lt;/pre>&lt;h5 id="3-状态变量持久化">3. 状态变量持久化
&lt;/h5>&lt;ul>
&lt;li>状态机对象在挂起期间持续存在（堆内存）&lt;/li>
&lt;li>成员变量(data1, label)保存中间状态&lt;/li>
&lt;li>每次恢复时从正确状态继续执行&lt;/li>
&lt;/ul>
&lt;h5 id="4-编译器优化技巧">4. 编译器优化技巧
&lt;/h5>&lt;ul>
&lt;li>尾递归优化：编译器会将状态处理转为循环&lt;/li>
&lt;li>状态折叠 ：合并可优化状态减少跳转次数&lt;/li>
&lt;li>内联状态：简单状态机转为switch跳转表&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h4 id="对挂起的理解">对挂起的理解
&lt;/h4>&lt;p>协程挂机：在挂起点暂停当前的同步代码，转而去执行消息队列的runnable；这样就是我对挂起的理解，也就是让出线程&lt;/p></description></item><item><title>gradle相关知识</title><link>https://www.dust-zed.site/android-develop/gradle%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/</link><pubDate>Sun, 29 Jun 2025 15:26:57 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/gradle%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/</guid><description>&lt;h3 id="一插件plugins-vs-库libraries">一、插件(Plugins) vs 库(Libraries)
&lt;/h3>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>特征&lt;/strong>&lt;/th>
&lt;th>插件 (Plugins)&lt;/th>
&lt;th>库 (Libraries)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>本质&lt;/strong>&lt;/td>
&lt;td>构建逻辑扩展工具&lt;/td>
&lt;td>运行时依赖的代码组件&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>作用&lt;/strong>&lt;/td>
&lt;td>添加任务/配置/目录结构&lt;/td>
&lt;td>提供可调用的具体代码实现&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>声明位置&lt;/strong>&lt;/td>
&lt;td>&lt;code>plugins {}&lt;/code> 块&lt;/td>
&lt;td>&lt;code>dependencies {}&lt;/code> 块&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>影响范围&lt;/strong>&lt;/td>
&lt;td>构建过程&lt;/td>
&lt;td>运行时或编译时&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>典型示例&lt;/strong>&lt;/td>
&lt;td>&lt;code>java&lt;/code>，&lt;code>android&lt;/code>&lt;/td>
&lt;td>&lt;code>gson&lt;/code>, &lt;code>junit&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="1-插件详解">1. 插件详解
&lt;/h4>&lt;p>&lt;strong>核心作用&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>添加新任务（如 &lt;code>compileJava&lt;/code>, &lt;code>assemble&lt;/code>）&lt;/li>
&lt;li>定义默认目录结构（如 &lt;code>src/main/java&lt;/code>）&lt;/li>
&lt;li>引入预置配置（如 &lt;code>implementation&lt;/code> 依赖配置）&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>使用场景&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-groovy" data-lang="groovy">&lt;span style="display:flex;">&lt;span>plugins &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id &lt;span style="color:#e6db74">&amp;#39;com.android.application&amp;#39;&lt;/span> &lt;span style="color:#75715e">// Android APP插件
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> id &lt;span style="color:#e6db74">&amp;#39;org.jetbrains.kotlin.android&amp;#39;&lt;/span> &lt;span style="color:#75715e">// Kotlin支持
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2-库详解">2. 库详解
&lt;/h4>&lt;p>&lt;strong>关键特征&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>通过坐标声明：&lt;code>group:name:version&lt;/code>（如 &lt;code>com.google.guava:guava:32.0-jre&lt;/code>）&lt;/li>
&lt;li>&lt;strong>传递依赖&lt;/strong>：库可能自带其他依赖（如 Retrofit 自动引入 OkHttp）&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>使用场景&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-groovy" data-lang="groovy">&lt;span style="display:flex;">&lt;span>dependencies &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementation &lt;span style="color:#e6db74">&amp;#39;androidx.core:core-ktx:1.12.0&amp;#39;&lt;/span> &lt;span style="color:#75715e">// 主代码依赖
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> testImplementation &lt;span style="color:#e6db74">&amp;#39;junit:junit:4.13.2&amp;#39;&lt;/span> &lt;span style="color:#75715e">// 测试代码专用
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h3 id="二依赖配置详解">二、依赖配置详解
&lt;/h3>&lt;h4 id="1-implementation最常用">1. &lt;code>implementation&lt;/code>（最常用）
&lt;/h4>&lt;p>&lt;strong>特点&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>依赖&lt;strong>不传递&lt;/strong>给其他模块,&lt;code>模块F → 模块D → 模块E&lt;/code>（传导终止于D），模块F完全不知道模块E的存在&lt;/li>
&lt;li>加快构建（减少重编译）&lt;/li>
&lt;li>适用于绝大多数字依赖&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-groovy" data-lang="groovy">&lt;span style="display:flex;">&lt;span>implementation &lt;span style="color:#e6db74">&amp;#39;com.squareup.retrofit2:retrofit:2.9.0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2-api谨慎使用">2. &lt;code>api&lt;/code>（谨慎使用）
&lt;/h4>&lt;p>&lt;strong>特点&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>依赖&lt;strong>传递&lt;/strong>给其他模块，建立&lt;strong>依赖传递链&lt;/strong>：&lt;code>模块C → 模块A → 模块B&lt;/code>，模块C可以使用模块B公开的接口&lt;/li>
&lt;li>用于 SDK 开发需暴露依赖的场景&lt;/li>
&lt;li>会增加构建时间&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-groovy" data-lang="groovy">&lt;span style="display:flex;">&lt;span>api &lt;span style="color:#e6db74">&amp;#39;com.google.dagger:dagger:2.48&amp;#39;&lt;/span> &lt;span style="color:#75715e">// 其他模块需使用Dagger
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-classpath">3. &lt;code>classpath&lt;/code>
&lt;/h4>&lt;p>&lt;strong>特点&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>仅用于项目级构建脚本(&lt;code>build.gradle&lt;/code>)&lt;/li>
&lt;li>为 Gradle 自身引入插件包，然后在模块级plugins块中声明使用&lt;/li>
&lt;li>&lt;strong>不参与&lt;/strong>模块代码编译&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-groovy" data-lang="groovy">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 项目级 build.gradle
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>buildscript &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dependencies &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> classpath &lt;span style="color:#e6db74">&amp;#39;com.android.tools.build:gradle:8.1.0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="4-alias版本目录">4. &lt;code>alias&lt;/code>（版本目录）
&lt;/h4>&lt;p>&lt;strong>特点&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>在 &lt;code>gradle/libs.versions.toml&lt;/code> 中集中管理依赖&lt;/li>
&lt;li>解决版本号硬编码问题&lt;/li>
&lt;li>&lt;strong>需 AGP 7.4+&lt;/strong> 支持&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-toml" data-lang="toml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># libs.versions.toml&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#a6e22e">versions&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">androidxCore&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;1.12.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[&lt;span style="color:#a6e22e">libraries&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">android-core&lt;/span> = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">group&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidx.core&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">name&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;core-ktx&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">version&lt;/span>.&lt;span style="color:#a6e22e">ref&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;androidxCore&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-groovy" data-lang="groovy">&lt;span style="display:flex;">&lt;span>dependencies &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implementation&lt;span style="color:#f92672">(&lt;/span>libs&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">android&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">core&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#75715e">// 通过别名引用
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Android打包apk流程</title><link>https://www.dust-zed.site/android-develop/android%E6%89%93%E5%8C%85apk%E6%B5%81%E7%A8%8B/</link><pubDate>Sat, 28 Jun 2025 12:15:42 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/android%E6%89%93%E5%8C%85apk%E6%B5%81%E7%A8%8B/</guid><description>&lt;p>android应用的打包流程是将代码、资源文件、清单文件等编译和压缩成可在设备上安装的APK/AAB文件的过程。以下是详细步骤：&lt;/p>
&lt;h4 id="一主要流程">一、主要流程
&lt;/h4>&lt;h5 id="1-编写代码与资源管理">1. 编写代码与资源管理
&lt;/h5>&lt;ul>
&lt;li>创建&lt;code>/src&lt;/code>目录存放Kotlin/Java源码&lt;/li>
&lt;li>在&lt;code>/res&lt;/code>目录添加资源&lt;/li>
&lt;li>配置&lt;code>AndroidManifest.xml&lt;/code>(声明组件、权限等)。&lt;/li>
&lt;/ul>
&lt;h5 id="2-依赖管理">2. 依赖管理
&lt;/h5>&lt;ul>
&lt;li>在build.gradle中添加所需依赖库&lt;/li>
&lt;/ul>
&lt;h5 id="3-编译过程">3. 编译过程
&lt;/h5>&lt;ul>
&lt;li>编译代码： kotlin源码 → &lt;code>.class&lt;/code>字节码（javac/kotlinc）&lt;/li>
&lt;li>转换为Dex：&lt;code>.class&lt;/code>文件→ &lt;code>.dex&lt;/code>文件（&lt;code>d8&lt;/code>/&lt;code>dx&lt;/code>工具），用于Android的ART虚拟机&lt;/li>
&lt;li>编译资源：&lt;code>AAPT2&lt;/code>编译资源文件（&lt;code>res/&lt;/code> → 二进制格式），生成&lt;code>R.java&lt;/code>和临时资源包(&lt;code>.flat&lt;/code>)&lt;/li>
&lt;/ul>
&lt;h5 id="4打包与签名">4.打包与签名
&lt;/h5>&lt;ul>
&lt;li>合并资源： AAPT2链接编译后的资源，生成&lt;code>resources.arsc&lt;/code>（资源索引表）和优化后的&lt;code>res/&lt;/code>目录&lt;/li>
&lt;li>打包成APK：APK Builder将以下文件合并为未签名的APK：
&lt;ul>
&lt;li>编译后的字节码(&lt;code>.dex&lt;/code>)&lt;/li>
&lt;li>资源文件(&lt;code>res/&lt;/code> + &lt;code>resources.arsc&lt;/code>)&lt;/li>
&lt;li>&lt;code>AndroidManifest.xml&lt;/code>&lt;/li>
&lt;li>原生库(&lt;code>.so&lt;/code>，若有JNI)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>签名APK：使用签名证书(keystore)进行V1/V2/V3签名(通过&lt;code>apksigner&lt;/code> 或Gradle配置)&lt;/li>
&lt;/ul>
&lt;h5 id="5优化与对齐">5.优化与对齐
&lt;/h5>&lt;ul>
&lt;li>ZIP对齐：&lt;code>zipalign&lt;/code>优化APK文件结构(4字节对齐)，减少运行时内存占用&lt;/li>
&lt;li>生成最终的APK：输出&lt;code>app-release.apk&lt;/code>&lt;/li>
&lt;/ul>
&lt;h4 id="二名词解释">二、名词解释
&lt;/h4>&lt;h5 id="1-临时资源包">1. 临时资源包
&lt;/h5>&lt;p>在AAPT2（&lt;code>Android Asset Packaging Tool 2&lt;/code>）的资源预编译阶段会生成&lt;code>.flat&lt;/code>文件，这些文件是中间产物&lt;/p>
&lt;ul>
&lt;li>独立编译：AAPT2将&lt;code>/res&lt;/code>目录下的每个资源文件单独编译成二进制格式的&lt;code>.flat&lt;/code>文件&lt;/li>
&lt;li>支持增量编译：若只修改了单个资源文件，只需重新编译该文件的.flat文件，避免全量编译，加快构建速度&lt;/li>
&lt;li>分阶段处理
&lt;ul>
&lt;li>编译阶段：资源→ &lt;code>.flat&lt;/code>文件&lt;/li>
&lt;li>链接阶段：合并所有&lt;code>.flat&lt;/code>文件 → 生成&lt;code>resources.arsc&lt;/code>和最终的&lt;code>res/&lt;/code>目录&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>优势
&lt;ul>
&lt;li>提升大型项目的编译速度&lt;/li>
&lt;li>支持资源混淆&lt;/li>
&lt;li>更严格的资源验证&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h5 id="2-对齐">2. 对齐
&lt;/h5>&lt;ul>
&lt;li>&lt;strong>内存对齐&lt;/strong>：解决CPU访问效率问题（&lt;code>数据项首地址 % n == 0&lt;/code>），但会增加数据结构大小&lt;/li>
&lt;li>&lt;strong>文件对齐(zipalign)&lt;/strong>:解决内存映射效率的问题（&lt;code>文件偏移 % 4096 == 0&lt;/code>），通过消除跨页碎片减少运行时内存占用&lt;/li>
&lt;li>&lt;strong>内存页机制&lt;/strong>
&lt;ul>
&lt;li>系统内存管理以**页(通常4KB)**为单位&lt;/li>
&lt;li>对齐后，每次文件读取 = 整数倍内存页 → &lt;strong>减少I/O次数&lt;/strong>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>Choreographer类解析</title><link>https://www.dust-zed.site/android-develop/choreographer%E7%B1%BB%E8%A7%A3%E6%9E%90/</link><pubDate>Mon, 16 Jun 2025 06:49:21 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/choreographer%E7%B1%BB%E8%A7%A3%E6%9E%90/</guid><description>&lt;h4 id="一核心作用">一、核心作用
&lt;/h4>&lt;p>Choreographer是Android系统&lt;strong>协调动画、输入和绘制操作的核心调度器&lt;/strong>。它通过VSYNC信号确保帧的渲染与屏幕刷新率同步，避免画面撕裂和卡顿。&lt;/p>
&lt;h4 id="二关键概念">二、关键概念
&lt;/h4>&lt;ul>
&lt;li>VSYNC：垂直同步信号，表示屏幕开始刷新新的一帧&lt;/li>
&lt;li>Frame Callbacks：注册的回调函数，在下一帧的特定阶段执行&lt;/li>
&lt;li>Callback Types（按执行顺序排序）
&lt;ul>
&lt;li>CALLBACK_INPUT&lt;/li>
&lt;li>CALLBACK_ANIMATION&lt;/li>
&lt;li>CALLBACK_INSETS_ANIMATION&lt;/li>
&lt;li>CALLBACK_TRAVERSAL&lt;/li>
&lt;li>CALLBACK_COMMIT&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Choreographer&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 五种回调类型&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> CALLBACK_INPUT &lt;span style="color:#f92672">=&lt;/span> 0;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> CALLBACK_ANIMATION &lt;span style="color:#f92672">=&lt;/span> 1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> CALLBACK_INSETS_ANIMATION &lt;span style="color:#f92672">=&lt;/span> 2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> CALLBACK_TRAVERSAL &lt;span style="color:#f92672">=&lt;/span> 3;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> CALLBACK_COMMIT &lt;span style="color:#f92672">=&lt;/span> 4;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> CALLBACK_LAST &lt;span style="color:#f92672">=&lt;/span> CALLBACK_COMMIT; &lt;span style="color:#75715e">// 最后一种类型&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 单例模式实现&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> ThreadLocal&lt;span style="color:#f92672">&amp;lt;&lt;/span>Choreographer&lt;span style="color:#f92672">&amp;gt;&lt;/span> sThreadInstance &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">new&lt;/span> ThreadLocal&lt;span style="color:#f92672">&amp;lt;&lt;/span>Choreographer&lt;span style="color:#f92672">&amp;gt;&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">protected&lt;/span> Choreographer &lt;span style="color:#a6e22e">initialValue&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Looper looper &lt;span style="color:#f92672">=&lt;/span> Looper.&lt;span style="color:#a6e22e">myLooper&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Choreographer(looper, VSYNC_SOURCE_APP);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> };
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 回调队列数组&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> CallbackQueue&lt;span style="color:#f92672">[]&lt;/span> mCallbackQueues;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// VSYNC 接收器&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> FrameDisplayEventReceiver mDisplayEventReceiver;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 处理消息的Handler&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> FrameHandler mHandler;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="三核心架构图解">三、核心架构图解
&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-tex" data-lang="tex">&lt;span style="display:flex;">&lt;span>┌───────────────────────┐ ┌───────────────────────┐
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ VSYNC 信号源 │──────&amp;gt;│ FrameDisplayEventReceiver │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>└───────────────────────┘ │ (接收硬件VSYNC信号) │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> └───────────┬───────────┘
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ▼
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>┌───────────────────────┐ ┌───────────────────────┐
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ FrameHandler │&amp;lt;──────│ onVsync() │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ (处理3类消息) │──────&amp;gt;│ scheduleVsync() │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>└───────────┬───────────┘ └───────────────────────┘
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ▼
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>┌───────────────────────┐
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ doFrame() │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ (帧处理核心方法) │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>└───────────┬───────────┘
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ▼
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>┌───────────────────────┐
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ CallbackQueue[] │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ (5种类型回调链表) │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>└───────────────────────┘
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="三回调添加入口">三、回调添加入口
&lt;/h4>&lt;h5 id="1-添加回调入口">1. 添加回调入口
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">postCallback&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> callbackType, Runnable action, Object token) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> postCallbackDelayed(callbackType, action, token, 0);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">postCallbackDelayed&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> callbackType, Runnable action, &lt;span style="color:#66d9ef">long&lt;/span> delayMillis) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> postCallbackDelayedInternal(callbackType, action, token, delayMillis);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2-内部添加实现">2. 内部添加实现
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">postCallbackDelayedInternal&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> callbackType,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Object action, Object token, &lt;span style="color:#66d9ef">long&lt;/span> delayMillis) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">synchronized&lt;/span> (mLock) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> now &lt;span style="color:#f92672">=&lt;/span> SystemClock.&lt;span style="color:#a6e22e">uptimeMillis&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> dueTime &lt;span style="color:#f92672">=&lt;/span> now &lt;span style="color:#f92672">+&lt;/span> delayMillis;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 添加到对应的回调队列&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mCallbackQueues&lt;span style="color:#f92672">[&lt;/span>callbackType&lt;span style="color:#f92672">]&lt;/span>.&lt;span style="color:#a6e22e">addCallbackLocked&lt;/span>(dueTime, action, token);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. 调度帧处理&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (dueTime &lt;span style="color:#f92672">&amp;lt;=&lt;/span> now) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 立即调度&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> scheduleFrameLocked(now);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 延迟调度&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Message msg &lt;span style="color:#f92672">=&lt;/span> mHandler.&lt;span style="color:#a6e22e">obtainMessage&lt;/span>(MSG_DO_SCHEDULE_CALLBACK, action);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> msg.&lt;span style="color:#a6e22e">arg1&lt;/span> &lt;span style="color:#f92672">=&lt;/span> callbackType;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> msg.&lt;span style="color:#a6e22e">setAsynchronous&lt;/span>(&lt;span style="color:#66d9ef">true&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mHandler.&lt;span style="color:#a6e22e">sendMessageAtTime&lt;/span>(msg, dueTime);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="3-回调链表结构">3. 回调链表结构
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">CallbackQueue&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> CallbackRecord mHead;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">addCallbackLocked&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> dueTime, Object action, Object token) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CallbackRecord callback &lt;span style="color:#f92672">=&lt;/span> obtainCallbackLocked(dueTime, action, token);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (mHead &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mHead &lt;span style="color:#f92672">=&lt;/span> callback;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 链表按照执行时间排序（小到大）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (dueTime &lt;span style="color:#f92672">&amp;lt;&lt;/span> mHead.&lt;span style="color:#a6e22e">dueTime&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> callback.&lt;span style="color:#a6e22e">next&lt;/span> &lt;span style="color:#f92672">=&lt;/span> mHead;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mHead &lt;span style="color:#f92672">=&lt;/span> callback;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CallbackRecord entry &lt;span style="color:#f92672">=&lt;/span> mHead;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (entry.&lt;span style="color:#a6e22e">next&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (dueTime &lt;span style="color:#f92672">&amp;lt;&lt;/span> entry.&lt;span style="color:#a6e22e">next&lt;/span>.&lt;span style="color:#a6e22e">dueTime&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> callback.&lt;span style="color:#a6e22e">next&lt;/span> &lt;span style="color:#f92672">=&lt;/span> entry.&lt;span style="color:#a6e22e">next&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> entry.&lt;span style="color:#a6e22e">next&lt;/span> &lt;span style="color:#f92672">=&lt;/span> callback;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> entry &lt;span style="color:#f92672">=&lt;/span> entry.&lt;span style="color:#a6e22e">next&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> entry.&lt;span style="color:#a6e22e">next&lt;/span> &lt;span style="color:#f92672">=&lt;/span> callback;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 链表节点定义&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">CallbackRecord&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> CallbackRecord next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> dueTime;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> Object action; &lt;span style="color:#75715e">// Runnable 或 FrameCallback&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> Object token;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="四vsync同步机制">四、VSYNC同步机制
&lt;/h4>&lt;h5 id="1-vsync请求">1、 VSYNC请求
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">scheduleFrameLocked&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> now) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>mFrameScheduled) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mFrameScheduled &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (USE_VSYNC) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 通过 FrameDisplayEventReceiver 请求 VSYNC&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (isRunningOnLooperThreadLocked()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//注册&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> scheduleVsyncLocked();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 非UI线程发送消息到UI线程&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Message msg &lt;span style="color:#f92672">=&lt;/span> mHandler.&lt;span style="color:#a6e22e">obtainMessage&lt;/span>(MSG_DO_SCHEDULE_VSYNC);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> msg.&lt;span style="color:#a6e22e">setAsynchronous&lt;/span>(&lt;span style="color:#66d9ef">true&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mHandler.&lt;span style="color:#a6e22e">sendMessageAtFrontOfQueue&lt;/span>(msg);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 无VSYNC直接安排帧&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> nextFrameTime &lt;span style="color:#f92672">=&lt;/span> ...;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Message msg &lt;span style="color:#f92672">=&lt;/span> mHandler.&lt;span style="color:#a6e22e">obtainMessage&lt;/span>(MSG_DO_FRAME);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> msg.&lt;span style="color:#a6e22e">setAsynchronous&lt;/span>(&lt;span style="color:#66d9ef">true&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mHandler.&lt;span style="color:#a6e22e">sendMessageAtTime&lt;/span>(msg, nextFrameTime);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">scheduleVsyncLocked&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mDisplayEventReceiver.&lt;span style="color:#a6e22e">scheduleVsync&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2-vsync接收与处理">2. VSYNC接收与处理
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">FrameDisplayEventReceiver&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> DisplayEventReceiver {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">onVsync&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> timestampNanos, &lt;span style="color:#66d9ef">long&lt;/span> physicalDisplayId, &lt;span style="color:#66d9ef">int&lt;/span> frame) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1. 计算正确的帧时间&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> now &lt;span style="color:#f92672">=&lt;/span> System.&lt;span style="color:#a6e22e">nanoTime&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> intendedFrameTimeNanos &lt;span style="color:#f92672">=&lt;/span> ...;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 2. 发送MSG_DO_FRAME消息&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Message msg &lt;span style="color:#f92672">=&lt;/span> Message.&lt;span style="color:#a6e22e">obtain&lt;/span>(mHandler, MSG_DO_FRAME);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> msg.&lt;span style="color:#a6e22e">setAsynchronous&lt;/span>(&lt;span style="color:#66d9ef">true&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mHandler.&lt;span style="color:#a6e22e">sendMessageAtTime&lt;/span>(msg, intendedFrameTimeNanos &lt;span style="color:#f92672">/&lt;/span> NANOS_PER_MS);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="3-帧处理核心---doframe">3. 帧处理核心 - doFrame()
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doFrame&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> frameTimeNanos, &lt;span style="color:#66d9ef">int&lt;/span> frame) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> startNanos;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">synchronized&lt;/span> (mLock) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 检查帧调度状态&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>mFrameScheduled) &lt;span style="color:#66d9ef">return&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 计算跳帧情况&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> jitterNanos &lt;span style="color:#f92672">=&lt;/span> startNanos &lt;span style="color:#f92672">-&lt;/span> frameTimeNanos;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (jitterNanos &lt;span style="color:#f92672">&amp;gt;=&lt;/span> mFrameIntervalNanos) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> skippedFrames &lt;span style="color:#f92672">=&lt;/span> jitterNanos &lt;span style="color:#f92672">/&lt;/span> mFrameIntervalNanos;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 超过阈值打印警告日志&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (skippedFrames &lt;span style="color:#f92672">&amp;gt;=&lt;/span> SKIPPED_FRAME_WARNING_LIMIT) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Log.&lt;span style="color:#a6e22e">i&lt;/span>(TAG, &lt;span style="color:#e6db74">&amp;#34;Skipped &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> skippedFrames &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34; frames!&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> frameTimeNanos &lt;span style="color:#f92672">=&lt;/span> ...; &lt;span style="color:#75715e">// 调整帧时间&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mLastFrameTimeNanos &lt;span style="color:#f92672">=&lt;/span> frameTimeNanos;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mFrameScheduled &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 按优先级顺序执行回调&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mFrameInfo.&lt;span style="color:#a6e22e">markInputHandlingStart&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> doCallbacks(Choreographer.&lt;span style="color:#a6e22e">CALLBACK_INPUT&lt;/span>, frameTimeNanos);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mFrameInfo.&lt;span style="color:#a6e22e">markAnimationsStart&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> doCallbacks(Choreographer.&lt;span style="color:#a6e22e">CALLBACK_ANIMATION&lt;/span>, frameTimeNanos);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mFrameInfo.&lt;span style="color:#a6e22e">markPerformTraversalsStart&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> doCallbacks(Choreographer.&lt;span style="color:#a6e22e">CALLBACK_TRAVERSAL&lt;/span>, frameTimeNanos);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> doCallbacks(Choreographer.&lt;span style="color:#a6e22e">CALLBACK_COMMIT&lt;/span>, frameTimeNanos);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">finally&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 清理工作&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="五回调执行处理">五、回调执行处理
&lt;/h4>&lt;h5 id="1-执行回调核心逻辑">1. 执行回调核心逻辑
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doCallbacks&lt;/span>(&lt;span style="color:#66d9ef">int&lt;/span> callbackType, &lt;span style="color:#66d9ef">long&lt;/span> frameTimeNanos) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CallbackRecord callbacks;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">synchronized&lt;/span> (mLock) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 提取所有到期的回调&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">long&lt;/span> now &lt;span style="color:#f92672">=&lt;/span> frameTimeNanos &lt;span style="color:#f92672">/&lt;/span> NANOS_PER_MS;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> callbacks &lt;span style="color:#f92672">=&lt;/span> mCallbackQueues&lt;span style="color:#f92672">[&lt;/span>callbackType&lt;span style="color:#f92672">]&lt;/span>.&lt;span style="color:#a6e22e">extractDueCallbacksLocked&lt;/span>(now);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (callbacks &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>) &lt;span style="color:#66d9ef">return&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mCallbacksRunning &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 执行链表中的所有回调&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (CallbackRecord c &lt;span style="color:#f92672">=&lt;/span> callbacks; c &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>; c &lt;span style="color:#f92672">=&lt;/span> c.&lt;span style="color:#a6e22e">next&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 执行回调&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (c.&lt;span style="color:#a6e22e">action&lt;/span> &lt;span style="color:#66d9ef">instanceof&lt;/span> Runnable) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ((Runnable) c.&lt;span style="color:#a6e22e">action&lt;/span>).&lt;span style="color:#a6e22e">run&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ((FrameCallback) c.&lt;span style="color:#a6e22e">action&lt;/span>).&lt;span style="color:#a6e22e">doFrame&lt;/span>(frameTimeNanos);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">finally&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">synchronized&lt;/span> (mLock) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 回收CallbackRecord对象&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> recycleCallbackRecordsLocked(callbacks);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mCallbacksRunning &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="2到期回调提取算法">2.到期回调提取算法
&lt;/h5>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>CallbackRecord &lt;span style="color:#a6e22e">extractDueCallbacksLocked&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> now) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CallbackRecord callbacks &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CallbackRecord next &lt;span style="color:#f92672">=&lt;/span> mHead;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 遍历链表，找出所有dueTime&amp;lt;=now的节点&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> (next &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> next.&lt;span style="color:#a6e22e">dueTime&lt;/span> &lt;span style="color:#f92672">&amp;lt;=&lt;/span> now) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CallbackRecord temp &lt;span style="color:#f92672">=&lt;/span> next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> next &lt;span style="color:#f92672">=&lt;/span> next.&lt;span style="color:#a6e22e">next&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> temp.&lt;span style="color:#a6e22e">next&lt;/span> &lt;span style="color:#f92672">=&lt;/span> callbacks; &lt;span style="color:#75715e">// 新节点插入链表头部&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> callbacks &lt;span style="color:#f92672">=&lt;/span> temp; &lt;span style="color:#75715e">// 新链表头&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 更新原链表&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mHead &lt;span style="color:#f92672">=&lt;/span> next;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 返回的是倒序链表（最近加入的先执行）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> callbacks;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="完整流程">完整流程
&lt;/h5>&lt;pre tabindex="0">&lt;code>[1] postCallback()
↓
[2] scheduleFrameLocked()
↓
[3] scheduleVsyncLocked()
↓
[4] mDisplayEventReceiver.scheduleVsync() (请求 Vsync)
↓
... 等待硬件 Vsync 信号 ...
↓
[5] onVsync() (native 线程回调)
↓
[6] Message msg = obtainMessage(MSG_DO_FRAME)
↓
[7] mHandler.sendMessageAtTime(msg, ...) (发送到主线程)
↓
[8] FrameHandler.handleMessage() (主线程)
↓
[9] doFrame() (主线程执行)
↓
[10] doCallbacks() (执行所有 Callback)
&lt;/code>&lt;/pre>&lt;hr>
&lt;h4 id="六choreographer的其他作用">六、Choreographer的其他作用
&lt;/h4>&lt;h5 id="1-帧率监控">1. 帧率监控
&lt;/h5>&lt;p>开发者可以通过postFrameCallback实现帧率监控：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">startMonitoring&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Choreographer.&lt;span style="color:#a6e22e">getInstance&lt;/span>().&lt;span style="color:#a6e22e">postFrameCallback&lt;/span>(&lt;span style="color:#66d9ef">new&lt;/span> FrameCallback() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> lastFrameTime &lt;span style="color:#f92672">=&lt;/span> 0;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doFrame&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> frameTimeNanos) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (lastFrameTime &lt;span style="color:#f92672">!=&lt;/span> 0) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> frameInterval &lt;span style="color:#f92672">=&lt;/span> (frameTimeNanos &lt;span style="color:#f92672">-&lt;/span> lastFrameTime) &lt;span style="color:#f92672">/&lt;/span> 1000000;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (frameInterval &lt;span style="color:#f92672">&amp;gt;&lt;/span> 16) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 记录掉帧情况&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> lastFrameTime &lt;span style="color:#f92672">=&lt;/span> frameTimeNanos;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Choreographer.&lt;span style="color:#a6e22e">getInstance&lt;/span>().&lt;span style="color:#a6e22e">postFrameCallback&lt;/span>(&lt;span style="color:#66d9ef">this&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="七总结">七、总结
&lt;/h4>&lt;p>Choreographer 是 Android 渲染系统的核心协调器，其工作原理可以概括为：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>任务管理&lt;/strong>：通过 5 个链表队列管理不同优先级的回调任务&lt;/p>
&lt;ul>
&lt;li>输入 &amp;gt; 动画 &amp;gt; 插入动画 &amp;gt; 视图遍历 &amp;gt; 提交&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>VSYNC 同步&lt;/strong>：&lt;/p>
&lt;pre tabindex="0">&lt;code>scheduleVsync() → DisplayEventReceiver → onVsync() → doFrame()
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>&lt;strong>帧生命周期&lt;/strong>：&lt;/p>
&lt;pre tabindex="0">&lt;code>doFrame() →
doCallbacks(INPUT) →
doCallbacks(ANIMATION) →
doCallbacks(TRAVERSAL) →
doCallbacks(COMMIT)
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>&lt;strong>性能监控&lt;/strong>：内置跳帧检测和警告机制&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>系统协调&lt;/strong>：作为动画系统、UI 系统、输入系统的同步中枢&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>整个设计体现了 Android 系统对以下关键目标的平衡：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>精确性&lt;/strong>：通过 VSYNC 精准同步&lt;/li>
&lt;li>&lt;strong>高效性&lt;/strong>：链表结构和对象复用&lt;/li>
&lt;li>&lt;strong>优先级&lt;/strong>：严格的分级回调顺序&lt;/li>
&lt;li>&lt;strong>扩展性&lt;/strong>：支持多种回调类型&lt;/li>
&lt;li>&lt;strong>监控能力&lt;/strong>：内置性能检测机制&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>&lt;code>scheduleVsync()&lt;/code> 的唯一目的就是在 VSYNC 到来时触发 &lt;code>doFrame()&lt;/code>&lt;/strong>，而整个 Choreographer 的核心任务就是确保所有帧处理操作完美对齐 VSYNC 时间序列。&lt;/p></description></item><item><title>包体积优化</title><link>https://www.dust-zed.site/android-develop/%E5%8C%85%E4%BD%93%E7%A7%AF%E4%BC%98%E5%8C%96/</link><pubDate>Sun, 15 Jun 2025 23:19:59 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/%E5%8C%85%E4%BD%93%E7%A7%AF%E4%BC%98%E5%8C%96/</guid><description>&lt;h4 id="包体积优化">包体积优化
&lt;/h4>&lt;h4 id="一apk结构分析工具">一、APK结构分析工具
&lt;/h4>&lt;ol>
&lt;li>Android Studio内置工具
&lt;ul>
&lt;li>使用 Build &amp;gt; Analyze APK&lt;/li>
&lt;li>查看各模块占比(代码/资源/原生库/Assets)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>命令行工具&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>./gradlew :app:assembleRelease --scan
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="二代码优化">二、代码优化
&lt;/h4>&lt;ol>
&lt;li>启用代码混淆与优化&lt;/li>
&lt;li>移除未使用代码
&lt;ul>
&lt;li>使用android studio的lint分析未使用代码&lt;/li>
&lt;li>添加R8配置文件删除无引用代码&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>方法数优化
&lt;ul>
&lt;li>启用Multidex前优化&lt;/li>
&lt;li>使用D8编译器的dex优化&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h4 id="三资源优化">三、资源优化
&lt;/h4>&lt;ol>
&lt;li>资源压缩与清理&lt;/li>
&lt;li>移除未使用资源&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 检测未使用资源&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./gradlew lintRelease
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 自动移除&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./gradlew removeUnusedResources
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>矢量图代替位图&lt;/li>
&lt;li>Webp格式转换&lt;/li>
&lt;/ol>
&lt;h4 id="四库优化">四、库优化
&lt;/h4>&lt;ol>
&lt;li>仅保留必要ABI&lt;/li>
&lt;li>轻量库代替&lt;/li>
&lt;/ol>
&lt;h4 id="五高级优化技术">五、高级优化技术
&lt;/h4>&lt;ol>
&lt;li>资源混淆&lt;/li>
&lt;li>资源分包加载&lt;/li>
&lt;li>按需加载功能模块&lt;/li>
&lt;/ol>
&lt;h4 id="六--assets优化">六 、 Assets优化
&lt;/h4>&lt;ol>
&lt;li>压缩assets资源：存储时压缩，使用时解压&lt;/li>
&lt;/ol>
&lt;h4 id="七知识补充">七、知识补充
&lt;/h4>&lt;ol>
&lt;li>D8、R8和代码混淆的关系
&lt;ul>
&lt;li>D8负责字节码到Dex的精确转换&lt;/li>
&lt;li>R8 = D8 + 裁剪 + 优化 + 混淆&lt;/li>
&lt;li>混淆是R8的战术武器：仅负责名称混淆（对体积影响小，对安全性关键）&lt;/li>
&lt;li>&lt;strong>开启R8 ≈ D8编译 + 三重优化(裁剪/优化/混淆)&lt;/strong>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol></description></item><item><title>内存管理最佳实践</title><link>https://www.dust-zed.site/android-develop/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</link><pubDate>Sun, 15 Jun 2025 13:05:49 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</guid><description>&lt;h4 id="一内存管理原则">一、内存管理原则
&lt;/h4>&lt;ol>
&lt;li>理解Android内存模型
&lt;ul>
&lt;li>基于JVM垃圾回收机制，采用分代回收策略&lt;/li>
&lt;li>内存不足是触发&lt;code>onTrimMemory()&lt;/code>，开发者需响应此回调释放资源&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>避免内存泄漏根源
&lt;ul>
&lt;li>静态引用：禁止用static持有Activity/Context（用Application Context代替）&lt;/li>
&lt;li>非静态内部类：改用静态内部类+弱引用&lt;/li>
&lt;li>资源未释放：关闭Cursor、File、Bitmap等资源。gc只释放java对象本身，在jvm堆中，系统资源需要显示释放&lt;/li>
&lt;li>集合对象：及时清理无用的集合元素&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>优化关键组件
&lt;ul>
&lt;li>Activity/Fragment
&lt;ul>
&lt;li>在onDestroy中解除BroadcastReceiver、Handler注册，移除回调&lt;/li>
&lt;li>避免在异步任务中直接引用View&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Handler
&lt;ul>
&lt;li>使用静态内部类 + WeakReference。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单例模式
&lt;ul>
&lt;li>传递Application Context，而非Activity Context&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>大对象优化
&lt;ul>
&lt;li>Bitmap
&lt;ul>
&lt;li>使用inSampleSize压缩图片，采用Glide等库管理内存&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>数据缓存
&lt;ul>
&lt;li>优先使用LruCache和DiskLruCache&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h4 id="二内存泄漏排查工具">二、内存泄漏排查工具
&lt;/h4>&lt;ol>
&lt;li>Android Profiler&lt;/li>
&lt;li>LeakCanary&lt;/li>
&lt;li>MAT&lt;/li>
&lt;li>StrictMode&lt;/li>
&lt;/ol>
&lt;h3 id="二内存泄漏排查工具-1">&lt;strong>二、内存泄漏排查工具&lt;/strong>
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>&lt;strong>Android Profiler（Android Studio）&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>内存监控&lt;/strong>：实时查看堆内存使用情况。&lt;/li>
&lt;li>&lt;strong>Heap Dump&lt;/strong>：捕获堆快照，分析对象引用链。&lt;/li>
&lt;li>&lt;strong>Allocation Tracker&lt;/strong>：跟踪短时间内的内存分配。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>LeakCanary（自动化检测）&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>集成步骤：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-groovy" data-lang="groovy">&lt;span style="display:flex;">&lt;span>debugImplementation &lt;span style="color:#e6db74">&amp;#39;com.squareup.leakcanary:leakcanary-android:2.9.1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>自动检测泄漏并生成报告，定位泄漏引用链。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>MAT（Memory Analyzer Tool）&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>分析Heap Dump步骤：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>用Android Profiler导出&lt;code>.hprof&lt;/code>文件。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>通过&lt;code>hprof-conv&lt;/code>转换格式（Android SDK工具）：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>hprof-conv input.hprof output.hprof
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>在MAT中打开，通过&lt;strong>Dominator Tree&lt;/strong>和&lt;strong>Path to GC Roots&lt;/strong>分析泄漏对象。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>StrictMode&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>检测主线程磁盘/网络操作，间接避免内存问题：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>StrictMode.&lt;span style="color:#a6e22e">setVmPolicy&lt;/span>(&lt;span style="color:#66d9ef">new&lt;/span> VmPolicy.&lt;span style="color:#a6e22e">Builder&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .&lt;span style="color:#a6e22e">detectActivityLeaks&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .&lt;span style="color:#a6e22e">detectLeakedClosableObjects&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .&lt;span style="color:#a6e22e">penaltyLog&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .&lt;span style="color:#a6e22e">build&lt;/span>());
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol></description></item><item><title>View性能优化</title><link>https://www.dust-zed.site/android-develop/view%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</link><pubDate>Fri, 13 Jun 2025 23:55:35 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/view%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</guid><description>&lt;h3 id="android-view-性能优化体系">Android View 性能优化体系
&lt;/h3>&lt;hr>
&lt;h3 id="一规避过度绘制gpu优化">一、规避过度绘制（GPU优化）
&lt;/h3>&lt;p>专注于减少GPU的无效像素填充负载&lt;/p>
&lt;ul>
&lt;li>&lt;strong>概念解析：&lt;/strong>&lt;br>
GPU在单个像素点重复绘制超过2.5次（1x绘制+1.5x半透明混合）的现象，消耗填充率导致帧率下降&lt;/li>
&lt;li>&lt;strong>检测工具：&lt;/strong>&lt;br>
&lt;code>开发者选项-&amp;gt;调试GPU过度绘制&lt;/code>（蓝色&amp;lt;1x, 绿色&amp;lt;2x, 粉色&amp;lt;3x, 红色≥4x）&lt;/li>
&lt;li>&lt;strong>核心策略：&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>移除无效背景层：&lt;/strong>
&lt;ul>
&lt;li>检查并移除Activity根布局或主题中冗余的&lt;code>windowBackground&lt;/code>&lt;/li>
&lt;li>删除被完全覆盖的中间层布局（如FrameLayout）背景&lt;/li>
&lt;li>避免在自定义View的&lt;code>onDraw()&lt;/code>中绘制被覆盖区域&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>层级扁平化：&lt;/strong>
&lt;ul>
&lt;li>使用&lt;code>ConstraintLayout&lt;/code>替代多层嵌套布局&lt;/li>
&lt;li>减少RelativeLayout导致的二次测量&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>透明效果控制：&lt;/strong>
&lt;ul>
&lt;li>避免大面积半透明视图（引发GPU混合计算）&lt;/li>
&lt;li>硬件层动画结束时立即禁用（&lt;code>setLayerType(LAYER_TYPE_NONE)&lt;/code>）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>引用关键通用技术：&lt;/strong>&lt;br>
结合&lt;code>clipRect/quickReject&lt;/code>限定绘制区域（详见通用技术章节）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="二绘制指令优化cpu优化">二、绘制指令优化（CPU优化）
&lt;/h3>&lt;p>降低CPU生成绘制指令的开销&lt;/p>
&lt;ul>
&lt;li>&lt;strong>优化焦点：&lt;/strong>&lt;br>
&lt;code>onDraw()&lt;/code>方法的执行效率与资源管理&lt;/li>
&lt;li>&lt;strong>核心准则：&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>禁止内存分配：&lt;/strong>&lt;br>
绝不在&lt;code>onDraw()&lt;/code>中创建Paint/Path/Bitmap对象（应在构造方法初始化）&lt;/li>
&lt;li>&lt;strong>规避耗时操作：&lt;/strong>&lt;br>
避免复杂计算、IO或解析逻辑&lt;/li>
&lt;li>&lt;strong>阻断递归触发：&lt;/strong>&lt;br>
禁止在&lt;code>onDraw()&lt;/code>中调用&lt;code>invalidate()&lt;/code>或&lt;code>requestLayout()&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>高级技巧：&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>绘图资源复用：&lt;/strong>&lt;br>
对矢量图(VectorDrawable)和位图采用不同优化策略
&lt;ul>
&lt;li>小图标优先使用矢量图&lt;/li>
&lt;li>位图加载启用&lt;code>inSampleSize&lt;/code>采样和&lt;code>RGB_565&lt;/code>解码&lt;/li>
&lt;li>使用&lt;code>ImageView.setImageDrawable()&lt;/code>替代&lt;code>canvas.drawBitmap()&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>透明效果实现：&lt;/strong>&lt;br>
优先使用&lt;code>View.setAlpha()&lt;/code>而非半透明背景色&lt;/li>
&lt;li>&lt;strong>引用关键通用技术：&lt;/strong>&lt;br>
精准控制硬件加速生命周期（详见通用技术章节）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="三通用核心技术">三、通用核心技术
&lt;/h3>&lt;p>跨优化领域的共性技术方案&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>区域裁剪技术：&lt;/strong>&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-mermaid" data-lang="mermaid">graph TB
A[canvas.clipRect] --&amp;gt; B[限定子View绘制区域]
C[canvas.quickReject] --&amp;gt; D[跳过屏幕外区域绘制]
A--&amp;gt;|ViewGroup| E[重写dispatchDraw控制]
C--&amp;gt;|自定义View| F[onDraw中预判可见性]
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>在&lt;code>ViewGroup.drawChild&lt;/code>中限定子View绘制边界&lt;/li>
&lt;li>列表项等非重叠视图必备优化手段&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>硬件加速深度指南：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>运作机制：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>将View缓存为GPU纹理(Texture)&lt;/li>
&lt;li>通过&lt;code>setLayerType(LAYER_TYPE_HARDWARE, null)&lt;/code>启用&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>最佳实践：&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 动画开始前启用&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>view.&lt;span style="color:#a6e22e">setLayerType&lt;/span>(LAYER_TYPE_HARDWARE, &lt;span style="color:#66d9ef">null&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ObjectAnimator.&lt;span style="color:#a6e22e">run&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 动画结束后立即释放&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>animator.&lt;span style="color:#a6e22e">addListener&lt;/span>(() &lt;span style="color:#f92672">-&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> view.&lt;span style="color:#a6e22e">setLayerType&lt;/span>(LAYER_TYPE_NONE, &lt;span style="color:#66d9ef">null&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>});
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>开销预警：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>离屏缓冲增加20%-30%内存占用&lt;/li>
&lt;li>静态视图启用反而降低性能&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>圆角处理方案：&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>实现方式&lt;/th>
&lt;th>适用场景&lt;/th>
&lt;th>性能影响&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>ViewOutlineProvider&lt;/td>
&lt;td>小面积圆角&lt;/td>
&lt;td>★★☆&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>.9.png贴图&lt;/td>
&lt;td>固定尺寸元素&lt;/td>
&lt;td>★☆☆&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>绘制圆角矩形&lt;/td>
&lt;td>动态尺寸视图&lt;/td>
&lt;td>★★☆&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>clipToOutline&lt;/td>
&lt;td>避免大面积使用&lt;/td>
&lt;td>★★★&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="四布局优化独立模块">四、布局优化（独立模块）
&lt;/h3>&lt;p>优化测量(measure)与布局(layout)阶段性能&lt;/p>
&lt;ul>
&lt;li>&lt;strong>检测工具：&lt;/strong>&lt;br>
&lt;code>Profile GPU Rendering&lt;/code>分析各阶段耗时&lt;/li>
&lt;li>&lt;strong>优化策略：&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>层级压缩：&lt;/strong>
&lt;ul>
&lt;li>使用ConstraintLayout减少嵌套&lt;/li>
&lt;li>避免LinearLayout权重导致的二次测量&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>动态加载：&lt;/strong>
&lt;ul>
&lt;li>&lt;code>&amp;lt;merge&amp;gt;&lt;/code>消除冗余容器层&lt;/li>
&lt;li>&lt;code>ViewStub&lt;/code>延迟加载隐藏视图&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>自定义布局优化：&lt;/strong>
&lt;ul>
&lt;li>缓存&lt;code>onMeasure()&lt;/code>计算结果&lt;/li>
&lt;li>只测量可见子View&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="优化关联图谱">优化关联图谱
&lt;/h3>&lt;pre tabindex="0">&lt;code class="language-mermaid" data-lang="mermaid">flowchart TD
A[性能优化] --&amp;gt; B[GPU负载]
A --&amp;gt; C[CPU负载]
B --&amp;gt; D[过度绘制优化]
C --&amp;gt; E[布局计算优化]
C --&amp;gt; F[绘制指令优化]
D &amp;amp; F --&amp;gt; G[通用技术]
G --&amp;gt; H[区域裁剪]
G --&amp;gt; I[硬件加速]
G --&amp;gt; J[圆角处理]
&lt;/code>&lt;/pre>&lt;p>该重组方案：&lt;/p>
&lt;ol>
&lt;li>完整保留原文所有技术点&lt;/li>
&lt;li>消除硬件加速/clipRect等技术点的重复描述&lt;/li>
&lt;li>建立清晰的「GPU优化-CPU优化-通用技术」逻辑链路&lt;/li>
&lt;li>通过流程图和表格提升关键技术的可操作性&lt;/li>
&lt;li>维持与原文档相同的技术细节颗粒度&lt;/li>
&lt;/ol>
&lt;p>最终形成的体系逻辑：&lt;br>
&lt;strong>GPU优化&lt;/strong>解决&amp;quot;绘制次数&amp;quot;问题 → &lt;strong>CPU优化&lt;/strong>解决&amp;quot;绘制效率&amp;quot;问题 → &lt;strong>通用技术&lt;/strong>提供跨领域解决方案 → &lt;strong>布局优化&lt;/strong>作为独立并行模块&lt;/p>
&lt;ul>
&lt;li>&lt;code>canvas.save()&lt;/code>: 将当前&lt;strong>绘制状态&lt;/strong>（矩阵变换/裁剪区域/图层属性）存入栈中&lt;/li>
&lt;li>&lt;code>canvas.restore()&lt;/code>: 从栈顶取出最近保存的状态并恢复&lt;/li>
&lt;li>&lt;code>canvas.quickReject()&lt;/code>:快速判断指定矩形区域是否&lt;strong>完全位于当前裁剪区域外&lt;/strong>&lt;/li>
&lt;/ul></description></item><item><title>关于硬件加速</title><link>https://www.dust-zed.site/android-develop/%E5%85%B3%E4%BA%8E%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F/</link><pubDate>Fri, 13 Jun 2025 22:50:57 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/%E5%85%B3%E4%BA%8E%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F/</guid><description>&lt;h4 id="一硬件加速核心概念">一、硬件加速核心概念
&lt;/h4>&lt;p>硬件加速是将图形渲染中的光栅化从CPU转移到GPU执行的技术。CPU只需要生成&lt;strong>绘制指令集(DisplayList)&lt;/strong>，由GPU进行高效的并行光栅化计算，最终写入图形缓冲区提供屏幕显示。&lt;/p>
&lt;p>本质：CPU负责逻辑指令，GPU负责繁重像素计算，分工协作提升效率&lt;/p>
&lt;p>光栅化：可以高度抽象的概括为&lt;strong>计算屏幕上每个像素点最终显示的ARGB值&lt;/strong>&lt;/p>
&lt;h4 id="二硬件加速启用前后的核心流程对比">二、硬件加速启用前后的核心流程对比
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>未启用硬件加速&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>measure &amp;amp; layout&lt;/strong>：由CPU在主线程（UI线程）执行&lt;/li>
&lt;li>&lt;strong>Draw&lt;/strong>（关键区别）：
&lt;ul>
&lt;li>CPU：遍历View树，在主线程直接执行每个View的onDraw(Canvas)方法&lt;/li>
&lt;li>光栅化：onDraw中的绘制指令也由CPU执行，直接计算出最终的像素值。&lt;/li>
&lt;li>缓冲区(Frame Buffer)
&lt;ul>
&lt;li>系统维护一个帧缓冲区。&lt;/li>
&lt;li>CPU光栅化好的像素数据直接写入这个帧缓冲区&lt;/li>
&lt;li>核心：CPU既处理逻辑计算又处理生成最终像素的繁重计算(光栅化)，然后把结果放进帧缓冲&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>合成 &amp;amp; 显示&lt;/strong>：屏幕读取帧缓冲区的内容显示到屏幕上。这个过程通常涉及双缓冲和Vsync信号来避免撕裂，但其绘制核心是CPU
&lt;ul>
&lt;li>Front Buffer是屏幕当前帧显示的内容，Back Buffer是屏幕下一帧要显示的内容&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>开启硬件加速&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>Measure &amp;amp; Layout&lt;/strong>：仍然由CPU在主线程执行。&lt;/li>
&lt;li>&lt;strong>Draw&lt;/strong>(关键区别)：
&lt;ul>
&lt;li>CPU：遍历View树，在主线程执行每个View的**&lt;code>onDraw(Canvas)&lt;/code>**方法。但是这里的&lt;code>Canvas&lt;/code>行为不同了&lt;/li>
&lt;li>Display List：onDraw(Canvas)中的绘制指令不再立即光栅化，而是被记录到DisplayList的数据结构中。DisplayList本质是一系列GPU能理解的绘图操作指令的序列化表示&lt;/li>
&lt;li>光栅化：由GPU执行，CPU将构建好的&lt;code>DisplayList&lt;/code>提交给GPU。GPU驱动程序将这些高级绘图指令&lt;strong>并行地、高效地光栅化&lt;/strong>。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>缓冲区&lt;/strong>(Frame Buffer / GRALLOC Buffers):
&lt;ul>
&lt;li>&lt;strong>普通开启硬件加速时的缓冲区：&lt;/strong> GPU 将光栅化&lt;strong>好的像素数据写入系统分配的图形缓冲区&lt;/strong> (通常是通过 &lt;code>Gralloc&lt;/code> 分配管理的 Buffer Queue 中的缓冲区，如 &lt;code>SurfaceTexture&lt;/code>)。这些缓冲区&lt;strong>就是屏幕最终合成时使用的像素数据源&lt;/strong>&lt;/li>
&lt;li>核心：CPU负责记录绘制命令(onDraw -&amp;gt; DisplayList)；GPU负责光栅化，结果写入图形缓冲区&lt;/li>
&lt;li>Frame Buffer是抽象的缓冲区，而GRALLOC Buffers是物理缓冲区&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h4 id="三启用硬件层">三、启用硬件层
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>目的&lt;/strong>：对像素不会频繁变化的View采用空间换时间的方案，避免View内容未变时重复光栅化，用于后续快速合成&lt;/li>
&lt;li>&lt;strong>作用&lt;/strong>：仅当视图内容改变(&lt;code>invalidate()&lt;/code>)时或主动更新时：GPU重新光栅化该View的DisplayList -&amp;gt; 更新离屏纹理。而只涉及纹理的变换时，不会重新光栅化DisplayList，而是直接使用纹理缓存进行合成，纹理变换正是GPU擅长的。纹理变换和opengl管线工作流程中的顶点变换是不同的层级概念&lt;/li>
&lt;li>&lt;strong>最佳实践&lt;/strong>
&lt;ol>
&lt;li>适合&lt;strong>小面积静态视图&lt;/strong>或&lt;strong>属性动画&lt;/strong>&lt;/li>
&lt;li>避免对大视图（如列表视图）启用，易耗尽显存&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol></description></item><item><title>面试问题收集</title><link>https://www.dust-zed.site/android-develop/%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E6%94%B6%E9%9B%86/</link><pubDate>Fri, 13 Jun 2025 09:30:56 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E6%94%B6%E9%9B%86/</guid><description>&lt;h4 id="一bitmap内存优化">一、Bitmap内存优化
&lt;/h4>&lt;p>Bitmap是内存消耗大户，通过以下方法减少占用：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>降低色彩解析模式&lt;/strong>&lt;br>
使用RGB565等低色彩模式，将单个像素的字节大小从32位（ARGB8888）减少到16位，显著节省内存。&lt;/li>
&lt;li>&lt;strong>合理放置资源文件&lt;/strong>&lt;br>
高分辨率图片应放置在高密度目录（如&lt;code>drawable-xxhdpi&lt;/code>），避免系统自动缩放导致内存浪费。&lt;/li>
&lt;li>&lt;strong>缩小图片尺寸&lt;/strong>&lt;br>
加载时通过&lt;code>BitmapFactory.Options&lt;/code>动态调整采样率（&lt;code>inSampleSize&lt;/code>），或使用&lt;code>createScaledBitmap()&lt;/code>减少宽高尺寸。&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="二viewmodel与livedata机制">二、ViewModel与LiveData机制
&lt;/h4>&lt;p>ViewModel和LiveData是Jetpack组件，用于数据生命周期管理和响应式UI更新。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>粘性事件（Sticky Event）&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>定义&lt;/strong>：当新观察者订阅&lt;code>LiveData&lt;/code>时，若已有存储值，会立即收到最后一次更新（旧数据）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>示例&lt;/strong>：屏幕旋转后，新Activity观察LiveData时触发UI更新（旧数据）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>来源&lt;/strong>：基于LiveData的版本号对比机制。代码关键部分如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">abstract&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">LiveData&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>T&lt;span style="color:#f92672">&amp;gt;&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> mVersion &lt;span style="color:#f92672">=&lt;/span> START_VERSION; &lt;span style="color:#75715e">// LiveData当前版本（初始-1）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">LifecycleBoundObserver&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> ObserverWrapper {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> mLastVersion &lt;span style="color:#f92672">=&lt;/span> START_VERSION;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">considerNotify&lt;/span>(ObserverWrapper observer) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (observer.&lt;span style="color:#a6e22e">mLastVersion&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> mVersion) { &lt;span style="color:#75715e">// 核心判断：版本号落后才分发&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> observer.&lt;span style="color:#a6e22e">mLastVersion&lt;/span> &lt;span style="color:#f92672">=&lt;/span> mVersion;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> observer.&lt;span style="color:#a6e22e">mObserver&lt;/span>.&lt;span style="color:#a6e22e">onChanged&lt;/span>((T)data);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>简单解法&lt;/strong>：使用&lt;code>Event&lt;/code>包装数据。事件消费后置空值，避免旧数据触发更新。&lt;/p>
&lt;ul>
&lt;li>但是这个不支持多观察者&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>使用&lt;code>SharedFlow&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ViewModel临时数据保存机制&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>内存中保存&lt;/strong>&lt;br>
ViewModel对象存储在&lt;code>ViewModelStore&lt;/code>中。当配置变更（如屏幕旋转）时：
&lt;ul>
&lt;li>Activity/Fragment被销毁重建。&lt;/li>
&lt;li>&lt;code>ViewModelStore&lt;/code>被系统保留（绑定到&lt;code>NonConfigurationInstances&lt;/code>）。&lt;/li>
&lt;li>新建Activity/Fragment时自动恢复ViewModel实例。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>数据范围与最佳实践&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>保留场景&lt;/strong>：屏幕旋转、分屏切换、系统语言更改。&lt;/li>
&lt;li>&lt;strong>不保留场景&lt;/strong>：用户退出应用、系统资源不足杀死进程、Activity被finish()。&lt;/li>
&lt;li>&lt;strong>最佳实践&lt;/strong>：
&lt;ol>
&lt;li>ViewModel解决配置变更的&lt;strong>临时数据保存&lt;/strong>（内存级）。&lt;/li>
&lt;li>在ViewModel使用&lt;code>SavedStateHandle&lt;/code>解决进程被杀死时的&lt;strong>关键数据持久化&lt;/strong>。&lt;/li>
&lt;li>复杂数据应使用数据库等持久化方案。&lt;/li>
&lt;li>避免内存泄漏：勿在ViewModel持有Context/View引用，必要时用&lt;code>Application Context&lt;/code>代替。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="三view基础原理">三、View基础原理
&lt;/h4>&lt;p>深入理解View的测量、布局、绘制机制，是优化UI性能的核心。&lt;/p>
&lt;ol>
&lt;li>&lt;strong>MeasureSpec计算与布局优化&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>MeasureSpec原理&lt;/strong>：父容器传递给子View的测量要求，由大小和模式组成，取决于父容器的MeasureSpec和子View的LayoutParams。
&lt;ul>
&lt;li>父布局根据自身MeasureSpec和子View LayoutParams，确定子View的MeasureSpec，再调用&lt;code>children.measure()&lt;/code>，最终确定自身尺寸。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>布局性能优化&lt;/strong>：
&lt;ul>
&lt;li>缓存MeasureSpec计算结果：固定尺寸View（如按钮）直接调用&lt;code>setMeasuredDimension()&lt;/code>设置宽高。&lt;/li>
&lt;li>优化布局流程：减少嵌套层级、懒加载布局、合并重复布局。&lt;/li>
&lt;li>避免无效重绘：使用局部刷新机制。&lt;/li>
&lt;li>精确控制绘制范围：通过&lt;code>Canvas.clipRect()&lt;/code>限制绘制区域。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>getMeasuredWidth()与getWidth()区别&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>getMeasuredWidth()&lt;/strong>：测量阶段后分配的宽度（含内边距）。
&lt;ul>
&lt;li>使用时机：&lt;code>onMeasure()&lt;/code>后或&lt;code>layout()&lt;/code>前。&lt;/li>
&lt;li>特点：反映视图的期望宽度；若布局未强制改变尺寸，可能与&lt;code>getWidth&lt;/code>相同。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>getWidth()&lt;/strong>：布局阶段后的最终可见宽度（屏幕实际值）。
&lt;ul>
&lt;li>使用时机：&lt;code>onLayout&lt;/code>后。&lt;/li>
&lt;li>计算方式：&lt;code>width = right - left&lt;/code>。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>requestLayout()与invalidate()区别&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>requestLayout()&lt;/strong>：请求整个视图树的测量（measure）和布局（layout）流程。
&lt;ul>
&lt;li>触发场景：视图尺寸/位置变化、动态添加/移除子视图、&lt;code>setVisibility()&lt;/code>导致布局结构变化。&lt;/li>
&lt;li>执行流程：从当前视图向上回溯到根视图（如ViewRootImpl），依次执行measure → layout。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>invalidate()&lt;/strong>：仅标记视图的局部区域为“脏区”，请求下一帧重绘该区域。
&lt;ul>
&lt;li>触发场景：视图内容变化但不影响尺寸/位置（如&lt;code>onDraw()&lt;/code>依赖数据更新）。&lt;/li>
&lt;li>执行流程：标记脏区 → 加入重绘队列 → 下一帧VSync信号时调用&lt;code>onDraw()&lt;/code>。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>View坐标体系&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>getX()/getY()&lt;/strong>：相对当前View左上角的局部坐标（触摸点在View内的位置）。
&lt;ul>
&lt;li>特点：与父容器无关；值可为负（如滑动超出View边界）。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>getRawX()/getRawY()&lt;/strong>：相对屏幕左上角的全局坐标。
&lt;ul>
&lt;li>特点：包含状态栏高度（&lt;code>getRawY()&lt;/code>从屏幕顶部算起）。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>getLocationOnScreen()&lt;/strong>：获取View左上角在屏幕上的绝对坐标。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>View生命周期关键方法&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>构造函数&lt;/strong>：通过代码或XML创建View实例。&lt;/li>
&lt;li>&lt;strong>onAttachedToWindow()&lt;/strong>：View被添加到窗口时调用。
&lt;ul>
&lt;li>用途：初始化资源、注册监听器、启动动画。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>onDetachedFromWindow()&lt;/strong>：View从窗口移除时调用（如Activity销毁）。
&lt;ul>
&lt;li>关键作用：释放资源、停止动画、注销监听器。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>注意事项&lt;/strong>：
&lt;ul>
&lt;li>&lt;code>onVisibilityChanged()&lt;/code>可能在&lt;code>onAttachedToWindow()&lt;/code>前/后调用（如View初始化为&lt;code>GONE&lt;/code>）。&lt;/li>
&lt;li>&lt;code>onWindowFocusChanged()&lt;/code>可能在&lt;code>onDetachedFromWindow()&lt;/code>后调用（避免在此访问资源）。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>View性能优化&lt;/strong>
&lt;ol>
&lt;li>&lt;strong>过度绘制：&lt;/strong>
&lt;ul>
&lt;li>概念：GPU在一个像素点上绘制了多次的现象。系统默认允许2.5次（1x绘制 + 1.5x半透明混合）&lt;/li>
&lt;li>主要优化策略
&lt;ul>
&lt;li>移除不必要的背景&lt;/li>
&lt;li>减少View的层级深度&lt;/li>
&lt;li>谨慎使用半透明或**&lt;code>setLayerType(LAYER_TYPE_HARDWARE)&lt;/code>**&lt;/li>
&lt;li>优化&lt;code>clipRect&lt;/code>和&lt;code>quickReject&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>布局优化：&lt;/strong>
&lt;ul>
&lt;li>概念：指测量和布局阶段的性能优化。CPU需要遍历View树计算每个View的大小和位置&lt;/li>
&lt;li>优化策略：
&lt;ul>
&lt;li>减少嵌套层级&lt;/li>
&lt;li>使用高效布局标签（merge、include、ViewStub）&lt;/li>
&lt;li>优化&lt;code>onMeasure&lt;/code>/&lt;code>onLayout&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>绘制优化：&lt;/strong>
&lt;ul>
&lt;li>概念：指实际调用View.onDraw方法渲染像素到屏幕的性能优化。CPU准备绘制指令 -&amp;gt;GPU执行绘制&lt;/li>
&lt;li>优化策略
&lt;ul>
&lt;li>优化onDraw()方法：避免内存分配(不在onDraw方法内实例化Paint、Path、Bitmap、Rect对象)，避免耗时操作、避免调用invalidate（避免递归/绘制请求），利用canvas.clipRect和canvas.quickReject(),优先使用矢量图代替位图，使用硬件加速支持的Canvas操作&lt;/li>
&lt;li>谨慎开启Hardware_Layer&lt;/li>
&lt;li>优化alpha通道和透明度&lt;/li>
&lt;li>优化Bitmap加载与显示&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;strong>高级机制与原理&lt;/strong>
&lt;ol>
&lt;li>硬件加速：将绘制指令交给GPU，但是部分api不支持&lt;/li>
&lt;li>SurfaceView与TextureView：todo&lt;/li>
&lt;li>view.post与Handler：todo&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="四事件分发机制">四、事件分发机制
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>滑动实现方式&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>&lt;code>scrollTo()&lt;/code>/&lt;code>scrollBy()&lt;/code>&lt;/strong>: scrollTo()是直接跳转到指定位置，scrollBy是相对移动，基于当前位置滑动指定偏移量&lt;/li>
&lt;li>通过&lt;code>ViewDragHelper&lt;/code>实现复杂拖拽: todo&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>自定义下拉刷新控件&lt;/strong>
&lt;ul>
&lt;li>todo&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>事件分发机制如何提升效率&lt;/strong>
&lt;ul>
&lt;li>todo&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>嵌套滑动处理&lt;/strong>
&lt;ul>
&lt;li>todo&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>RecyclerView的滑动冲突处理&lt;/strong>
&lt;ul>
&lt;li>todo&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="五handler">五、Handler
&lt;/h4>&lt;ol>
&lt;li>&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="六性能优化-todo">六、性能优化 （todo）
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>内存管理与泄漏排查&lt;/strong>&lt;/li>
&lt;li>&lt;strong>UI渲染性能(卡顿优化)&lt;/strong>&lt;/li>
&lt;li>&lt;strong>启动速度优化&lt;/strong>&lt;/li>
&lt;li>&lt;strong>功耗优化基础&lt;/strong>&lt;/li>
&lt;li>&lt;strong>包体积优化&lt;/strong>&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="七常用库与框架todo">七、常用库与框架（todo）
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>网络请求(如Retrofit)&lt;/strong>&lt;/li>
&lt;li>&lt;strong>图片加载(如Glide / Picasso)&lt;/strong>&lt;/li>
&lt;li>&lt;strong>Gradle基础&lt;/strong>&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="八网络与后台">八、网络与后台
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>RESTful API概念与使用&lt;/strong>&lt;/li>
&lt;li>&lt;strong>异步处理深入（线程安全、后台限制）&lt;/strong>&lt;/li>
&lt;li>&lt;strong>缓存策略&lt;/strong>&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="九架构设计">九、架构设计
&lt;/h4>&lt;ol>
&lt;li>MVVM/MVI理解与实践&lt;/li>
&lt;li>模块化 / 组件化&lt;/li>
&lt;li>设计模式应用&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="十新技术与趋势">十、新技术与趋势
&lt;/h4>&lt;ol>
&lt;li>Compose&lt;/li>
&lt;li>KMM / Flutter&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h4 id="十一jvm--内存模型基础">十一、JVM / 内存模型基础
&lt;/h4>&lt;ol>
&lt;li>JVM内存结构&lt;/li>
&lt;li>垃圾回收机制基础&lt;/li>
&lt;li>常见数据结构与基础算法&lt;/li>
&lt;/ol></description></item><item><title>RecyclerView缓存机制</title><link>https://www.dust-zed.site/android-develop/recyclerview%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/</link><pubDate>Wed, 11 Jun 2025 15:26:57 +0800</pubDate><guid>https://www.dust-zed.site/android-develop/recyclerview%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/</guid><description>&lt;p>RecyclerView缓存机制&lt;/p>
&lt;h4 id="多级缓存体系架构图">&lt;strong>多级缓存体系架构图&lt;/strong>
&lt;/h4>&lt;pre tabindex="0">&lt;code>TEXT
RecyclerView 缓存系统
├── 1. 屏幕内缓存 (Attached Scrap)
│ └── 存放当前可见的ViewHolder（快速复用）
├── 2. 屏幕外缓存 (Cache)
│ └── 保存最近离开屏幕的ViewHolder（默认容量=2）
├── 3. 扩展缓存 (ViewCacheExtension)
│ └── 开发者自定义缓存（特殊用途）
└── 4. 回收池 (RecycledViewPool)
└── 全局共享的ViewHolder存储（不同类型独立缓存）
&lt;/code>&lt;/pre>&lt;p>根据&lt;code>position&lt;/code>判断是否命中&lt;code>Cache&lt;/code>，根据&lt;code>viewType&lt;/code>判断是否命中&lt;code>RecyclerViewPool&lt;/code>，会执行&lt;code>onBindViewHolder&lt;/code>&lt;/p>
&lt;p>在 &lt;strong>RecyclerView&lt;/strong> 的回收复用机制中，&lt;code>changedScrap&lt;/code> 和 &lt;code>attachedScrap&lt;/code> 是两个关键临时缓存，而 &lt;strong>Stable IDs&lt;/strong> 会改变 ViewHolder 获取的方式。以下是详细解释：&lt;/p>
&lt;hr>
&lt;h3 id="1">&lt;strong>1. &lt;code>changedScrap&lt;/code> 的作用&lt;/strong>
&lt;/h3>&lt;ul>
&lt;li>&lt;strong>用途&lt;/strong>：专门配合 &lt;code>notifyItemChanged()&lt;/code> 或 &lt;code>notifyDataSetChanged()&lt;/code> 使用。&lt;/li>
&lt;li>&lt;strong>工作机制&lt;/strong>：
&lt;ul>
&lt;li>当调用 &lt;code>notifyItemChanged(position)&lt;/code> 时，被标记更新的 item 会被临时移到 &lt;code>changedScrap&lt;/code> 中。&lt;/li>
&lt;li>在布局阶段（如 &lt;code>onLayout&lt;/code>），这些 ViewHolder 会被重新绑定数据（调用 &lt;code>onBindViewHolder()&lt;/code>），然后放回原位置。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>目的&lt;/strong>：支持局部更新动画（如淡入淡出），避免直接回收导致视觉中断。&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="2">&lt;strong>2. &lt;code>attachedScrap&lt;/code> 的作用&lt;/strong>
&lt;/h3>&lt;ul>
&lt;li>&lt;strong>用途&lt;/strong>：用于 &lt;strong>快速复用可见或即将可见的 ViewHolder&lt;/strong>。&lt;/li>
&lt;li>&lt;strong>工作机制&lt;/strong>：
&lt;ul>
&lt;li>在布局过程中（如 &lt;code>LinearLayoutManager.fill()&lt;/code>），RecyclerView 会先将当前屏幕上的 ViewHolder &lt;strong>临时移除&lt;/strong> 到 &lt;code>attachedScrap&lt;/code>。&lt;/li>
&lt;li>遍历新布局时，直接从 &lt;code>attachedScrap&lt;/code> 中按 &lt;strong>position 匹配&lt;/strong> 取回 ViewHolder（无需创建或绑定）。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>目的&lt;/strong>：避免无效的创建/绑定，提升滚动性能（尤其在快速滑动时）。&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="3-stable-ids-如何改变-viewholder-获取方式">&lt;strong>3. Stable IDs 如何改变 ViewHolder 获取方式&lt;/strong>
&lt;/h3>&lt;p>当启用 &lt;strong>Stable IDs&lt;/strong>（通过 &lt;code>setHasStableIds(true)&lt;/code> + 重写 &lt;code>getItemId()&lt;/code>）时：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>传统方式（无 Stable IDs）&lt;/strong>：&lt;br>
RecyclerView 通过 &lt;strong>position&lt;/strong> 在 &lt;code>attachedScrap&lt;/code> 或 &lt;code>changedScrap&lt;/code> 中查找匹配的 ViewHolder。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 伪代码：按 position 匹配&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ViewHolder vh &lt;span style="color:#f92672">=&lt;/span> attachedScrap.&lt;span style="color:#a6e22e">findViewForPosition&lt;/span>(position);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>启用 Stable IDs 后&lt;/strong>：&lt;br>
RecyclerView 改为通过 &lt;strong>item ID&lt;/strong>（而非 position）在 &lt;code>scrap&lt;/code> 中查找 ViewHolder：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// 伪代码：按 stable ID 匹配&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ViewHolder vh &lt;span style="color:#f92672">=&lt;/span> changedScrap.&lt;span style="color:#a6e22e">findViewHolderByItemId&lt;/span>(id);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="优势">&lt;strong>优势&lt;/strong>
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>位置无关复用&lt;/strong>：
&lt;ul>
&lt;li>即使数据集变化导致 item 位置改变（如插入/删除），仍能通过唯一 ID 正确复用 ViewHolder。&lt;/li>
&lt;li>避免因 position 变化导致的 “复用错乱” 问题（如 A 位置复用到 B 数据）。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>动画兼容性&lt;/strong>：
&lt;ul>
&lt;li>支持更流畅的动画（如 &lt;code>DiffUtil&lt;/code>），因为 ID 是数据项的唯一标识，不受布局顺序影响。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>效率提升&lt;/strong>：
&lt;ul>
&lt;li>查找操作从 O(N) 优化到 O(1)（基于 &lt;code>LongSparseArray&lt;/code> 实现）。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h3 id="关键对比总结">&lt;strong>关键对比总结&lt;/strong>
&lt;/h3>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>特性&lt;/strong>&lt;/th>
&lt;th>&lt;code>changedScrap&lt;/code>&lt;/th>
&lt;th>&lt;code>attachedScrap&lt;/code>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>触发场景&lt;/strong>&lt;/td>
&lt;td>&lt;code>notifyItemChanged()&lt;/code> 调用时&lt;/td>
&lt;td>布局过程中临时移除可见 ViewHolder&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>数据状态&lt;/strong>&lt;/td>
&lt;td>需重新绑定（&lt;code>onBindViewHolder&lt;/code>）&lt;/td>
&lt;td>数据未变，直接复用&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>存储内容&lt;/strong>&lt;/td>
&lt;td>被标记更新的 ViewHolder&lt;/td>
&lt;td>当前/即将可见的 ViewHolder&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>查找方式（无 ID）&lt;/strong>&lt;/td>
&lt;td>按 &lt;code>position&lt;/code> 匹配&lt;/td>
&lt;td>按 &lt;code>position&lt;/code> 匹配&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>查找方式（有 ID）&lt;/strong>&lt;/td>
&lt;td>按 &lt;code>stableId&lt;/code> 匹配&lt;/td>
&lt;td>按 &lt;code>stableId&lt;/code> 匹配&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;blockquote>
&lt;p>&lt;strong>使用建议&lt;/strong>：&lt;br>
若数据集存在动态位置变化（如排序、增删），强烈建议启用 &lt;strong>Stable IDs&lt;/strong>，以提升复用准确性和动画效果。&lt;/p>&lt;/blockquote></description></item></channel></rss>
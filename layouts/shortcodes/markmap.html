{{/* layouts/shortcodes/markmap.html - 修正版本 */}}
{{- if not (.Page.Scratch.Get "markmap-loaded") -}}
  {{- .Page.Scratch.Set "markmap-loaded" true -}}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.3/dist/index.min.js"></script>
  
  <script>
    console.log('=== Markmap 调试信息 ===');
    setTimeout(function() {
      console.log('D3 加载状态:', typeof d3 !== 'undefined' ? '✅ 已加载' : '❌ 未加载');
      console.log('Markmap 加载状态:', typeof markmap !== 'undefined' ? '✅ 已加载' : '❌ 未加载');
    }, 1000);
  </script>
{{- end -}}

<div id="markmap-{{ .Ordinal }}" 
     style="width: {{ .Get "width" | default "100%" }}; height: {{ .Get "height" | default "400px" }}; border: 1px solid #ddd; background: #f9f9f9;">
  <div style="text-align: center; line-height: {{ .Get "height" | default "400px" }}; color: #666;">
    思维导图加载中...
  </div>
</div>

<script type="text/markdown" id="markmap-data-{{ .Ordinal }}">
{{- .Inner -}}
</script>

<script>
(function() {
  var ordinal = {{ .Ordinal }};
  var containerId = 'markmap-' + ordinal;
  var dataId = 'markmap-data-' + ordinal;
  
  console.log('=== 初始化 Markmap ' + ordinal + ' ===');
  
  function checkAndInit() {
    console.log('检查依赖:', {
      d3: typeof d3 !== 'undefined',
      markmap: typeof markmap !== 'undefined',
      container: !!document.getElementById(containerId),
      data: !!document.getElementById(dataId)
    });
    
    if (typeof d3 === 'undefined' || typeof markmap === 'undefined') {
      console.log('依赖未加载，1秒后重试...');
      setTimeout(checkAndInit, 1000);
      return;
    }
    
    var container = document.getElementById(containerId);
    var dataScript = document.getElementById(dataId);
    
    if (!container || !dataScript) {
      console.error('容器或数据元素未找到');
      return;
    }
    
    try {
      var markdown = dataScript.textContent.trim();
      console.log('Markdown 内容:', markdown);
      
      if (!markdown) {
        console.error('Markdown 内容为空');
        return;
      }
      
      // 清空加载提示
      container.innerHTML = '';
      
      var result = markmap.transform(markdown);
      var root = result.root;
      console.log('转换结果:', root);
      
      var mm = markmap.Markmap.create(container, {
        autoFit: true,
        zoom: true,
        pan: true,
        color: function(node) {
          var colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
          return colors[node.depth % colors.length];
        }
      });
      
      mm.setData(root);
      mm.fit();
      
      console.log('✅ Markmap ' + ordinal + ' 初始化成功');
      
    } catch (error) {
      console.error('Markmap 初始化错误:', error);
      container.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">思维导图加载失败: ' + error.message + '</div>';
    }
  }
  
  // 延迟初始化，确保 DOM 和脚本都加载完成
  setTimeout(checkAndInit, 1000);
  
})();
</script>